/*!

    Teledraw Canvas
    Version 0.12.0 (http://semver.org/)
    Copyright 2012 Cameron Lakenen

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

**/
(function(){var p=Math.abs,n=Math.sqrt,h=Math.floor,o=Math.round,e=Math.min,m=Math.max,j=Math.pow,c=function(q){return j(q,2)},g;TeledrawCanvas=function(q,r){return new TeledrawCanvas.api(q,r)};stackBlurCanvasRGBA=(function(){var q=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var t=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var s=function(D,ag){if(isNaN(ag)||ag<1){return}ag|=0;var X=0,V=0,u=D.width,w=D.height;var aq=D.getContext("2d");var al;try{try{al=aq.getImageData(X,V,u,w)}catch(ap){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");al=aq.getImageData(X,V,u,w)}catch(ap){alert("Cannot access local image");throw new Error("unable to access local image data: "+ap);return}}}catch(ap){alert("Cannot access image");throw new Error("unable to access image data: "+ap)}var C=al.data;var ae,ad,an,ak,L,O,H,A,B,U,aj,K,W,S,v,aa,af,M,J,G,N,P,Q,Z;var ao=ag+ag+1;var ab=u<<2;var I=u-1;var ai=w-1;var F=ag+1;var ah=F*(F+1)/2;var Y=new r();var T=Y;for(an=1;an<ao;an++){T=T.next=new r();if(an==F){var E=T}}T.next=Y;var am=null;var ac=null;H=O=0;var R=q[ag];var z=t[ag];for(ad=0;ad<w;ad++){aa=af=M=J=A=B=U=aj=0;K=F*(G=C[O]);W=F*(N=C[O+1]);S=F*(P=C[O+2]);v=F*(Q=C[O+3]);A+=ah*G;B+=ah*N;U+=ah*P;aj+=ah*Q;T=Y;for(an=0;an<F;an++){T.r=G;T.g=N;T.b=P;T.a=Q;T=T.next}for(an=1;an<F;an++){ak=O+((I<an?I:an)<<2);A+=(T.r=(G=C[ak]))*(Z=F-an);B+=(T.g=(N=C[ak+1]))*Z;U+=(T.b=(P=C[ak+2]))*Z;aj+=(T.a=(Q=C[ak+3]))*Z;aa+=G;af+=N;M+=P;J+=Q;T=T.next}am=Y;ac=E;for(ae=0;ae<u;ae++){C[O+3]=Q=(aj*R)>>z;if(Q!=0){Q=255/Q;C[O]=((A*R)>>z)*Q;C[O+1]=((B*R)>>z)*Q;C[O+2]=((U*R)>>z)*Q}else{C[O]=C[O+1]=C[O+2]=0}A-=K;B-=W;U-=S;aj-=v;K-=am.r;W-=am.g;S-=am.b;v-=am.a;ak=(H+((ak=ae+ag+1)<I?ak:I))<<2;aa+=(am.r=C[ak]);af+=(am.g=C[ak+1]);M+=(am.b=C[ak+2]);J+=(am.a=C[ak+3]);A+=aa;B+=af;U+=M;aj+=J;am=am.next;K+=(G=ac.r);W+=(N=ac.g);S+=(P=ac.b);v+=(Q=ac.a);aa-=G;af-=N;M-=P;J-=Q;ac=ac.next;O+=4}H+=u}for(ae=0;ae<u;ae++){af=M=J=aa=B=U=aj=A=0;O=ae<<2;K=F*(G=C[O]);W=F*(N=C[O+1]);S=F*(P=C[O+2]);v=F*(Q=C[O+3]);A+=ah*G;B+=ah*N;U+=ah*P;aj+=ah*Q;T=Y;for(an=0;an<F;an++){T.r=G;T.g=N;T.b=P;T.a=Q;T=T.next}L=u;for(an=1;an<=ag;an++){O=(L+ae)<<2;A+=(T.r=(G=C[O]))*(Z=F-an);B+=(T.g=(N=C[O+1]))*Z;U+=(T.b=(P=C[O+2]))*Z;aj+=(T.a=(Q=C[O+3]))*Z;aa+=G;af+=N;M+=P;J+=Q;T=T.next;if(an<ai){L+=u}}O=ae;am=Y;ac=E;for(ad=0;ad<w;ad++){ak=O<<2;C[ak+3]=Q=(aj*R)>>z;if(Q>0){Q=255/Q;C[ak]=((A*R)>>z)*Q;C[ak+1]=((B*R)>>z)*Q;C[ak+2]=((U*R)>>z)*Q}else{C[ak]=C[ak+1]=C[ak+2]=0}A-=K;B-=W;U-=S;aj-=v;K-=am.r;W-=am.g;S-=am.b;v-=am.a;ak=(ae+(((ak=ad+F)<ai?ak:ai)*u))<<2;A+=(aa+=(am.r=C[ak]));B+=(af+=(am.g=C[ak+1]));U+=(M+=(am.b=C[ak+2]));aj+=(J+=(am.a=C[ak+3]));am=am.next;K+=(G=ac.r);W+=(N=ac.g);S+=(P=ac.b);v+=(Q=ac.a);aa-=G;af-=N;M-=P;J-=Q;ac=ac.next;O+=u}}aq.putImageData(al,X,V)};function r(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}return s})();Events=(function(){var s=Array.prototype.slice;var r=/\s+/;var q={on:function(w,A,v){var u,y,x,t,z;if(!A){return this}w=w.split(r);u=this._callbacks||(this._callbacks={});while(y=w.shift()){z=u[y];x=z?z.tail:{};x.next=t={};x.context=v;x.callback=A;u[y]={tail:t,next:z?z.next:x}}return this},off:function(A,y,u){var t,B,v,x,w,z;if(!(B=this._callbacks)){return}if(!(A||y||u)){delete this._callbacks;return this}A=A?A.split(r):_.keys(B);while(t=A.shift()){v=B[t];delete B[t];if(!v||!(y||u)){continue}x=v.tail;while((v=v.next)!==x){w=v.callback;z=v.context;if((y&&w!==y)||(u&&z!==u)){this.on(t,w,z)}}}return this},trigger:function(w){var A,z,v,u,t,y,x;if(!(v=this._callbacks)){return this}y=v.all;w=w.split(r);x=s.call(arguments,1);while(A=w.shift()){if(z=v[A]){u=z.tail;while((z=z.next)!==u){z.callback.apply(z.context||this,x)}}if(z=y){u=z.tail;t=[A].concat(x);while((z=z.next)!==u){z.callback.apply(z.context||this,t)}}}return this}};q.bind=q.on;q.unbind=q.off;return q})();function d(s,u,t){if(u==="mouseenter"||u==="mouseleave"){var q=u==="mouseenter",v=q?"fromElement":"toElement";u=q?"mouseover":"mouseout";d(s,u,function(y){y=y||window.event;var x=y.target||y.srcElement,w=y.relatedTarget||y[v];if((s===x||b(s,x))&&!b(s,w)){return t.apply(this,arguments)}});return}if(s.addEventListener){s.addEventListener(u,t,false)}else{if(!t.$$guid){t.$$guid=d.guid++}if(!s.events){s.events={}}var r=s.events[u];if(!r){r=s.events[u]={};if(s["on"+u]){r[0]=s["on"+u]}}r[t.$$guid]=t;s["on"+u]=k}}d.guid=1;function l(q,s,r){if(q.removeEventListener){q.removeEventListener(s,r,false)}else{if(q.events&&q.events[s]){delete q.events[s][r.$$guid]}}}function k(t){var s=true;t=t||a(((this.ownerDocument||this.document||this).parentWindow||window).event);var q=this.events[t.type];for(var r in q){this.$$handleEvent=q[r];if(this.$$handleEvent(t)===false){s=false}}return s}function a(q){q.preventDefault=a.preventDefault;q.stopPropagation=a.stopPropagation;return q}a.preventDefault=function(){this.returnValue=false};a.stopPropagation=function(){this.cancelBubble=true};function b(q,r){return q.contains?q.contains(r):!!(q.compareDocumentPosition(r)&16)}(function(){var K=this;var z=K._;var S={};var R=Array.prototype,v=Object.prototype,F=Function.prototype;var C=R.slice,O=R.unshift,s=v.toString,x=v.hasOwnProperty;var aa=R.forEach,E=R.map,T=R.reduce,r=R.reduceRight,q=R.filter,P=R.every,D=R.some,B=R.indexOf,A=R.lastIndexOf,H=Array.isArray,u=Object.keys,U=F.bind;var ab=function(ac){return new I(ac)};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=ab}exports._=ab}else{K._=ab}ab.VERSION="1.3.3";var X=ab.each=ab.forEach=function(ah,ag,af){if(ah==null){return}if(aa&&ah.forEach===aa){ah.forEach(ag,af)}else{if(ah.length===+ah.length){for(var ae=0,ac=ah.length;ae<ac;ae++){if(ae in ah&&ag.call(af,ah[ae],ae,ah)===S){return}}}else{for(var ad in ah){if(ab.has(ah,ad)){if(ag.call(af,ah[ad],ad,ah)===S){return}}}}}};ab.map=ab.collect=function(af,ae,ad){var ac=[];if(af==null){return ac}if(E&&af.map===E){return af.map(ae,ad)}X(af,function(ai,ag,ah){ac[ac.length]=ae.call(ad,ai,ag,ah)});if(af.length===+af.length){ac.length=af.length}return ac};ab.reduce=ab.foldl=ab.inject=function(ag,af,ac,ae){var ad=arguments.length>2;if(ag==null){ag=[]}if(T&&ag.reduce===T){if(ae){af=ab.bind(af,ae)}return ad?ag.reduce(af,ac):ag.reduce(af)}X(ag,function(aj,ah,ai){if(!ad){ac=aj;ad=true}else{ac=af.call(ae,ac,aj,ah,ai)}});if(!ad){throw new TypeError("Reduce of empty array with no initial value")}return ac};ab.reduceRight=ab.foldr=function(ag,af,ac,ae){var ad=arguments.length>2;if(ag==null){ag=[]}if(r&&ag.reduceRight===r){if(ae){af=ab.bind(af,ae)}return ad?ag.reduceRight(af,ac):ag.reduceRight(af)}var ah=ab.toArray(ag).reverse();if(ae&&!ad){af=ab.bind(af,ae)}return ad?ab.reduce(ah,af,ac,ae):ab.reduce(ah,af)};ab.find=ab.detect=function(af,ae,ad){var ac;N(af,function(ai,ag,ah){if(ae.call(ad,ai,ag,ah)){ac=ai;return true}});return ac};ab.filter=ab.select=function(af,ae,ad){var ac=[];if(af==null){return ac}if(q&&af.filter===q){return af.filter(ae,ad)}X(af,function(ai,ag,ah){if(ae.call(ad,ai,ag,ah)){ac[ac.length]=ai}});return ac};ab.reject=function(af,ae,ad){var ac=[];if(af==null){return ac}X(af,function(ai,ag,ah){if(!ae.call(ad,ai,ag,ah)){ac[ac.length]=ai}});return ac};ab.every=ab.all=function(af,ae,ad){var ac=true;if(af==null){return ac}if(P&&af.every===P){return af.every(ae,ad)}X(af,function(ai,ag,ah){if(!(ac=ac&&ae.call(ad,ai,ag,ah))){return S}});return !!ac};var N=ab.some=ab.any=function(af,ae,ad){ae||(ae=ab.identity);var ac=false;if(af==null){return ac}if(D&&af.some===D){return af.some(ae,ad)}X(af,function(ai,ag,ah){if(ac||(ac=ae.call(ad,ai,ag,ah))){return S}});return !!ac};ab.include=ab.contains=function(ae,ad){var ac=false;if(ae==null){return ac}if(B&&ae.indexOf===B){return ae.indexOf(ad)!=-1}ac=N(ae,function(af){return af===ad});return ac};ab.invoke=function(ad,ae){var ac=C.call(arguments,2);return ab.map(ad,function(af){return(ab.isFunction(ae)?ae||af:af[ae]).apply(af,ac)})};ab.pluck=function(ad,ac){return ab.map(ad,function(ae){return ae[ac]})};ab.max=function(af,ae,ad){if(!ae&&ab.isArray(af)&&af[0]===+af[0]){return Math.max.apply(Math,af)}if(!ae&&ab.isEmpty(af)){return -Infinity}var ac={computed:-Infinity};X(af,function(aj,ag,ai){var ah=ae?ae.call(ad,aj,ag,ai):aj;ah>=ac.computed&&(ac={value:aj,computed:ah})});return ac.value};ab.min=function(af,ae,ad){if(!ae&&ab.isArray(af)&&af[0]===+af[0]){return Math.min.apply(Math,af)}if(!ae&&ab.isEmpty(af)){return Infinity}var ac={computed:Infinity};X(af,function(aj,ag,ai){var ah=ae?ae.call(ad,aj,ag,ai):aj;ah<ac.computed&&(ac={value:aj,computed:ah})});return ac.value};ab.shuffle=function(ae){var ac=[],ad;X(ae,function(ah,af,ag){ad=Math.floor(Math.random()*(af+1));ac[af]=ac[ad];ac[ad]=ah});return ac};ab.sortBy=function(ae,af,ac){var ad=ab.isFunction(af)?af:function(ag){return ag[af]};return ab.pluck(ab.map(ae,function(ai,ag,ah){return{value:ai,criteria:ad.call(ac,ai,ag,ah)}}).sort(function(aj,ai){var ah=aj.criteria,ag=ai.criteria;if(ah===void 0){return 1}if(ag===void 0){return -1}return ah<ag?-1:ah>ag?1:0}),"value")};ab.groupBy=function(ae,af){var ac={};var ad=ab.isFunction(af)?af:function(ag){return ag[af]};X(ae,function(ai,ag){var ah=ad(ai,ag);(ac[ah]||(ac[ah]=[])).push(ai)});return ac};ab.sortedIndex=function(ah,ag,ae){ae||(ae=ab.identity);var ac=0,af=ah.length;while(ac<af){var ad=(ac+af)>>1;ae(ah[ad])<ae(ag)?ac=ad+1:af=ad}return ac};ab.toArray=function(ac){if(!ac){return[]}if(ab.isArray(ac)){return C.call(ac)}if(ab.isArguments(ac)){return C.call(ac)}if(ac.toArray&&ab.isFunction(ac.toArray)){return ac.toArray()}return ab.values(ac)};ab.size=function(ac){return ab.isArray(ac)?ac.length:ab.keys(ac).length};ab.first=ab.head=ab.take=function(ae,ad,ac){return(ad!=null)&&!ac?C.call(ae,0,ad):ae[0]};ab.initial=function(ae,ad,ac){return C.call(ae,0,ae.length-((ad==null)||ac?1:ad))};ab.last=function(ae,ad,ac){if((ad!=null)&&!ac){return C.call(ae,Math.max(ae.length-ad,0))}else{return ae[ae.length-1]}};ab.rest=ab.tail=function(ae,ac,ad){return C.call(ae,(ac==null)||ad?1:ac)};ab.compact=function(ac){return ab.filter(ac,function(ad){return !!ad})};ab.flatten=function(ad,ac){return ab.reduce(ad,function(ae,af){if(ab.isArray(af)){return ae.concat(ac?af:ab.flatten(af))}ae[ae.length]=af;return ae},[])};ab.without=function(ac){return ab.difference(ac,C.call(arguments,1))};ab.uniq=ab.unique=function(ag,af,ae){var ac=ae?ab.map(ag,ae):ag;var ad=[];if(ag.length<3){af=true}ab.reduce(ac,function(ah,aj,ai){if(af?ab.last(ah)!==aj||!ah.length:!ab.include(ah,aj)){ah.push(aj);ad.push(ag[ai])}return ah},[]);return ad};ab.union=function(){return ab.uniq(ab.flatten(arguments,true))};ab.intersection=ab.intersect=function(ad){var ac=C.call(arguments,1);return ab.filter(ab.uniq(ad),function(ae){return ab.every(ac,function(af){return ab.indexOf(af,ae)>=0})})};ab.difference=function(ad){var ac=ab.flatten(C.call(arguments,1),true);return ab.filter(ad,function(ae){return !ab.include(ac,ae)})};ab.zip=function(){var ac=C.call(arguments);var af=ab.max(ab.pluck(ac,"length"));var ae=new Array(af);for(var ad=0;ad<af;ad++){ae[ad]=ab.pluck(ac,""+ad)}return ae};ab.indexOf=function(ag,ae,af){if(ag==null){return -1}var ad,ac;if(af){ad=ab.sortedIndex(ag,ae);return ag[ad]===ae?ad:-1}if(B&&ag.indexOf===B){return ag.indexOf(ae)}for(ad=0,ac=ag.length;ad<ac;ad++){if(ad in ag&&ag[ad]===ae){return ad}}return -1};ab.lastIndexOf=function(ae,ad){if(ae==null){return -1}if(A&&ae.lastIndexOf===A){return ae.lastIndexOf(ad)}var ac=ae.length;while(ac--){if(ac in ae&&ae[ac]===ad){return ac}}return -1};ab.range=function(ah,af,ag){if(arguments.length<=1){af=ah||0;ah=0}ag=arguments[2]||1;var ad=Math.max(Math.ceil((af-ah)/ag),0);var ac=0;var ae=new Array(ad);while(ac<ad){ae[ac++]=ah;ah+=ag}return ae};var V=function(){};ab.bind=function t(af,ad){var ae,ac;if(af.bind===U&&U){return U.apply(af,C.call(arguments,1))}if(!ab.isFunction(af)){throw new TypeError}ac=C.call(arguments,2);return ae=function(){if(!(this instanceof ae)){return af.apply(ad,ac.concat(C.call(arguments)))}V.prototype=af.prototype;var ah=new V;var ag=af.apply(ah,ac.concat(C.call(arguments)));if(Object(ag)===ag){return ag}return ah}};ab.bindAll=function(ad){var ac=C.call(arguments,1);if(ac.length==0){ac=ab.functions(ad)}X(ac,function(ae){ad[ae]=ab.bind(ad[ae],ad)});return ad};ab.memoize=function(ae,ad){var ac={};ad||(ad=ab.identity);return function(){var af=ad.apply(this,arguments);return ab.has(ac,af)?ac[af]:(ac[af]=ae.apply(this,arguments))}};ab.delay=function(ad,ae){var ac=C.call(arguments,2);return setTimeout(function(){return ad.apply(null,ac)},ae)};ab.defer=function(ac){return ab.delay.apply(ab,[ac,1].concat(C.call(arguments,1)))};ab.throttle=function(ae,af){var ad,ah,ai,aj,ag,ak;var ac=ab.debounce(function(){ag=aj=false},af);return function(){ad=this;ah=arguments;var al=function(){ai=null;if(ag){ae.apply(ad,ah)}ac()};if(!ai){ai=setTimeout(al,af)}if(aj){ag=true}else{ak=ae.apply(ad,ah)}ac();aj=true;return ak}};ab.debounce=function(ad,af,ac){var ae;return function(){var ai=this,ah=arguments;var ag=function(){ae=null;if(!ac){ad.apply(ai,ah)}};if(ac&&!ae){ad.apply(ai,ah)}clearTimeout(ae);ae=setTimeout(ag,af)}};ab.once=function(ae){var ac=false,ad;return function(){if(ac){return ad}ac=true;return ad=ae.apply(this,arguments)}};ab.wrap=function(ac,ad){return function(){var ae=[ac].concat(C.call(arguments,0));return ad.apply(this,ae)}};ab.compose=function(){var ac=arguments;return function(){var ad=arguments;for(var ae=ac.length-1;ae>=0;ae--){ad=[ac[ae].apply(this,ad)]}return ad[0]}};ab.after=function(ad,ac){if(ad<=0){return ac()}return function(){if(--ad<1){return ac.apply(this,arguments)}}};ab.keys=u||function(ae){if(ae!==Object(ae)){throw new TypeError("Invalid object")}var ad=[];for(var ac in ae){if(ab.has(ae,ac)){ad[ad.length]=ac}}return ad};ab.values=function(ac){return ab.map(ac,ab.identity)};ab.functions=ab.methods=function(ae){var ad=[];for(var ac in ae){if(ab.isFunction(ae[ac])){ad.push(ac)}}return ad.sort()};ab.extend=function(ac){X(C.call(arguments,1),function(ad){for(var ae in ad){ac[ae]=ad[ae]}});return ac};ab.pick=function(ad){var ac={};X(ab.flatten(C.call(arguments,1)),function(ae){if(ae in ad){ac[ae]=ad[ae]}});return ac};ab.defaults=function(ac){X(C.call(arguments,1),function(ad){for(var ae in ad){if(ac[ae]==null){ac[ae]=ad[ae]}}});return ac};ab.clone=function(ac){if(!ab.isObject(ac)){return ac}return ab.isArray(ac)?ac.slice():ab.extend({},ac)};ab.tap=function(ad,ac){ac(ad);return ad};function Y(af,ae,ad){if(af===ae){return af!==0||1/af==1/ae}if(af==null||ae==null){return af===ae}if(af._chain){af=af._wrapped}if(ae._chain){ae=ae._wrapped}if(af.isEqual&&ab.isFunction(af.isEqual)){return af.isEqual(ae)}if(ae.isEqual&&ab.isFunction(ae.isEqual)){return ae.isEqual(af)}var ai=s.call(af);if(ai!=s.call(ae)){return false}switch(ai){case"[object String]":return af==String(ae);case"[object Number]":return af!=+af?ae!=+ae:(af==0?1/af==1/ae:af==+ae);case"[object Date]":case"[object Boolean]":return +af==+ae;case"[object RegExp]":return af.source==ae.source&&af.global==ae.global&&af.multiline==ae.multiline&&af.ignoreCase==ae.ignoreCase}if(typeof af!="object"||typeof ae!="object"){return false}var aj=ad.length;while(aj--){if(ad[aj]==af){return true}}ad.push(af);var ah=0,ac=true;if(ai=="[object Array]"){ah=af.length;ac=ah==ae.length;if(ac){while(ah--){if(!(ac=ah in af==ah in ae&&Y(af[ah],ae[ah],ad))){break}}}}else{if("constructor" in af!="constructor" in ae||af.constructor!=ae.constructor){return false}for(var ag in af){if(ab.has(af,ag)){ah++;if(!(ac=ab.has(ae,ag)&&Y(af[ag],ae[ag],ad))){break}}}if(ac){for(ag in ae){if(ab.has(ae,ag)&&!(ah--)){break}}ac=!ah}}ad.pop();return ac}ab.isEqual=function(ad,ac){return Y(ad,ac,[])};ab.isEmpty=function(ad){if(ad==null){return true}if(ab.isArray(ad)||ab.isString(ad)){return ad.length===0}for(var ac in ad){if(ab.has(ad,ac)){return false}}return true};ab.isElement=function(ac){return !!(ac&&ac.nodeType==1)};ab.isArray=H||function(ac){return s.call(ac)=="[object Array]"};ab.isObject=function(ac){return ac===Object(ac)};ab.isArguments=function(ac){return s.call(ac)=="[object Arguments]"};if(!ab.isArguments(arguments)){ab.isArguments=function(ac){return !!(ac&&ab.has(ac,"callee"))}}ab.isFunction=function(ac){return s.call(ac)=="[object Function]"};ab.isString=function(ac){return s.call(ac)=="[object String]"};ab.isNumber=function(ac){return s.call(ac)=="[object Number]"};ab.isFinite=function(ac){return ab.isNumber(ac)&&isFinite(ac)};ab.isNaN=function(ac){return ac!==ac};ab.isBoolean=function(ac){return ac===true||ac===false||s.call(ac)=="[object Boolean]"};ab.isDate=function(ac){return s.call(ac)=="[object Date]"};ab.isRegExp=function(ac){return s.call(ac)=="[object RegExp]"};ab.isNull=function(ac){return ac===null};ab.isUndefined=function(ac){return ac===void 0};ab.has=function(ad,ac){return x.call(ad,ac)};ab.noConflict=function(){K._=z;return this};ab.identity=function(ac){return ac};ab.times=function(af,ae,ad){for(var ac=0;ac<af;ac++){ae.call(ad,ac)}};ab.escape=function(ac){return(""+ac).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};ab.result=function(ac,ae){if(ac==null){return null}var ad=ac[ae];return ab.isFunction(ad)?ad.call(ac):ad};ab.mixin=function(ac){X(ab.functions(ac),function(ad){L(ad,ab[ad]=ac[ad])})};var M=0;ab.uniqueId=function(ac){var ad=M++;return ac?ac+ad:ad};ab.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var J=/.^/;var w={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var W in w){w[w[W]]=W}var y=/\\|'|\r|\n|\t|\u2028|\u2029/g;var Q=/\\(\\|'|r|n|t|u2028|u2029)/g;var Z=function(ac){return ac.replace(Q,function(ad,ae){return w[ae]})};ab.template=function(ah,ag,ae){ae=ab.defaults(ae||{},ab.templateSettings);var af="__p+='"+ah.replace(y,function(ai){return"\\"+w[ai]}).replace(ae.escape||J,function(ai,aj){return"'+\n_.escape("+Z(aj)+")+\n'"}).replace(ae.interpolate||J,function(ai,aj){return"'+\n("+Z(aj)+")+\n'"}).replace(ae.evaluate||J,function(ai,aj){return"';\n"+Z(aj)+"\n;__p+='"})+"';\n";if(!ae.variable){af="with(obj||{}){\n"+af+"}\n"}af="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+af+"return __p;\n";var ad=new Function(ae.variable||"obj","_",af);if(ag){return ad(ag,ab)}var ac=function(ai){return ad.call(this,ai,ab)};ac.source="function("+(ae.variable||"obj")+"){\n"+af+"}";return ac};ab.chain=function(ac){return ab(ac).chain()};var I=function(ac){this._wrapped=ac};ab.prototype=I.prototype;var G=function(ad,ac){return ac?ab(ad).chain():ad};var L=function(ac,ad){I.prototype[ac]=function(){var ae=C.call(arguments);O.call(ae,this._wrapped);return G(ad.apply(ab,ae),this._chain)}};ab.mixin(ab);X(["pop","push","reverse","shift","sort","splice","unshift"],function(ac){var ad=R[ac];I.prototype[ac]=function(){var ae=this._wrapped;ad.apply(ae,arguments);var af=ae.length;if((ac=="shift"||ac=="splice")&&af===0){delete ae[0]}return G(ae,this._chain)}});X(["concat","join","slice"],function(ac){var ad=R[ac];I.prototype[ac]=function(){return G(ad.apply(this._wrapped,arguments),this._chain)}});I.prototype.chain=function(){this._chain=true;return this};I.prototype.value=function(){return this._wrapped}}).call(this);function f(q,s,r){if(q instanceof f){r=q.z;s=q.y;q=q.x}this.x=q||0;this.y=s||0;this.z=r||0}f.prototype.add=function(q){this.x+=q.x;this.y+=q.y;this.z+=q.z;return this};f.prototype.scale=function(q){this.x*=q;this.y*=q;this.z*=q;return this};f.prototype.direction=function(){return Math.atan2(this.y,this.x)};f.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};f.prototype.addToMagnitude=function(s){s=s||0;var q=this.magnitude();var r=Math.sqrt((s+q)/q);this.x*=r;this.y*=r;this.z*=r;return this};f.prototype.unit=function(){return this.scale(1/this.magnitude())};f.prototype.rotateZ=function(q){var s=this.x;var r=this.y;this.x=s*Math.cos(q)-r*Math.sin(q);this.y=s*Math.sin(q)+r*Math.cos(q);return this};f.add=function(r,q){return new f(r.x+q.x,r.y+q.y,r.z+q.z)};f.subtract=function(r,q){return new f(r.x-q.x,r.y-q.y,r.z-q.z)};f.dot=function(r,q){return r.x*q.x+r.y*q.y+r.z*q.z};f.scale=function(q,r){return new f(q.x*r,q.y*r,q.z*r)};f.cross=function(r,q){return new f(r.y*q.z-q.y*r.z,r.z*q.x-q.z*r.x,r.x*q.y-q.x*r.y)};f.average=function(){var s,q=new f(),r=arguments;if(arguments[0].constructor.toString().indexOf("Array")!==-1){r=arguments[0]}s=r.length;for(i=0;i<s;i++){q.add(f.create(r[i]))}return q.scale(1/s)};f.create=function(q){return new f(q.x,q.y,q.z)};(function(t){var s=function(){return s};s.clear=function(u){u=u.canvas?u:u.getContext("2d");u.clearRect(0,0,u.canvas.width,u.canvas.height)};s.cssColor=function(u){if(u.length===3){return"rgb("+h(u[0])+","+h(u[1])+","+h(u[2])+")"}return"rgba("+h(u[0])+","+h(u[1])+","+h(u[2])+","+u[3]+")"};s.clamp=g=function(w,v,u){return(w<v?v:w>u?u:w)};s.opposite=function(v){if(!_.isArray(v)){v=s.parseColorString(v)}var u=s.rgb2hsl(v);u[0]=(u[0]+180)%360;u[1]=100-u[1];u[2]=100-u[2];var w=s.hsl2rgb(u);if(v.length===4){w.push(v[3])}return w};s.rgba2rgb=function(x){if(x.length===3||x[3]===255){return x}var z=x[0],y=x[1],u=x[2],v=x[3],w=[];w[0]=(v*z)+(255-v*255);w[1]=(v*y)+(255-v*255);w[2]=(v*u)+(255-v*255);return w};s.rgb2hex=function(u){u=s.rgba2rgb(u);return"#"+r(u[0])+r(u[1])+r(u[2])};s.hex2rgb=function(u){return s.parseColorString(u)};s.rgb2hsl=function(A){var u=A[0]/255,x=A[1]/255,B=A[2]/255,C=m(u,x,B),y=e(u,x,B),z,w,D,v=(C+y)/2;if(C===y){w=D=0}else{z=C-y;D=v>0.5?z/(2-C-y):z/(C+y);switch(m){case u:w=(x-B)/z+(x<B?6:0);break;case x:w=(B-u)/z+2;break;case B:w=(u-x)/z+4;break}w/=6}return[w,D*100,v*100]};s.hex2hsl=function(u){return s.rgb2hsl(s.hex2rgb(u))};s.hsl2rgb=function(A){var C,B,y;var u,x,z;var w=A[0],D=A[1]/100,v=A[2]/100;if(D===0){u=x=z=(v*255)}else{if(v<=0.5){B=v*(D+1)}else{B=v+D-v*D}C=v*2-B;y=w/360;u=q(C,B,y+1/3);x=q(C,B,y);z=q(C,B,y-1/3)}return[u,x,z]};function r(u){u=parseInt(u,10)||0;u=g(u,0,255).toString(16);if(u.length===1){u="0"+u}return u}function q(y,x,w){var u;if(w<0){w+=1}else{if(w>1){w-=1}}if(6*w<1){u=y+(x-y)*w*6}else{if(2*w<1){u=x}else{if(3*w<2){u=y+(x-y)*(2/3-w)*6}else{u=y}}}return 255*u}s.parseColorString=function(v){function D(I){var G=document.createElement("a");G.style.color=I;document.body.appendChild(G);var H=getComputedStyle(G).color;document.body.removeChild(G);return H}var A=false,u,z,B,C;v=D(v);var x=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(G){return[parseInt(G[1],10),parseInt(G[2],10),parseInt(G[3],10),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(G){return[parseInt(G[1],10),parseInt(G[2],10),parseInt(G[3],10),parseFloat(G[4])]}}];for(var y=0;y<x.length;y++){var F=x[y].re;var w=x[y].process;var E=F.exec(v);if(E){channels=w(E);u=channels[0];z=channels[1];B=channels[2];C=channels[3];A=true}}u=(u<0||isNaN(u))?0:((u>255)?255:u);z=(z<0||isNaN(z))?0:((z>255)?255:z);B=(B<0||isNaN(B))?0:((B>255)?255:B);C=(C<0||isNaN(C))?0:((C>1)?1:C);return A?[u,z,B,C]:[0,0,0,1]};t.util=s})(TeledrawCanvas);(function(){var r=0;var s=["ms","moz","webkit","o"];for(var q=0;q<s.length&&!window.requestAnimationFrame;++q){window.requestAnimationFrame=window[s[q]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[s[q]+"CancelAnimationFrame"]||window[s[q]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(x,u){var t=new Date().getTime();var v=Math.max(0,16-(t-r));var w=window.setTimeout(function(){x(t+v)},v);r=t+v;return w}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(t){clearTimeout(t)}}}());(function(t){t.canvases=[];var y=0;var q={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1000,strokeSoftness:0};var B={last:null,currentTool:null,previousTool:null,tool:null,mouseDown:false,mouseOver:false,width:null,height:null,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5000,enableZoom:true,enableKeyboardShortcuts:true,enableWacomSupport:true,maxHistory:10,minStrokeSize:500,maxStrokeSize:10000,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8};var u;function x(){if(!u){var C;if(navigator.mimeTypes["application/x-wacomtabletplugin"]){C=document.createElement("embed");C.name=C.id="wacom-plugin";C.type="application/x-wacomtabletplugin"}else{C=document.createElement("object");C.classid="CLSID:092dfa86-5807-5a94-bf3b-5a53ba9e5308";C.codebase="fbWacomTabletPlugin.cab"}C.style.width=C.style.height="1px";C.style.top=C.style.left="-10000px";C.style.position="absolute";document.body.appendChild(C);u=C}}function z(){if(u&&u.penAPI){var C=u.penAPI.pressure;return C}}function v(){if(u&&u.penAPI){return parseInt(u.penAPI.pointerType,10)===3}}function A(E){var D=0;var C=0;while(E&&!isNaN(E.offsetLeft)&&!isNaN(E.offsetTop)){D+=E.offsetLeft;C+=E.offsetTop;E=E.offsetParent}return{top:C,left:D}}var s=t.Canvas=typeof _Canvas!=="undefined"?_Canvas:function(E,C){var D=document.createElement("canvas");if(E){D.width=E}if(C){D.height=C}return D};var r=function(E,D){var C=this,F=C.element=E.getContext?E:document.getElementById(E);state=C.state=_.extend({},B,D);if(typeof(new s()).getContext!=="function"){throw new Error("Error: Your browser does not support HTML canvas!")}if(state.enableWacomSupport){x()}F.width=state.width=state.displayWidth||state.width||F.width;F.height=state.height=state.displayHeight||state.height||F.height;state.fullWidth=state.fullWidth||state.width;state.fullHeight=state.fullHeight||state.height;if(state.width/state.height!==state.fullWidth/state.fullHeight){state.fullHeight=state.fullWidth*state.height/state.width}C._displayCanvas=F;if(state.enableZoom){C._canvas=new s(state.fullWidth,state.fullHeight)}else{C._canvas=F}C.history=new t.History(C);C.defaults();C.zoom(0);C.history.checkpoint();t.canvases[y++]=C;C.bindEvents()};var w=r.prototype;w.bindEvents=function(){var L=this,D=L.element,G=L.state,M,J=null,C=0,U=0;d(D,"gesturestart",S);d(D,"gesturechange",N);d(D,"gestureend",H);d(D,"dblclick",O);d(D,"mouseenter",R);d(D,"mousedown",T);d(D,"touchstart",T);d(D,"mouseleave",I);d(window,"mousemove",E);d(window,"touchmove",E);d(window,"keydown",P);d(window,"keyup",K);L.unbindEvents=function(){l(D,"gesturestart",S);l(D,"gesturechange",N);l(D,"gestureend",H);l(D,"dblclick",O);l(D,"mouseenter",R);l(D,"mousedown",T);l(D,"touchstart",T);l(D,"mouseleave",I);l(window,"mousemove",E);l(window,"touchmove",E);l(window,"keydown",P);l(window,"keyup",K)};function R(V){var W=F(V);G.tool.enter(G.mouseDown,W);G.last=W;G.mouseOver=true}function I(V){var W=F(V);G.tool.leave(G.mouseDown,W);G.mouseOver=false}function O(V){var W=F(V);G.tool.dblclick(W)}function K(V){G.tool.keyup(G.mouseDown,V.keyCode)}function P(W){G.tool.keydown(G.mouseDown,W.keyCode);if(!G.enableKeyboardShortcuts){return}var V=document.activeElement.nodeName.toLowerCase();if(V==="input"||V==="textarea"){return}else{switch(W.keyCode){case 69:L.setTool("eraser");break;case 70:L.setTool("fill");break;case 71:L.setTool("grab");break;case 73:L.setTool("eyedropper");break;case 76:L.setTool("line");break;case 79:L.setTool("ellipse");break;case 80:L.setTool("pencil");break;case 82:L.setTool("rectangle");break;case 90:if(G.mouseDown){return false}if(W.metaKey||W.ctrlKey){if(W.shiftKey){L.redo()}else{L.undo()}return false}break;case 189:if(W.shiftKey){L.setStrokeSize(G.strokeSize-500)}break;case 187:if(W.shiftKey){L.setStrokeSize(G.strokeSize+500)}break;case 188:if(W.shiftKey){L.setAlpha(G.globalAlpha-0.1)}break;case 190:if(W.shiftKey){L.setAlpha(G.globalAlpha+0.1)}break;case 219:if(W.shiftKey){L.setStrokeSoftness(G.strokeSoftness-10)}break;case 221:if(W.shiftKey){L.setStrokeSoftness(G.strokeSoftness+10)}break}}}function E(W){if(Date.now()-C<25){return false}C=Date.now();if(W.type==="touchmove"&&W.touches.length>1){return true}if(J==="touchmove"&&W.type==="mousemove"){return}if(W.target===D||G.mouseDown){var V=F(W);G.tool.move(G.mouseDown,G.last,V);G.last=V;L.trigger("mousemove",V,W);J=W.type;W.preventDefault();return false}}function T(W){var V=G.last=F(W);if(W.type==="touchstart"&&W.touches.length>1){return true}d(window,W.type==="mousedown"?"mouseup":"touchend",Q);G.mouseDown=true;if(G.enableWacomSupport&&v()&&G.currentTool!=="eraser"){L.setTool("eraser");G.wacomWasEraser=true}G.tool.down(V);L.trigger("mousedown",V,W);document.onselectstart=function(){return false};W.preventDefault();return false}function Q(V){l(window,V.type==="mouseup"?"mouseup":"touchend",Q);if(V.type==="touchend"&&V.touches.length>1){return true}G.mouseDown=false;G.tool.up(G.last);L.trigger("mouseup",G.last,V);if(G.wacomWasEraser===true){L.previousTool();G.wacomWasEraser=false}document.onselectstart=function(){return true};V.preventDefault();return false}function S(V){if(G.tool.name==="grab"){M=G.currentZoom}}function N(V){if(G.tool.name==="grab"){var W=G.last;L.zoom(M*V.scale,W.xd,W.yd)}V.preventDefault();return false}function H(V){}function F(Y){var Z=A(D),W=Y.pageX||Y.touches&&Y.touches[0].pageX,V=Y.pageY||Y.touches&&Y.touches[0].pageY,X=null;if(G.enableWacomSupport){if(Date.now()-U>25){U=Date.now();X=z()}}return{x:h((W-Z.left)/G.currentZoom)+G.currentOffset.x||0,y:h((V-Z.top)/G.currentZoom)+G.currentOffset.y||0,xd:h(W-Z.left)||0,yd:h(V-Z.top)||0,p:X}}};w.setRGBAArrayColor=function(E){var F=this.state;if(E.length===4){this.setAlpha(E.pop())}for(var D=E.length;D<3;++D){E.push(0)}var C=F.color;F.color=E;this.trigger("tool.color",F.color,C);return this};w.updateTool=function(){var C=1+h(j(this.state.strokeSize/1000,2));var D=h(j(this.state.strokeSoftness,1.3)/300*C);this.state.lineWidth=C;this.state.shadowBlur=D};w.updateDisplayCanvas=function(F){if(this.state.enableZoom===false){return this}var J=this.displayCtx(),I=this.state.currentOffset,G=this.state.currentZoom,D=J.canvas.width,H=J.canvas.height,C=h(D/G),E=h(H/G);t.util.clear(J);if(F!==true){this.trigger("display.update:before")}J.drawImage(this._canvas,I.x,I.y,C,E,0,0,D,H);if(F!==true){this.trigger("display.update:after")}};w.canvas=function(){return this._canvas};w.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))};w.displayCanvas=function(){return this._displayCanvas};w.displayCtx=function(){return this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d"))};w.destroy=function(){this.unbindEvents()};w.cursor=function(D){if(!D){D="default"}var C=D.split(/,\s*/);do{D=C.shift();this.element.style.cursor=D}while(D.length&&this.element.style.cursor!==D);return this};w.clear=function(D){var C=this;t.util.clear(C.ctx());if(D!==true){C.history.checkpoint()}C.updateDisplayCanvas();C.trigger("clear");return C};w.defaults=function(){var C=this;C.setTool(q.tool);C.setAlpha(q.alpha);C.setColor(q.color);C.setStrokeSize(q.strokeSize);C.setStrokeSoftness(q.strokeSoftness);return C};w.toDataURL=function(I,H,C,F,E,G){if(arguments.length>=4){I=I||0;H=H||0;E=E||C;G=G||F;var D=this.getTempCanvas(E,G);D.getContext("2d").drawImage(this.canvas(),I,H,C,F,0,0,E,G);return D.toDataURL()}return this.canvas().toDataURL()};w.getTempCanvas=function(C,D){return new s(C||this._canvas.width,D||this._canvas.height)};w.fromDataURL=w.fromImageURL=function(F,C){var E=this,D=new Image();D.onload=function(){E.clear(true);E.ctx().drawImage(D,0,0);E.updateDisplayCanvas();if(typeof C==="function"){C.call(E)}};D.src=F;return E};w.isBlank=function(){var F=this.getImageData().data;var C=F.length;for(var E=0,D=C;E<D;++E){if(F[E]!==0){return false}}return true};w.fromImage=w.fromVideo=w.fromCanvas=function(C){this.clear(true);this.ctx().drawImage(C,0,0);this.updateDisplayCanvas();return this};w.getImageData=function(){var C=this.ctx();return C.getImageData(0,0,C.canvas.width,C.canvas.height)};w.putImageData=function(C){this.ctx().putImageData(C,0,0);this.updateDisplayCanvas();return this};w.getColor=function(){return this.state.color.slice()};w.setColor=function(C){if(!_.isArray(C)){C=t.util.parseColorString(C)}this.setRGBAArrayColor(C);return this};w.setAlpha=function(D){var C=this.state.globalAlpha;this.state.globalAlpha=g(D,0,1);this.trigger("tool.alpha",this.state.globalAlpha,C);return this};w.getAlpha=function(){return this.state.globalAlpha};w.setStrokeSize=function(D){var C=this.state.strokeSize;this.state.strokeSize=g(D,this.state.minStrokeSize,this.state.maxStrokeSize);this.updateTool();this.trigger("tool.size",this.state.strokeSize,C);return this};w.setStrokeSoftness=function(D){var C=this.state.strokeSoftness;this.state.strokeSoftness=g(D,this.state.minStrokeSoftness,this.state.maxStrokeSoftness);this.updateTool();this.trigger("tool.softness",this.state.strokeSoftness,C);return this};w.setTool=function(C){if(this.state.currentTool===C){return this}this.state.previousTool=this.state.currentTool;this.state.currentTool=C;if(!t.tools[C]){throw new Error('Tool "'+C+'" not defined.')}this.state.tool=new t.tools[C](this);this.trigger("tool.change",this.state.currentTool,this.state.previousTool);return this};w.previousTool=function(){return this.setTool(this.state.previousTool)};w.undo=function(){this.history.undo();this.trigger("history undo",this.history.past.length,this.history.future.length);return this};w.redo=function(){this.history.redo();this.trigger("history redo",this.history.past.length,this.history.future.length);return this};w.resize=function(D,F){if(this.state.enableZoom===false){return this}var E=this,C=Math.round(E._canvas.width/E._canvas.height*100)/100,G=Math.round(D/F*100)/100;if(C!==G){throw new Error("Not the same aspect ratio!")}E._displayCanvas.width=E.state.width=D;E._displayCanvas.height=E.state.height=F;this.trigger("resize",D,F);return E.zoom(E.state.currentZoom)};w.zoom=function(F,H,G){if(arguments.length===0){return this.state.currentZoom}if(this.state.enableZoom===false){return this}var J=this,E=0,D=0,I=J.state.currentZoom,K=J._displayCanvas.width,C=J._displayCanvas.height;H=g(H||K/2,0,K);G=g(G||C/2,0,C);F=g(F||0,K/J._canvas.width,J.state.maxZoom);if(F!==I){if(F>I){E=-(K/I-K/F)/2-(H-K/2)/I;D=-(C/I-C/F)/2-(G-C/2)/I}else{if(F<I){E=(K/F-K/I)/2;D=(C/F-C/I)/2}}E*=F;D*=F}J.state.currentZoom=F;J.trigger("zoom",F,I);J.pan(E,D);J.updateDisplayCanvas();return J};w.pan=function(F,E,G){if(arguments.length===0){return this.state.currentOffset}if(this.state.enableZoom===false){return this}var K=this,J=K.state.currentZoom,D=K.state.currentOffset.x,C=K.state.currentOffset.y,I=K._canvas.width-h(K._displayCanvas.width/J),H=K._canvas.height-h(K._displayCanvas.height/J);F=G===true?F/J:D-(F||0)/J;E=G===true?E/J:C-(E||0)/J;F=h(g(F,0,I));E=h(g(E,0,H));K.state.currentOffset={x:F,y:E};K.trigger("pan",K.state.currentOffset,{x:D,y:C});K.updateDisplayCanvas();return K};_.extend(w,Events);t.api=r})(TeledrawCanvas);(function(r){var q=function(s){this.canvas=s;this.rev=0;this.clear()};q.prototype.clear=function(){this.past=[];this.current=null;this.future=[]};q.prototype.checkpoint=function(){if(this.past.length>this.canvas.state.maxHistory){this.past.shift().destroy()}if(this.current){this.past.push(this.current)}this.current=new r.Snapshot(this.canvas);this.future=[];this.rev++};q.prototype.undo=function(){if(this._move(this.past,this.future)){this.rev--}};q.prototype.redo=function(){if(this._move(this.future,this.past)){this.rev++}};q.prototype._move=function(t,s){if(!t.length){return false}if(!this.current){return false}s.push(this.current);this.current=t.pop();this.current.restore();return true};r.History=q})(TeledrawCanvas);(function(r){var q=function(s){this.canvas=s;if(!this.canvas._snapshotBuffers){this.canvas._snapshotBuffers=[]}this._snapshotBufferCanvas()};q.prototype.restore=function(u){var s,t;if(u){s=u.tl;t=u.br}else{s={x:0,y:0};t={x:this.canvas.canvas().width,y:this.canvas.canvas().height}}this._restoreBufferCanvas(s,t);this.canvas.updateDisplayCanvas(false,s,t)};q.prototype.destroy=function(){this._putBufferCtx()};q.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()};q.prototype._snapshotBufferCanvas=function(){this._getBufferCtx();this.buffer.drawImage(this.canvas.canvas(),0,0)};q.prototype._restoreBufferCanvas=function(u,v){var t=this.canvas.ctx();var s=v.x-u.x,x=v.y-u.y;if(s===0||x===0){return}t.clearRect(u.x,u.y,s,x);t.drawImage(this.buffer.canvas,u.x,u.y,s,x,u.x,u.y,s,x)};q.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()};q.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)};q.prototype._putBufferCtx=function(){if(this.buffer){this.canvas._snapshotBuffers.push(this.buffer)}this.buffer=null};q.prototype._getBufferCtx=function(){var s;if(!this.buffer){if(this.canvas._snapshotBuffers.length){s=this.canvas._snapshotBuffers.pop();s.clearRect(0,0,s.canvas.width,s.canvas.height)}else{s=this.canvas.getTempCanvas().getContext("2d")}}this.buffer=s};r.Snapshot=q})(TeledrawCanvas);(function(r){var q=function(s){this.canvas=s};q.prototype.start=function(s){};q.prototype.move=function(t,s){};q.prototype.end=function(){};q.prototype.draw=function(){};q.prototype.save=function(){this.snapshot=new r.Snapshot(this.canvas)};q.prototype.restore=function(){this.snapshot.restore(this)};q.prototype.destroy=function(){this.snapshot.destroy()};r.Stroke=q})(TeledrawCanvas);(function(r){var q=function(){};q.prototype.down=function(s){};q.prototype.up=function(s){};q.prototype.move=function(s,u,t){};q.prototype.dblclick=function(s){};q.prototype.enter=function(s,t){};q.prototype.leave=function(s,t){};q.prototype.keydown=function(s,t){if(t===16){this.shiftKey=true;if(s){this._updateBoundaries({});this.draw()}}};q.prototype.keyup=function(s,t){if(t===16){this.shiftKey=false;if(s){this._updateBoundaries({});this.draw()}}};q.prototype.preview=function(s,t){return new r.Canvas(s||100,t||100)};q.createTool=function(t,w,u){var v=function(y,x){this.canvas=y;this.ctx=x||y.ctx();this.color=y.getColor();this.color.push(y.getAlpha());this.points=[];this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height};this.br={x:0,y:0};this.tool={}};v.prototype=new r.Stroke();var s=function(x){this.canvas=x;x.cursor(w);this.name=t;this.cursor=w||"default";this.currentStroke=null;if(typeof u=="function"){u.call(this)}};s.prototype=new q();s.prototype.down=function(x){this.currentStroke=new v(this.canvas);this.currentStroke.tool=this;this.currentStroke.save();this.currentStroke.points.push(x);this.currentStroke.start(x);this._updateBoundaries(x);this.draw()};s.prototype.move=function(x,z,y){if(x&&this.currentStroke){this.currentStroke.points.push(y);this.currentStroke.move(z,y);this._updateBoundaries(y);this.draw()}};s.prototype.up=function(x){if(this.currentStroke){this.currentStroke.end(x);this.draw();this.currentStroke.destroy();this.currentStroke=null;this.canvas.history.checkpoint()}this.canvas.trigger("tool.up")};s.prototype.draw=function(){this.currentStroke.ctx.save();this.currentStroke.restore();this.currentStroke.draw();this.canvas.updateDisplayCanvas(false,this.currentStroke.tl,this.currentStroke.br);this.currentStroke.ctx.restore()};s.prototype._updateBoundaries=function(A){var z=this.currentStroke,x=z.ctx.canvas,y=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;if(this.shiftKey){z.tl.x=z.tl.y=0;z.br.x=x.width;z.br.y=x.height;return}if(A.x-y<z.tl.x){z.tl.x=g(h(A.x-y),0,x.width)}if(A.x+y>z.br.x){z.br.x=g(h(A.x+y),0,x.width)}if(A.y-y<z.tl.y){z.tl.y=g(h(A.y-y),0,x.height)}if(A.y+y>z.br.y){z.br.y=g(h(A.y+y),0,x.height)}};s.stroke=v;v.tool=s;r.tools[t]=s;return s};r.Tool=q;r.tools={}})(TeledrawCanvas);(function(t){var q=t.Tool.createTool("ellipse","crosshair"),r=q.stroke.prototype;q.prototype.preview=function(){var w=t.Tool.prototype.preview.apply(this,arguments);var u=w.getContext("2d");var v=new q.stroke(this.canvas,u);v.first={x:0,y:0};v.second={x:w.width,y:w.height};v.draw();return w};r.bgColor=[255,255,255];r.bgAlpha=0;r.lineWidth=1;r.start=function(u){this.first=u};r.move=function(v,u){this.second=u};r.end=function(u){this.second=u};r.draw=function(){if(!this.first||!this.second){return}var F=this,D=F.first.x,C=F.first.y,E=F.second.x-D,A=F.second.y-C,G=F.ctx,u=F.canvas.state,H=u.shadowOffset,z=u.shadowBlur,B=u.lineWidth,v=t.util.cssColor(u.color);G.lineJoin=G.lineCap="round";G.globalAlpha=u.globalAlpha;G.fillStyle=G.strokeStyle=v;G.miterLimit=100000;if(F.tool.shiftKey){A=F.second.y>C?p(E):-p(E)}if(F.tool.fill){s(G,D,C,E,A);G.fill()}else{if(z>0){G.shadowColor=v;G.shadowOffsetX=G.shadowOffsetY=H;G.shadowBlur=z;G.translate(-H,-H)}G.lineWidth=B;s(G,D,C,E,A);G.stroke()}};function s(z,u,C,v,A){var B=0.5522848;ox=(v/2)*B,oy=(A/2)*B,xe=u+v,ye=C+A,xm=u+v/2,ym=C+A/2;z.beginPath();z.moveTo(u,ym);z.bezierCurveTo(u,ym-oy,xm-ox,C,xm,C);z.bezierCurveTo(xm+ox,C,xe,ym-oy,xe,ym);z.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);z.bezierCurveTo(xm-ox,ye,u,ym+oy,u,ym);z.closePath()}})(TeledrawCanvas);(function(r){var q=r.Tool.createTool("eraser","crosshair");q.prototype.preview=function(){var u=r.Tool.prototype.preview.apply(this,arguments);var s=u.getContext("2d");s.fillStyle="black";s.fillRect(0,0,u.width,u.height);var t=new q.stroke(this.canvas,s);t.points=[{x:u.width/2,y:u.height/2}];t.draw();return u};q.stroke.prototype.lineWidth=1;q.stroke.prototype.lineCap="round";q.stroke.prototype.draw=function(){this.color=[255,255,255,255];this.ctx.globalCompositeOperation="destination-out";r.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(s){var q=function(){this.previewContainer=document.createElement("div");_.extend(this.previewContainer.style,{position:"absolute",width:"10px",height:"10px",border:"1px solid black",display:"none"});document.body.appendChild(this.previewContainer);if(this.canvas.state.mouseOver){this.previewContainer.style.display="block"}};var r=s.Tool.createTool("eyedropper","crosshair",q);r.prototype.preview=function(){var u=s.Tool.prototype.preview.apply(this,arguments);var t=u.getContext("2d");t.fillStyle=s.util.cssColor(this.color);t.fillRect(0,0,u.width,u.height);return u};r.prototype.pick=function(x){var u=this.previewContainer,y,w=this.canvas.element.offsetLeft,v=this.canvas.element.offsetTop,t=this.canvas._displayCtx.getImageData(x.xd,x.yd,1,1).data;this.color=s.util.rgba2rgb(Array.prototype.slice.call(t));y=s.util.rgb2hsl(this.color)[2];_.extend(u.style,{left:(w+x.xd+15)+"px",top:(v+x.yd+5)+"px",background:s.util.cssColor(this.color),"border-color":y>=50?"#000":"#888"});if(this.canvas.state.mouseOver){u.style.display="none";u.offsetHeight=u.offsetHeight;u.style.display="block"}else{u.style.display="none"}};r.prototype.enter=function(){this.previewContainer.style.display="block"};r.prototype.leave=function(){this.previewContainer.style.display="none"};r.prototype.move=function(v,u,t){this.pick(t)};r.prototype.down=function(t){this.pick(t)};r.prototype.up=function(t){this.pick(t);this.canvas.setColor(this.color);this.previewContainer.parentNode.removeChild(this.previewContainer);this.canvas.previousTool()}})(TeledrawCanvas);(function(x){var s=x.Tool.createTool("fill","crosshair");var q=Math.abs;s.blur=true;s.stroke.prototype.bgColor=[255,255,255];s.stroke.prototype.bgAlpha=255;s.stroke.prototype.end=function(D){var H=this.ctx.canvas.width,C=this.ctx.canvas.height;var z=this.ctx.getImageData(0,0,H,C);var E=this.ctx.createImageData(H,C);var A=this.color;A[3]*=255;w(z.data,E.data,D,H,C,this.color);this.tmp_canvas=this.canvas.getTempCanvas();var G=this.tmp_canvas.getContext("2d");G.putImageData(E,0,0);if(s.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);var F=G.getImageData(0,0,H,C);for(var B=0,y=F.data.length;B<y;B+=4){if(F.data[B+3]/255>0.2){F.data[B]=A[0];F.data[B+1]=A[1];F.data[B+2]=A[2];F.data[B+3]=Math.min(A[3],F.data[B+3]*3)}}G.putImageData(F,0,0)}};s.stroke.prototype.draw=function(){if(this.tmp_canvas){this.ctx.drawImage(this.tmp_canvas,0,0)}};function w(C,B,Q,I,P,J){var D=[[Q.x,Q.y]];var K=u(C,Q.x,Q.y,I);var O=s.tolerance;var E,z;var N,M,L,H,F,A;var G=x.util.opposite(K);G[3]/=2;while(D.length){L=D.pop();H=L[0];A=F=L[1];while(A>=0&&t(u(C,H,A,I),K)){A--}A++;E=z=false;while(A<P&&t(u(C,H,A,I),K)){r(C,H,A,I,G);r(B,H,A,I,J);if(!E&&H>0&&t(u(C,H-1,A,I),K)){D.push([H-1,A]);E=true}else{if(E&&H>0&&t(u(C,H-1,A,I),K)){E=false}}if(!z&&H<I-1&&t(u(C,H+1,A,I),K)){D.push([H+1,A]);z=true}else{if(z&&H<I-1&&t(u(C,H+1,A,I),K)){z=false}}A++}}}function u(B,z,D,A){var C=(D*A+z)*4;return[B[C],B[C+1],B[C+2],B[C+3]]}function r(C,z,E,A,B){var D=(E*A+z)*4;C[D]=B[0];C[D+1]=B[1];C[D+2]=B[2];C[D+3]=B[3]}function v(z,y){return q(z[0]-y[0])+q(z[1]-y[1])+q(z[2]-y[2])+q(z[3]-y[3])}function t(z,y){return v(z,y)<5}})(TeledrawCanvas);(function(t){var r="hand, grab, -moz-grab, -webkit-grab, move",q="grabbing, -moz-grabbing, -webkit-grabbing, move";var s=t.Tool.createTool("grab",r);s.prototype.move=function(x,w,v){var u=this;if(x){clearTimeout(this._clearDeltasId);cancelAnimationFrame(this._momentumId);this.dx=v.xd-w.xd;this.dy=v.yd-w.yd;this.canvas.pan(this.dx,this.dy);this._clearDeltasId=setTimeout(function(){u.dx=u.dy=0},100)}};s.prototype.down=function(u){cancelAnimationFrame(this._momentumId);this.canvas.cursor(q)};s.prototype.up=function(u){cancelAnimationFrame(this._momentumId);this.momentum(this.dx,this.dy);this.dx=this.dy=0;this.canvas.cursor(r)};s.prototype.dblclick=function(v){cancelAnimationFrame(this._momentumId);this.dx=this.dy=0;var u=2;if(this.shiftKey){u/=4}this.canvas.zoom(this.canvas.state.currentZoom*u,v.xd,v.yd)};s.prototype.momentum=function(w,u){var v=this;if(Math.abs(w)>=1||Math.abs(u)>=1){w/=1.1;u/=1.1;this.canvas.pan(w,u);this._momentumId=requestAnimationFrame(function(){v.momentum(w,u)})}}})(TeledrawCanvas);(function(r){var q=r.Tool.createTool("line","crosshair");q.prototype.preview=function(){var u=r.Tool.prototype.preview.apply(this,arguments);var s=u.getContext("2d");var t=new q.stroke(this.canvas,s);t.first={x:0,y:0};t.second={x:u.width,y:u.height};t.draw();return u};q.stroke.prototype.lineCap="round";q.stroke.prototype.start=function(s){this.first=s};q.stroke.prototype.move=function(t,s){this.second=s};q.stroke.prototype.end=function(s){this.second=s};q.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var w=_.extend({},this.first),u=_.extend({},this.second),t,s,z,v=Math.PI;delete w.p;delete u.p;if(this.tool.shiftKey){s=u.x-w.x;z=u.y-w.y;t=Math.atan2(z,s);if((t>=-v*7/8&&t<-v*5/8)||(t>=-v*3/8&&t<-v/8)){u.y=w.y-Math.abs(s)}else{if((t>=-v*5/8&&t<-v*3/8)||(t>=v*3/8&&t<v*5/8)){u.x=w.x}else{if((t>=v/8&&t<v*3/8)||(t>=v*5/8&&t<v*7/8)){u.y=w.y+Math.abs(s)}else{u.y=w.y}}}}this.points=[w,u];r.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(v){var q=v.Tool.createTool("pencil","crosshair");q.prototype.preview=function(){var y=v.Tool.prototype.preview.apply(this,arguments);var w=y.getContext("2d");var x=new q.stroke(this.canvas,w);x.points=[{x:y.width/2,y:y.height/2}];x.draw();return y};q.stroke.prototype.lineCap="round";q.stroke.prototype.smoothing=true;q.stroke.prototype.draw=function(){var C=this.canvas.state,z=this.ctx,B=this.points,y=C.shadowOffset,x=C.shadowBlur,w=C.lineWidth,A=v.util.cssColor(C.color);z.globalAlpha=C.globalAlpha;z.fillStyle=z.strokeStyle=A;z.miterLimit=100000;if(x>0){z.shadowColor=A;z.shadowOffsetX=z.shadowOffsetY=y;z.shadowBlur=x;z.translate(-y,-y)}if(B.length===1){switch(this.lineCap){case"round":z.beginPath();if(B[0].p){w*=B[0].p*2}z.arc(B[0].x,B[0].y,w/2,0,2*Math.PI,true);z.closePath();z.fill();break;case"square":z.fillRect(B[0].x-w/2,B[0].y-w/2,w,w)}}else{if(B.length>1){z.lineJoin="round";z.lineCap=this.lineCap;z.lineWidth=w;if(B[0].p||B[1].p){z.beginPath();t(z,u(B,w),this.smoothing);z.closePath();z.fill()}else{z.beginPath();t(z,B,this.smoothing);z.stroke()}}}};function u(H,D){var I={left:[],right:[]},C=H.length,w=H[0],E=new f(w.x,w.y),x,G,y,F,B;for(var A=1,z=C;A<z;++A){x=H[A];if(x.x===w.x&&x.y===w.y){continue}G=new f(x.x,x.y);y=f.subtract(G,E).unit().rotateZ(Math.PI/2);F=f.subtract(G,E).unit().rotateZ(-Math.PI/2);B=new f(y).scale(w.p*D).add(E);I.left.push({x:B.x,y:B.y});B=new f(F).scale(w.p*D).add(E);I.right.unshift({x:B.x,y:B.y});w=x;E=G}B=new f(y).scale(w.p*D).add(E);I.left.push({x:B.x,y:B.y});B=new f(F).scale(w.p*D).add(E);I.right.unshift({x:B.x,y:B.y});result=I.left.concat(I.right);result.push(I.left[0]);return result}function t(E,D,z){if(D.length===0){return}E.moveTo(D[0].x,D[0].y);var x=D[0],B=null,F=x,A=D.length;for(var y=1,w=A;y<w;++y){F=D[y];if(B&&(B.x===F.x||B.y===F.y)){F.x+=0.1;F.y+=0.1}if(z){var C={x:(x.x+F.x)/2,y:(x.y+F.y)/2};E.quadraticCurveTo(x.x,x.y,C.x,C.y)}else{E.lineTo(F.x,F.y)}B=x;x=D[y]}if(z){E.quadraticCurveTo(x.x,x.y,F.x,F.y)}}function s(x,w){return n(c(x.x-w.x)+c(x.y-w.y))}function r(x){var A=0,w=x.length;for(var z=0,y=w;z<y;z++){A+=+x[z]}return A/w}})(TeledrawCanvas);(function(s){var r=s.Tool.createTool("rectangle","crosshair");r.prototype.preview=function(){var v=s.Tool.prototype.preview.apply(this,arguments);var t=v.getContext("2d");var u=new r.stroke(this.canvas,t);u.first={x:0,y:0};u.second={x:v.width,y:v.height};u.draw();return v};r.stroke.prototype.bgColor=[255,255,255];r.stroke.prototype.bgAlpha=0;r.stroke.prototype.lineWidth=1;r.stroke.prototype.start=function(t){this.first=t};r.stroke.prototype.move=function(u,t){this.second=t};r.stroke.prototype.end=function(t){this.second=t};r.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var y=this.first,u=_.extend({},this.second),B=this.ctx,t=this.canvas.state,C=t.shadowOffset,x=t.shadowBlur,z=t.lineWidth,v=s.util.cssColor(t.color);B.lineJoin=B.lineCap="round";B.globalAlpha=t.globalAlpha;B.fillStyle=B.strokeStyle=v;B.miterLimit=100000;if(this.tool.shiftKey){var A=Math.abs(u.x-y.x);u.y=y.y+(u.y>y.y?A:-A)}if(this.tool.fill){q(B,y,u);B.fill()}else{if(x>0){B.shadowColor=v;B.shadowOffsetX=B.shadowOffsetY=C;B.shadowBlur=x;B.translate(-C,-C)}B.lineWidth=z;q(B,y,u);B.stroke()}};function q(t,v,u){t.beginPath();t.moveTo(v.x,v.y);t.lineTo(u.x,v.y);t.lineTo(u.x,u.y);t.lineTo(v.x,u.y);t.lineTo(v.x,v.y)}})(TeledrawCanvas)})();