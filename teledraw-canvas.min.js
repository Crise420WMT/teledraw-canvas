/*!

	Teledraw TeledrawCanvas
	Version 0.9.0 (http://semver.org/)
	Copyright 2012 Cameron Lakenen
	
	Permission is hereby granted, free of charge, to any person obtaining
	a copy of this software and associated documentation files (the
	"Software"), to deal in the Software without restriction, including
	without limitation the rights to use, copy, modify, merge, publish,
	distribute, sublicense, and/or sell copies of the Software, and to
	permit persons to whom the Software is furnished to do so, subject to
	the following conditions:
	
	The above copyright notice and this permission notice shall be
	included in all copies or substantial portions of the Software.
	
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
	OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
	WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

**/
(function(){var d=true,j=false,p=null,s,b=Math,h=b.abs,o=b.floor,q=b.round,k=b.min,m=b.max,c=b.pow,g;TeledrawCanvas=function(t,u){return new TeledrawCanvas.api(t,u)};stackBlurCanvasRGBA=(function(){var t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var w=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var v=function(G,aj){if(isNaN(aj)||aj<1){return}aj|=0;var aa=0,Y=0,z=G.width,B=G.height;var au=G.getContext("2d");var ao;try{try{ao=au.getImageData(aa,Y,z,B)}catch(at){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");ao=au.getImageData(aa,Y,z,B)}catch(at){alert("Cannot access local image");throw new Error("unable to access local image data: "+at);return}}}catch(at){alert("Cannot access image");throw new Error("unable to access image data: "+at)}var F=ao.data;var ah,ag,aq,an,O,R,K,D,E,X,am,N,Z,V,A,ad,ai,P,M,J,Q,S,T,ac;var ar=aj+aj+1;var ae=z<<2;var L=z-1;var al=B-1;var I=aj+1;var ak=I*(I+1)/2;var ab=new u();var W=ab;for(aq=1;aq<ar;aq++){W=W.next=new u();if(aq==I){var H=W}}W.next=ab;var ap=null;var af=null;K=R=0;var U=t[aj];var C=w[aj];for(ag=0;ag<B;ag++){ad=ai=P=M=D=E=X=am=0;N=I*(J=F[R]);Z=I*(Q=F[R+1]);V=I*(S=F[R+2]);A=I*(T=F[R+3]);D+=ak*J;E+=ak*Q;X+=ak*S;am+=ak*T;W=ab;for(aq=0;aq<I;aq++){W.r=J;W.g=Q;W.b=S;W.a=T;W=W.next}for(aq=1;aq<I;aq++){an=R+((L<aq?L:aq)<<2);D+=(W.r=(J=F[an]))*(ac=I-aq);E+=(W.g=(Q=F[an+1]))*ac;X+=(W.b=(S=F[an+2]))*ac;am+=(W.a=(T=F[an+3]))*ac;ad+=J;ai+=Q;P+=S;M+=T;W=W.next}ap=ab;af=H;for(ah=0;ah<z;ah++){F[R+3]=T=(am*U)>>C;if(T!=0){T=255/T;F[R]=((D*U)>>C)*T;F[R+1]=((E*U)>>C)*T;F[R+2]=((X*U)>>C)*T}else{F[R]=F[R+1]=F[R+2]=0}D-=N;E-=Z;X-=V;am-=A;N-=ap.r;Z-=ap.g;V-=ap.b;A-=ap.a;an=(K+((an=ah+aj+1)<L?an:L))<<2;ad+=(ap.r=F[an]);ai+=(ap.g=F[an+1]);P+=(ap.b=F[an+2]);M+=(ap.a=F[an+3]);D+=ad;E+=ai;X+=P;am+=M;ap=ap.next;N+=(J=af.r);Z+=(Q=af.g);V+=(S=af.b);A+=(T=af.a);ad-=J;ai-=Q;P-=S;M-=T;af=af.next;R+=4}K+=z}for(ah=0;ah<z;ah++){ai=P=M=ad=E=X=am=D=0;R=ah<<2;N=I*(J=F[R]);Z=I*(Q=F[R+1]);V=I*(S=F[R+2]);A=I*(T=F[R+3]);D+=ak*J;E+=ak*Q;X+=ak*S;am+=ak*T;W=ab;for(aq=0;aq<I;aq++){W.r=J;W.g=Q;W.b=S;W.a=T;W=W.next}O=z;for(aq=1;aq<=aj;aq++){R=(O+ah)<<2;D+=(W.r=(J=F[R]))*(ac=I-aq);E+=(W.g=(Q=F[R+1]))*ac;X+=(W.b=(S=F[R+2]))*ac;am+=(W.a=(T=F[R+3]))*ac;ad+=J;ai+=Q;P+=S;M+=T;W=W.next;if(aq<al){O+=z}}R=ah;ap=ab;af=H;for(ag=0;ag<B;ag++){an=R<<2;F[an+3]=T=(am*U)>>C;if(T>0){T=255/T;F[an]=((D*U)>>C)*T;F[an+1]=((E*U)>>C)*T;F[an+2]=((X*U)>>C)*T}else{F[an]=F[an+1]=F[an+2]=0}D-=N;E-=Z;X-=V;am-=A;N-=ap.r;Z-=ap.g;V-=ap.b;A-=ap.a;an=(ah+(((an=ag+I)<al?an:al)*z))<<2;D+=(ad+=(ap.r=F[an]));E+=(ai+=(ap.g=F[an+1]));X+=(P+=(ap.b=F[an+2]));am+=(M+=(ap.a=F[an+3]));ap=ap.next;N+=(J=af.r);Z+=(Q=af.g);V+=(S=af.b);A+=(T=af.a);ad-=J;ai-=Q;P-=S;M-=T;af=af.next;R+=z}}au.putImageData(ao,aa,Y)};function u(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}return v})();Events=(function(){var v=Array.prototype.slice;var u=/\s+/;var t={on:function(z,D,y){var x,B,A,w,C;if(!D){return this}z=z.split(u);x=this._callbacks||(this._callbacks={});while(B=z.shift()){C=x[B];A=C?C.tail:{};A.next=w={};A.context=y;A.callback=D;x[B]={tail:w,next:C?C.next:A}}return this},off:function(D,B,x){var w,E,y,A,z,C;if(!(E=this._callbacks)){return}if(!(D||B||x)){delete this._callbacks;return this}D=D?D.split(u):_.keys(E);while(w=D.shift()){y=E[w];delete E[w];if(!y||!(B||x)){continue}A=y.tail;while((y=y.next)!==A){z=y.callback;C=y.context;if((B&&z!==B)||(x&&C!==x)){this.on(w,z,C)}}}return this},trigger:function(z){var D,C,y,x,w,B,A;if(!(y=this._callbacks)){return this}B=y.all;z=z.split(u);A=v.call(arguments,1);while(D=z.shift()){if(C=y[D]){x=C.tail;while((C=C.next)!==x){C.callback.apply(C.context||this,A)}}if(C=B){x=C.tail;w=[D].concat(A);while((C=C.next)!==x){C.callback.apply(C.context||this,w)}}}return this}};t.bind=t.on;t.unbind=t.off;return t})();function l(v,x,w){if(x==="mouseenter"||x==="mouseleave"){var t=x==="mouseenter",y=t?"fromElement":"toElement";x=t?"mouseover":"mouseout";l(v,x,function(B){B=B||window.event;var A=B.target||B.srcElement,z=B.relatedTarget||B[y];if((v===A||e(v,A))&&!e(v,z)){return w.apply(this,arguments)}});return}if(v.addEventListener){v.addEventListener(x,w,false)}else{if(!w.$$guid){w.$$guid=l.guid++}if(!v.events){v.events={}}var u=v.events[x];if(!u){u=v.events[x]={};if(v["on"+x]){u[0]=v["on"+x]}}u[w.$$guid]=w;v["on"+x]=f}}l.guid=1;function n(t,v,u){if(t.removeEventListener){t.removeEventListener(v,u,false)}else{if(t.events&&t.events[v]){delete t.events[v][u.$$guid]}}}function f(w){var v=true;w=w||r(((this.ownerDocument||this.document||this).parentWindow||window).event);var t=this.events[w.type];for(var u in t){this.$$handleEvent=t[u];if(this.$$handleEvent(w)===false){v=false}}return v}function r(t){t.preventDefault=r.preventDefault;t.stopPropagation=r.stopPropagation;return t}r.preventDefault=function(){this.returnValue=false};r.stopPropagation=function(){this.cancelBubble=true};function e(t,u){return t.contains?t.contains(u):!!(t.compareDocumentPosition(u)&16)}(function(){var N=this;var C=N._;var V={};var U=Array.prototype,y=Object.prototype,I=Function.prototype;var F=U.slice,R=U.unshift,v=y.toString,A=y.hasOwnProperty;var ad=U.forEach,H=U.map,W=U.reduce,u=U.reduceRight,t=U.filter,S=U.every,G=U.some,E=U.indexOf,D=U.lastIndexOf,K=Array.isArray,x=Object.keys,X=I.bind;var ae=function(af){return new L(af)};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=ae}exports._=ae}else{N._=ae}ae.VERSION="1.3.3";var aa=ae.each=ae.forEach=function(ak,aj,ai){if(ak==null){return}if(ad&&ak.forEach===ad){ak.forEach(aj,ai)}else{if(ak.length===+ak.length){for(var ah=0,af=ak.length;ah<af;ah++){if(ah in ak&&aj.call(ai,ak[ah],ah,ak)===V){return}}}else{for(var ag in ak){if(ae.has(ak,ag)){if(aj.call(ai,ak[ag],ag,ak)===V){return}}}}}};ae.map=ae.collect=function(ai,ah,ag){var af=[];if(ai==null){return af}if(H&&ai.map===H){return ai.map(ah,ag)}aa(ai,function(al,aj,ak){af[af.length]=ah.call(ag,al,aj,ak)});if(ai.length===+ai.length){af.length=ai.length}return af};ae.reduce=ae.foldl=ae.inject=function(aj,ai,af,ah){var ag=arguments.length>2;if(aj==null){aj=[]}if(W&&aj.reduce===W){if(ah){ai=ae.bind(ai,ah)}return ag?aj.reduce(ai,af):aj.reduce(ai)}aa(aj,function(am,ak,al){if(!ag){af=am;ag=true}else{af=ai.call(ah,af,am,ak,al)}});if(!ag){throw new TypeError("Reduce of empty array with no initial value")}return af};ae.reduceRight=ae.foldr=function(aj,ai,af,ah){var ag=arguments.length>2;if(aj==null){aj=[]}if(u&&aj.reduceRight===u){if(ah){ai=ae.bind(ai,ah)}return ag?aj.reduceRight(ai,af):aj.reduceRight(ai)}var ak=ae.toArray(aj).reverse();if(ah&&!ag){ai=ae.bind(ai,ah)}return ag?ae.reduce(ak,ai,af,ah):ae.reduce(ak,ai)};ae.find=ae.detect=function(ai,ah,ag){var af;Q(ai,function(al,aj,ak){if(ah.call(ag,al,aj,ak)){af=al;return true}});return af};ae.filter=ae.select=function(ai,ah,ag){var af=[];if(ai==null){return af}if(t&&ai.filter===t){return ai.filter(ah,ag)}aa(ai,function(al,aj,ak){if(ah.call(ag,al,aj,ak)){af[af.length]=al}});return af};ae.reject=function(ai,ah,ag){var af=[];if(ai==null){return af}aa(ai,function(al,aj,ak){if(!ah.call(ag,al,aj,ak)){af[af.length]=al}});return af};ae.every=ae.all=function(ai,ah,ag){var af=true;if(ai==null){return af}if(S&&ai.every===S){return ai.every(ah,ag)}aa(ai,function(al,aj,ak){if(!(af=af&&ah.call(ag,al,aj,ak))){return V}});return !!af};var Q=ae.some=ae.any=function(ai,ah,ag){ah||(ah=ae.identity);var af=false;if(ai==null){return af}if(G&&ai.some===G){return ai.some(ah,ag)}aa(ai,function(al,aj,ak){if(af||(af=ah.call(ag,al,aj,ak))){return V}});return !!af};ae.include=ae.contains=function(ah,ag){var af=false;if(ah==null){return af}if(E&&ah.indexOf===E){return ah.indexOf(ag)!=-1}af=Q(ah,function(ai){return ai===ag});return af};ae.invoke=function(ag,ah){var af=F.call(arguments,2);return ae.map(ag,function(ai){return(ae.isFunction(ah)?ah||ai:ai[ah]).apply(ai,af)})};ae.pluck=function(ag,af){return ae.map(ag,function(ah){return ah[af]})};ae.max=function(ai,ah,ag){if(!ah&&ae.isArray(ai)&&ai[0]===+ai[0]){return Math.max.apply(Math,ai)}if(!ah&&ae.isEmpty(ai)){return -Infinity}var af={computed:-Infinity};aa(ai,function(am,aj,al){var ak=ah?ah.call(ag,am,aj,al):am;ak>=af.computed&&(af={value:am,computed:ak})});return af.value};ae.min=function(ai,ah,ag){if(!ah&&ae.isArray(ai)&&ai[0]===+ai[0]){return Math.min.apply(Math,ai)}if(!ah&&ae.isEmpty(ai)){return Infinity}var af={computed:Infinity};aa(ai,function(am,aj,al){var ak=ah?ah.call(ag,am,aj,al):am;ak<af.computed&&(af={value:am,computed:ak})});return af.value};ae.shuffle=function(ah){var af=[],ag;aa(ah,function(ak,ai,aj){ag=Math.floor(Math.random()*(ai+1));af[ai]=af[ag];af[ag]=ak});return af};ae.sortBy=function(ah,ai,af){var ag=ae.isFunction(ai)?ai:function(aj){return aj[ai]};return ae.pluck(ae.map(ah,function(al,aj,ak){return{value:al,criteria:ag.call(af,al,aj,ak)}}).sort(function(am,al){var ak=am.criteria,aj=al.criteria;if(ak===void 0){return 1}if(aj===void 0){return -1}return ak<aj?-1:ak>aj?1:0}),"value")};ae.groupBy=function(ah,ai){var af={};var ag=ae.isFunction(ai)?ai:function(aj){return aj[ai]};aa(ah,function(al,aj){var ak=ag(al,aj);(af[ak]||(af[ak]=[])).push(al)});return af};ae.sortedIndex=function(ak,aj,ah){ah||(ah=ae.identity);var af=0,ai=ak.length;while(af<ai){var ag=(af+ai)>>1;ah(ak[ag])<ah(aj)?af=ag+1:ai=ag}return af};ae.toArray=function(af){if(!af){return[]}if(ae.isArray(af)){return F.call(af)}if(ae.isArguments(af)){return F.call(af)}if(af.toArray&&ae.isFunction(af.toArray)){return af.toArray()}return ae.values(af)};ae.size=function(af){return ae.isArray(af)?af.length:ae.keys(af).length};ae.first=ae.head=ae.take=function(ah,ag,af){return(ag!=null)&&!af?F.call(ah,0,ag):ah[0]};ae.initial=function(ah,ag,af){return F.call(ah,0,ah.length-((ag==null)||af?1:ag))};ae.last=function(ah,ag,af){if((ag!=null)&&!af){return F.call(ah,Math.max(ah.length-ag,0))}else{return ah[ah.length-1]}};ae.rest=ae.tail=function(ah,af,ag){return F.call(ah,(af==null)||ag?1:af)};ae.compact=function(af){return ae.filter(af,function(ag){return !!ag})};ae.flatten=function(ag,af){return ae.reduce(ag,function(ah,ai){if(ae.isArray(ai)){return ah.concat(af?ai:ae.flatten(ai))}ah[ah.length]=ai;return ah},[])};ae.without=function(af){return ae.difference(af,F.call(arguments,1))};ae.uniq=ae.unique=function(aj,ai,ah){var af=ah?ae.map(aj,ah):aj;var ag=[];if(aj.length<3){ai=true}ae.reduce(af,function(ak,am,al){if(ai?ae.last(ak)!==am||!ak.length:!ae.include(ak,am)){ak.push(am);ag.push(aj[al])}return ak},[]);return ag};ae.union=function(){return ae.uniq(ae.flatten(arguments,true))};ae.intersection=ae.intersect=function(ag){var af=F.call(arguments,1);return ae.filter(ae.uniq(ag),function(ah){return ae.every(af,function(ai){return ae.indexOf(ai,ah)>=0})})};ae.difference=function(ag){var af=ae.flatten(F.call(arguments,1),true);return ae.filter(ag,function(ah){return !ae.include(af,ah)})};ae.zip=function(){var af=F.call(arguments);var ai=ae.max(ae.pluck(af,"length"));var ah=new Array(ai);for(var ag=0;ag<ai;ag++){ah[ag]=ae.pluck(af,""+ag)}return ah};ae.indexOf=function(aj,ah,ai){if(aj==null){return -1}var ag,af;if(ai){ag=ae.sortedIndex(aj,ah);return aj[ag]===ah?ag:-1}if(E&&aj.indexOf===E){return aj.indexOf(ah)}for(ag=0,af=aj.length;ag<af;ag++){if(ag in aj&&aj[ag]===ah){return ag}}return -1};ae.lastIndexOf=function(ah,ag){if(ah==null){return -1}if(D&&ah.lastIndexOf===D){return ah.lastIndexOf(ag)}var af=ah.length;while(af--){if(af in ah&&ah[af]===ag){return af}}return -1};ae.range=function(ak,ai,aj){if(arguments.length<=1){ai=ak||0;ak=0}aj=arguments[2]||1;var ag=Math.max(Math.ceil((ai-ak)/aj),0);var af=0;var ah=new Array(ag);while(af<ag){ah[af++]=ak;ak+=aj}return ah};var Y=function(){};ae.bind=function w(ai,ag){var ah,af;if(ai.bind===X&&X){return X.apply(ai,F.call(arguments,1))}if(!ae.isFunction(ai)){throw new TypeError}af=F.call(arguments,2);return ah=function(){if(!(this instanceof ah)){return ai.apply(ag,af.concat(F.call(arguments)))}Y.prototype=ai.prototype;var ak=new Y;var aj=ai.apply(ak,af.concat(F.call(arguments)));if(Object(aj)===aj){return aj}return ak}};ae.bindAll=function(ag){var af=F.call(arguments,1);if(af.length==0){af=ae.functions(ag)}aa(af,function(ah){ag[ah]=ae.bind(ag[ah],ag)});return ag};ae.memoize=function(ah,ag){var af={};ag||(ag=ae.identity);return function(){var ai=ag.apply(this,arguments);return ae.has(af,ai)?af[ai]:(af[ai]=ah.apply(this,arguments))}};ae.delay=function(ag,ah){var af=F.call(arguments,2);return setTimeout(function(){return ag.apply(null,af)},ah)};ae.defer=function(af){return ae.delay.apply(ae,[af,1].concat(F.call(arguments,1)))};ae.throttle=function(ah,ai){var ag,ak,al,am,aj,an;var af=ae.debounce(function(){aj=am=false},ai);return function(){ag=this;ak=arguments;var ao=function(){al=null;if(aj){ah.apply(ag,ak)}af()};if(!al){al=setTimeout(ao,ai)}if(am){aj=true}else{an=ah.apply(ag,ak)}af();am=true;return an}};ae.debounce=function(ag,ai,af){var ah;return function(){var al=this,ak=arguments;var aj=function(){ah=null;if(!af){ag.apply(al,ak)}};if(af&&!ah){ag.apply(al,ak)}clearTimeout(ah);ah=setTimeout(aj,ai)}};ae.once=function(ah){var af=false,ag;return function(){if(af){return ag}af=true;return ag=ah.apply(this,arguments)}};ae.wrap=function(af,ag){return function(){var ah=[af].concat(F.call(arguments,0));return ag.apply(this,ah)}};ae.compose=function(){var af=arguments;return function(){var ag=arguments;for(var ah=af.length-1;ah>=0;ah--){ag=[af[ah].apply(this,ag)]}return ag[0]}};ae.after=function(ag,af){if(ag<=0){return af()}return function(){if(--ag<1){return af.apply(this,arguments)}}};ae.keys=x||function(ah){if(ah!==Object(ah)){throw new TypeError("Invalid object")}var ag=[];for(var af in ah){if(ae.has(ah,af)){ag[ag.length]=af}}return ag};ae.values=function(af){return ae.map(af,ae.identity)};ae.functions=ae.methods=function(ah){var ag=[];for(var af in ah){if(ae.isFunction(ah[af])){ag.push(af)}}return ag.sort()};ae.extend=function(af){aa(F.call(arguments,1),function(ag){for(var ah in ag){af[ah]=ag[ah]}});return af};ae.pick=function(ag){var af={};aa(ae.flatten(F.call(arguments,1)),function(ah){if(ah in ag){af[ah]=ag[ah]}});return af};ae.defaults=function(af){aa(F.call(arguments,1),function(ag){for(var ah in ag){if(af[ah]==null){af[ah]=ag[ah]}}});return af};ae.clone=function(af){if(!ae.isObject(af)){return af}return ae.isArray(af)?af.slice():ae.extend({},af)};ae.tap=function(ag,af){af(ag);return ag};function ab(ai,ah,ag){if(ai===ah){return ai!==0||1/ai==1/ah}if(ai==null||ah==null){return ai===ah}if(ai._chain){ai=ai._wrapped}if(ah._chain){ah=ah._wrapped}if(ai.isEqual&&ae.isFunction(ai.isEqual)){return ai.isEqual(ah)}if(ah.isEqual&&ae.isFunction(ah.isEqual)){return ah.isEqual(ai)}var al=v.call(ai);if(al!=v.call(ah)){return false}switch(al){case"[object String]":return ai==String(ah);case"[object Number]":return ai!=+ai?ah!=+ah:(ai==0?1/ai==1/ah:ai==+ah);case"[object Date]":case"[object Boolean]":return +ai==+ah;case"[object RegExp]":return ai.source==ah.source&&ai.global==ah.global&&ai.multiline==ah.multiline&&ai.ignoreCase==ah.ignoreCase}if(typeof ai!="object"||typeof ah!="object"){return false}var am=ag.length;while(am--){if(ag[am]==ai){return true}}ag.push(ai);var ak=0,af=true;if(al=="[object Array]"){ak=ai.length;af=ak==ah.length;if(af){while(ak--){if(!(af=ak in ai==ak in ah&&ab(ai[ak],ah[ak],ag))){break}}}}else{if("constructor" in ai!="constructor" in ah||ai.constructor!=ah.constructor){return false}for(var aj in ai){if(ae.has(ai,aj)){ak++;if(!(af=ae.has(ah,aj)&&ab(ai[aj],ah[aj],ag))){break}}}if(af){for(aj in ah){if(ae.has(ah,aj)&&!(ak--)){break}}af=!ak}}ag.pop();return af}ae.isEqual=function(ag,af){return ab(ag,af,[])};ae.isEmpty=function(ag){if(ag==null){return true}if(ae.isArray(ag)||ae.isString(ag)){return ag.length===0}for(var af in ag){if(ae.has(ag,af)){return false}}return true};ae.isElement=function(af){return !!(af&&af.nodeType==1)};ae.isArray=K||function(af){return v.call(af)=="[object Array]"};ae.isObject=function(af){return af===Object(af)};ae.isArguments=function(af){return v.call(af)=="[object Arguments]"};if(!ae.isArguments(arguments)){ae.isArguments=function(af){return !!(af&&ae.has(af,"callee"))}}ae.isFunction=function(af){return v.call(af)=="[object Function]"};ae.isString=function(af){return v.call(af)=="[object String]"};ae.isNumber=function(af){return v.call(af)=="[object Number]"};ae.isFinite=function(af){return ae.isNumber(af)&&isFinite(af)};ae.isNaN=function(af){return af!==af};ae.isBoolean=function(af){return af===true||af===false||v.call(af)=="[object Boolean]"};ae.isDate=function(af){return v.call(af)=="[object Date]"};ae.isRegExp=function(af){return v.call(af)=="[object RegExp]"};ae.isNull=function(af){return af===null};ae.isUndefined=function(af){return af===void 0};ae.has=function(ag,af){return A.call(ag,af)};ae.noConflict=function(){N._=C;return this};ae.identity=function(af){return af};ae.times=function(ai,ah,ag){for(var af=0;af<ai;af++){ah.call(ag,af)}};ae.escape=function(af){return(""+af).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};ae.result=function(af,ah){if(af==null){return null}var ag=af[ah];return ae.isFunction(ag)?ag.call(af):ag};ae.mixin=function(af){aa(ae.functions(af),function(ag){O(ag,ae[ag]=af[ag])})};var P=0;ae.uniqueId=function(af){var ag=P++;return af?af+ag:ag};ae.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var M=/.^/;var z={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var Z in z){z[z[Z]]=Z}var B=/\\|'|\r|\n|\t|\u2028|\u2029/g;var T=/\\(\\|'|r|n|t|u2028|u2029)/g;var ac=function(af){return af.replace(T,function(ag,ah){return z[ah]})};ae.template=function(ak,aj,ah){ah=ae.defaults(ah||{},ae.templateSettings);var ai="__p+='"+ak.replace(B,function(al){return"\\"+z[al]}).replace(ah.escape||M,function(al,am){return"'+\n_.escape("+ac(am)+")+\n'"}).replace(ah.interpolate||M,function(al,am){return"'+\n("+ac(am)+")+\n'"}).replace(ah.evaluate||M,function(al,am){return"';\n"+ac(am)+"\n;__p+='"})+"';\n";if(!ah.variable){ai="with(obj||{}){\n"+ai+"}\n"}ai="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+ai+"return __p;\n";var ag=new Function(ah.variable||"obj","_",ai);if(aj){return ag(aj,ae)}var af=function(al){return ag.call(this,al,ae)};af.source="function("+(ah.variable||"obj")+"){\n"+ai+"}";return af};ae.chain=function(af){return ae(af).chain()};var L=function(af){this._wrapped=af};ae.prototype=L.prototype;var J=function(ag,af){return af?ae(ag).chain():ag};var O=function(af,ag){L.prototype[af]=function(){var ah=F.call(arguments);R.call(ah,this._wrapped);return J(ag.apply(ae,ah),this._chain)}};ae.mixin(ae);aa(["pop","push","reverse","shift","sort","splice","unshift"],function(af){var ag=U[af];L.prototype[af]=function(){var ah=this._wrapped;ag.apply(ah,arguments);var ai=ah.length;if((af=="shift"||af=="splice")&&ai===0){delete ah[0]}return J(ah,this._chain)}});aa(["concat","join","slice"],function(af){var ag=U[af];L.prototype[af]=function(){return J(ag.apply(this._wrapped,arguments),this._chain)}});L.prototype.chain=function(){this._chain=true;return this};L.prototype.value=function(){return this._wrapped}}).call(this);(function(w){var v=function(){return v};v.cssColor=function(x){if(x.length==3){return"rgb("+o(x[0])+","+o(x[1])+","+o(x[2])+")"}return"rgba("+o(x[0])+","+o(x[1])+","+o(x[2])+","+x[3]+")"};v.clamp=g=function(z,y,x){return(z<y?y:z>x?x:z)};v.opposite=function(y){if(!_.isArray(y)){y=v.parseColorString(y)}var x=v.rgb2hsl(y);x[0]=(x[0]+180)%360;x[1]=100-x[1];x[2]=100-x[2];var z=v.hsl2rgb(x);if(y.length===4){z.push(y[3])}return z};v.rgba2rgb=function(A){if(A.length===3||A[3]===255){return A}var C=A[0],B=A[1],x=A[2],y=A[3],z=[];z[0]=(y*C)+(255-y*255);z[1]=(y*B)+(255-y*255);z[2]=(y*x)+(255-y*255);return z};v.rgb2hex=function(x){x=v.rgba2rgb(x);return"#"+u(x[0])+u(x[1])+u(x[2])};v.hex2rgb=function(x){return v.parseColorString(x)};v.rgb2hsl=function(D){var x=D[0]/255,A=D[1]/255,E=D[2]/255,F=m(x,A,E),B=k(x,A,E),C,z,G,y=(F+B)/2;if(F==B){z=G=0}else{C=F-B;G=y>0.5?C/(2-F-B):C/(F+B);switch(m){case x:z=(A-E)/C+(A<E?6:0);break;case A:z=(E-x)/C+2;break;case E:z=(x-A)/C+4;break}z/=6}return[z,G*100,y*100]};v.hex2hsl=function(x){return v.rgb2hsl(v.hex2rgb(x))};v.hsl2rgb=function(D){var F,E,B;var x,A,C;var z=D[0],G=D[1]/100,y=D[2]/100;if(G==0){x=A=C=(y*255)}else{if(y<=0.5){E=y*(G+1)}else{E=y+G-y*G}F=y*2-E;B=z/360;x=t(F,E,B+1/3);A=t(F,E,B);C=t(F,E,B-1/3)}return[x,A,C]};function u(x){x=parseInt(x,10)||0;x=g(x,0,255).toString(16);if(x.length===1){x="0"+x}return x}function t(A,z,y){var x;if(y<0){y+=1}else{if(y>1){y-=1}}if(6*y<1){x=A+(z-A)*y*6}else{if(2*y<1){x=z}else{if(3*y<2){x=A+(z-A)*(2/3-y)*6}else{x=A}}}return 255*x}v.parseColorString=function(C){function G(L){var J=document.createElement("a");J.style.color=L;document.body.appendChild(J);var K=getComputedStyle(J).color;document.body.removeChild(J);return K}var D=false,x,A,E,F;C=G(C);var B=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(J){return[parseInt(J[1]),parseInt(J[2]),parseInt(J[3]),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(J){return[parseInt(J[1]),parseInt(J[2]),parseInt(J[3]),parseFloat(J[4])]}}];for(var z=0;z<B.length;z++){var I=B[z].re;var y=B[z].process;var H=I.exec(C);if(H){channels=y(H);x=channels[0];A=channels[1];E=channels[2];F=channels[3];D=true}}x=(x<0||isNaN(x))?0:((x>255)?255:x);A=(A<0||isNaN(A))?0:((A>255)?255:A);E=(E<0||isNaN(E))?0:((E>255)?255:E);F=(F<0||isNaN(F))?0:((F>1)?1:F);return D?[x,A,E,F]:[0,0,0,1]};w.util=v})(TeledrawCanvas);(function(){var u=0;var v=["ms","moz","webkit","o"];for(var t=0;t<v.length&&!window.requestAnimationFrame;++t){window.requestAnimationFrame=window[v[t]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[v[t]+"CancelAnimationFrame"]||window[v[t]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(A,x){var w=new Date().getTime();var y=Math.max(0,16-(w-u));var z=window.setTimeout(function(){A(w+y)},y);u=w+y;return z}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(w){clearTimeout(w)}}}());(function(w){w.canvases=[];var B=0;var v={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1000,strokeSoftness:0};var D={last:p,currentTool:p,previousTool:p,tool:p,mouseDown:j,mouseOver:j,width:p,height:p,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5000,enableZoom:d,enableWacomSupport:d,maxHistory:10,minStrokeSize:500,maxStrokeSize:10000,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8};var x;function A(){if(!x){var E;if(navigator.mimeTypes["application/x-wacomtabletplugin"]){E=document.createElement("embed");E.name=E.id="wacom-plugin";E.type="application/x-wacomtabletplugin"}else{E=document.createElement("object");E.classid="CLSID:092dfa86-5807-5a94-bf3b-5a53ba9e5308";E.codebase="fbWacomTabletPlugin.cab"}E.style.width=E.style.height="1px";E.style.top=E.style.left="-10000px";E.style.position="absolute";document.body.appendChild(E);x=E}}function C(){if(x&&x.penAPI){return x.penAPI.pressure}}function y(){if(x&&x.penAPI){return x.penAPI.pointerType===3}}var u=typeof _Canvas!=="undefined"?_Canvas:function(E,F){var G=document.createElement("canvas");if(E){G.width=E}if(F){G.height=F}return G};var t=function(I,T){var S=this,K=S.element=I.getContext?I:document.getElementById(I);state=S.state=_.extend({},D,T);if(typeof(new u()).getContext!="function"){throw new Error("Your browser does not support HTML canvas!");return false}if(state.enableWacomSupport){A()}K.width=state.width=state.displayWidth||state.width||K.width;K.height=state.height=state.displayHeight||state.height||K.height;state.fullWidth=state.fullWidth||state.width;state.fullHeight=state.fullHeight||state.height;if(state.width/state.height!==state.fullWidth/state.fullHeight){state.fullHeight=state.fullWidth*state.height/state.width}S._displayCanvas=K;if(state.enableZoom){S._canvas=new u(state.fullWidth,state.fullHeight)}else{S._canvas=K}S.history=new w.History(S);S.defaults();S.zoom(0);S.history.checkpoint();w.canvases[B++]=S;var N,J=p;l(K,"gesturestart",P);l(K,"gesturechange",G);l(K,"gestureend",H);l(K,"dblclick",F);l(K,"mouseenter",O);l(K,"mousedown",L);l(K,"touchstart",L);l(K,"mouseleave",R);l(window,"mousemove",Q);l(window,"touchmove",Q);function O(U){var V=E(U);state.tool.enter(state.mouseDown,V);state.last=V;state.mouseOver=d}function R(U){var V=E(U);state.tool.leave(state.mouseDown,V);state.mouseOver=j}function F(U){var V=E(U);state.tool.dblclick(V)}function Q(V){if(V.type=="touchmove"&&V.touches.length>1){return d}if(J=="touchmove"&&V.type=="mousemove"){return}if(V.target==K||state.mouseDown){var U=E(V);state.tool.move(state.mouseDown,state.last,U);state.last=U;S.trigger("mousemove",U,V);J=V.type;V.preventDefault();return j}}function L(V){var U=state.last=E(V);if(V.type=="touchstart"&&V.touches.length>1){return d}l(window,V.type==="mousedown"?"mouseup":"touchend",M);state.mouseDown=d;if(y()&&state.currentTool!=="eraser"){S.setTool("eraser");state.wacomWasEraser=true}state.tool.down(U);S.trigger("mousedown",U,V);document.onselectstart=function(){return j};V.preventDefault();return j}function M(U){n(window,U.type==="mouseup"?"mouseup":"touchend",M);if(U.type=="touchend"&&U.touches.length>1){return d}state.mouseDown=j;state.tool.up(state.last);S.trigger("mouseup",state.last,U);if(state.wacomWasEraser===true){S.previousTool();state.wacomWasEraser=false}document.onselectstart=function(){return d};U.preventDefault();return j}function P(U){if(state.tool.name=="grab"){N=state.currentZoom}}function G(U){if(state.tool.name=="grab"){var V=state.last;S.zoom(N*U.scale,V.xd,V.yd)}U.preventDefault();return j}function H(U){}function E(Z){var Y=K.offsetLeft,X=K.offsetTop,V=Z.pageX||Z.touches&&Z.touches[0].pageX,U=Z.pageY||Z.touches&&Z.touches[0].pageY,W=C();return{x:o((V-Y)/state.currentZoom)+state.currentOffset.x||0,y:o((U-X)/state.currentZoom)+state.currentOffset.y||0,xd:o(V-Y)||0,yd:o(U-X)||0,p:W}}};var z=t.prototype;z.setRGBAArrayColor=function(F){var G=this.state;if(F.length===4){G.globalAlpha=F.pop()}for(var E=F.length;E<3;++E){F.push(0)}G.color=F;this.updateTool()};z.updateTool=function(){var E=1+o(c(this.state.strokeSize/1000,2));var F=o(c(this.state.strokeSoftness,1.3)/300*E);this.state.lineWidth=E;this.state.shadowBlur=F};z.updateDisplayCanvas=function(H){if(this.state.enableZoom===false){return this}var L=this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d")),K=this.state.currentOffset,I=this.state.currentZoom,F=L.canvas.width,J=L.canvas.height,E=o(F/I),G=o(J/I);L.clearRect(0,0,F,J);if(H!==true){this.trigger("display.update:before")}L.drawImage(this._canvas,K.x,K.y,E,G,0,0,F,J);if(H!==true){this.trigger("display.update:after")}};z.canvas=function(){return this._canvas};z.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))};z.cursor=function(F){if(!F){F="default"}var E=F.split(/,\s*/);do{F=E.shift();this.element.style.cursor=F}while(F.length&&this.element.style.cursor!=F);return this};z.clear=function(G){var F=this,E=F.ctx();E.clearRect(0,0,E.canvas.width,E.canvas.height);if(G!==d){F.history.checkpoint()}F.updateDisplayCanvas();return F};z.defaults=function(){var E=this;E.setTool("pencil");E.setAlpha(v.alpha);E.setColor(v.color);E.setStrokeSize(v.strokeSize);E.setStrokeSoftness(v.strokeSoftness);return E};z.toDataURL=function(E,I,G,H){if(G&&H){G=parseInt(G);H=parseInt(H);E=E!==s?E:0;I=I!==s?I:0;var F=this.getTempCanvas(G,H);F.getContext("2d").drawImage(this.canvas(),E,I,G,H,0,0,G,H);return F.toDataURL()}return this.canvas().toDataURL()};z.getTempCanvas=function(E,F){return new u(E||this._canvas.width,F||this._canvas.height)};z.fromDataURL=z.fromImageURL=function(H,E){var G=this,F=new Image();F.onload=function(){G.clear(d);G.ctx().drawImage(F,0,0);G.updateDisplayCanvas();if(typeof E=="function"){E.call(G)}};F.src=H;return G};z.getImageData=function(){var E=this.ctx();return E.getImageData(0,0,E.canvas.width,E.canvas.height)};z.putImageData=function(E){this.ctx().putImageData(E,0,0);this.updateDisplayCanvas();return this};z.getColor=function(){return this.state.color.slice()};z.setColor=function(E){if(!_.isArray(E)){E=w.util.parseColorString(E)}this.setRGBAArrayColor(E);return this};z.setAlpha=function(E){this.state.globalAlpha=g(E,0,1);return this};z.getAlpha=function(){return this.state.globalAlpha};z.setStrokeSize=function(E){this.state.strokeSize=g(E,this.state.minStrokeSize,this.state.maxStrokeSize);this.updateTool();return this};z.setStrokeSoftness=function(E){this.state.strokeSoftness=g(E,this.state.minStrokeSoftness,this.state.maxStrokeSoftness);this.updateTool();return this};z.setTool=function(E){if(this.state.currentTool===E){return this}this.state.previousTool=this.state.currentTool;this.state.currentTool=E;if(!w.tools[E]){throw new Error('Tool "'+E+'" not defined.')}this.state.tool=new w.tools[E](this);this.updateTool();return this};z.previousTool=function(){return this.setTool(this.state.previousTool)};z.undo=function(){this.history.undo();return this};z.redo=function(){this.history.redo();return this};z.resize=function(F,H){if(this.state.enableZoom===false){return this}var G=this,E=Math.round(G._canvas.width/G._canvas.height*100)/100,I=Math.round(F/H*100)/100;if(E!==I){throw new Error("Not the same aspect ratio!")}G._displayCanvas.width=G.state.width=F;G._displayCanvas.height=G.state.height=H;return G.zoom(G.state.currentZoom)};z.zoom=function(H,J,I){if(arguments.length===0){return this.state.currentZoom}if(this.state.enableZoom===false){return this}var L=this,G=0,F=0,K=L.state.currentZoom,M=L._displayCanvas.width,E=L._displayCanvas.height;J=g(J||M/2,0,M);I=g(I||E/2,0,E);H=g(H||0,M/L._canvas.width,L.state.maxZoom);if(H!==K){if(H>K){G=-(M/K-M/H)/2-(J-M/2)/K;F=-(E/K-E/H)/2-(I-E/2)/K}else{if(H<K){G=(M/H-M/K)/2;F=(E/H-E/K)/2}}G*=H;F*=H}L.state.currentZoom=H;L.trigger("zoom",H,K);L.pan(G,F);L.updateDisplayCanvas();return L};z.pan=function(H,G,I){if(arguments.length===0){return this.state.currentOffset}if(this.state.enableZoom===false){return this}var M=this,L=M.state.currentZoom,F=M.state.currentOffset.x,E=M.state.currentOffset.y,K=M._canvas.width-o(M._displayCanvas.width/L),J=M._canvas.height-o(M._displayCanvas.height/L);H=I===d?H/L:F-(H||0)/L;G=I===d?G/L:E-(G||0)/L;H=o(g(H,0,K));G=o(g(G,0,J));M.state.currentOffset={x:H,y:G};M.trigger("pan",M.state.currentOffset);M.updateDisplayCanvas();return M};_.extend(z,Events);w.api=t})(TeledrawCanvas);(function(u){var t=function(v){this.canvas=v;this.rev=0;this.clear()};t.prototype.clear=function(){this.past=[];this.current=null;this.future=[]};t.prototype.checkpoint=function(){if(this.past.length>this.canvas.state.maxHistory){this.past.shift()}if(this.current){this.past.push(this.current)}this.current=new u.Snapshot(this.canvas);this.future=[];this.rev++};t.prototype.undo=function(){if(this._move(this.past,this.future)){this.rev--}};t.prototype.redo=function(){if(this._move(this.future,this.past)){this.rev++}};t.prototype._move=function(w,v){if(!w.length){return j}if(!this.current){return j}v.push(this.current);this.current=w.pop();this.current.restore();return d};u.History=t})(TeledrawCanvas);(function(u){var t=function(v){this.canvas=v;this._snapshotBufferCanvas()};t.prototype.restore=function(x){var v,w;if(x){v=x.tl;w=x.br}else{v={x:0,y:0};w={x:this.canvas.canvas().width,y:this.canvas.canvas().height}}this._restoreBufferCanvas(v,w);this.canvas.updateDisplayCanvas(v,w)};t.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()};t.prototype._snapshotBufferCanvas=function(){this.buffer=this.canvas.getTempCanvas();this.buffer.getContext("2d").drawImage(this.canvas.canvas(),0,0)};t.prototype._restoreBufferCanvas=function(y,z){var x=this.canvas.ctx();var v=z.x-y.x,A=z.y-y.y;if(v===0||A===0){return}x.clearRect(y.x,y.y,v,A);x.drawImage(this.buffer,y.x,y.y,v,A,y.x,y.y,v,A)};t.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()};t.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)};u.Snapshot=t})(TeledrawCanvas);(function(u){var t=function(v){this.canvas=v};t.prototype.start=function(v){};t.prototype.move=function(w,v){};t.prototype.end=function(){};t.prototype.draw=function(){};t.prototype.save=function(){this.snapshot=new u.Snapshot(this.canvas)};t.prototype.restore=function(){this.snapshot.restore(this)};u.Stroke=t})(TeledrawCanvas);(function(u){var t=function(){};t.prototype.down=function(v){};t.prototype.up=function(v){};t.prototype.move=function(v,x,w){};t.prototype.dblclick=function(v){};t.prototype.enter=function(v,w){};t.prototype.leave=function(v,w){};t.prototype.keydown=function(w,v){};t.prototype.keyup=function(w,v){};t.prototype.preview=function(){};t.prototype.alt_down=function(){};t.prototype.alt_up=function(){};t.createTool=function(w,z,x){var y=function(A){this.canvas=A;this.ctx=A.ctx();this.color=A.getColor();this.color.push(A.getAlpha());this.points=[];this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height};this.br={x:0,y:0};this.tool={}};y.prototype=new u.Stroke();var v=function(A){this.canvas=A;A.cursor(z);this.name=w;this.cursor=z||"default";this.currentStroke=null;if(typeof x=="function"){x.call(this)}};v.prototype=new t();v.prototype.down=function(A){this.currentStroke=new y(this.canvas);this.currentStroke.tool=this;this.currentStroke.save();this.currentStroke.points.push(A);this.currentStroke.start(A);this._updateBoundaries(A);this.draw()};v.prototype.move=function(A,C,B){if(A&&this.currentStroke){this.currentStroke.points.push(B);this.currentStroke.move(C,B);this._updateBoundaries(B);this.draw()}};v.prototype.up=function(A){if(this.currentStroke){this.currentStroke.end(A);this.draw();this.currentStroke=null;this.canvas.history.checkpoint()}this.canvas.trigger("tool.up")};v.prototype.draw=function(){this.currentStroke.ctx.save();this.currentStroke.restore();this.currentStroke.draw();this.canvas.updateDisplayCanvas(this.currentStroke.tl,this.currentStroke.br);this.currentStroke.ctx.restore()};v.prototype._updateBoundaries=function(D){var C=this.currentStroke,A=C.ctx.canvas,B=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;if(D.x-B<C.tl.x){C.tl.x=g(o(D.x-B),0,A.width)}if(D.x+B>C.br.x){C.br.x=g(o(D.x+B),0,A.width)}if(D.y-B<C.tl.y){C.tl.y=g(o(D.y-B),0,A.height)}if(D.y+B>C.br.y){C.br.y=g(o(D.y+B),0,A.height)}};v.stroke=y;y.tool=v;u.tools[w]=v;return v};u.Tool=t;u.tools={}})(TeledrawCanvas);(function(w){var t=w.Tool.createTool("ellipse","crosshair"),u=t.stroke.prototype;u.bgColor=[255,255,255];u.bgAlpha=0;u.lineWidth=1;u.start=function(x){this.first=x};u.move=function(y,x){this.second=x};u.end=function(x){this.second=x};u.draw=function(){if(!this.first||!this.second){return}var H=this,F=H.first.x,E=H.first.y,G=H.second.x-F,C=H.second.y-E,I=H.ctx,z=H.canvas.state,J=z.shadowOffset,B=z.shadowBlur,D=z.lineWidth,A=w.util.cssColor(z.color);I.lineJoin=I.lineCap="round";I.globalAlpha=z.globalAlpha;I.fillStyle=I.strokeStyle=A;I.miterLimit=100000;if(H.tool.shiftKey){C=H.second.y>E?h(G):-h(G)}if(H.tool.fill){v(I,F,E,G,C);I.fill()}else{if(B>0){I.shadowColor=A;I.shadowOffsetX=I.shadowOffsetY=J;I.shadowBlur=B;I.translate(-J,-J)}I.lineWidth=D;v(I,F,E,G,C);I.stroke()}};function v(B,z,E,A,C){var D=0.5522848;ox=(A/2)*D,oy=(C/2)*D,xe=z+A,ye=E+C,xm=z+A/2,ym=E+C/2;B.beginPath();B.moveTo(z,ym);B.bezierCurveTo(z,ym-oy,xm-ox,E,xm,E);B.bezierCurveTo(xm+ox,E,xe,ym-oy,xe,ym);B.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);B.bezierCurveTo(xm-ox,ye,z,ym+oy,z,ym);B.closePath()}})(TeledrawCanvas);(function(u){var t=u.Tool.createTool("eraser","crosshair");t.stroke.prototype.lineWidth=1;t.stroke.prototype.lineCap="round";t.stroke.prototype.draw=function(){this.color=[255,255,255,255];this.ctx.globalCompositeOperation="destination-out";u.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(v){var t=function(){this.previewContainer=document.createElement("div");_.extend(this.previewContainer.style,{position:"absolute",width:"10px",height:"10px",border:"1px solid black",display:"none"});document.body.appendChild(this.previewContainer);if(this.canvas.state.mouseOver){this.previewContainer.style.display="block"}};var u=v.Tool.createTool("eyedropper","crosshair",t);u.prototype.pick=function(A){var x=this.previewContainer,B,z=this.canvas.element.offsetLeft,y=this.canvas.element.offsetTop,w=this.canvas._displayCtx.getImageData(A.xd,A.yd,1,1).data;this.color=v.util.rgba2rgb(Array.prototype.slice.call(w));var B=v.util.rgb2hsl(this.color)[2];_.extend(x.style,{left:(z+A.xd+15)+"px",top:(y+A.yd+5)+"px",background:v.util.cssColor(this.color),"border-color":B>=50?"#000":"#888"});if(this.canvas.state.mouseOver){x.style.display="none";x.offsetHeight;x.style.display="block"}else{x.style.display="none"}};u.prototype.enter=function(){this.previewContainer.style.display="block"};u.prototype.leave=function(){this.previewContainer.style.display="none"};u.prototype.move=function(y,x,w){this.pick(w)};u.prototype.down=function(w){this.pick(w)};u.prototype.up=function(w){this.pick(w);this.canvas.setColor(this.color);this.previewContainer.parentNode.removeChild(this.previewContainer);this.canvas.previousTool()}})(TeledrawCanvas);(function(A){var v=A.Tool.createTool("fill","crosshair");var t=Math.abs;v.blur=true;v.stroke.prototype.bgColor=[255,255,255];v.stroke.prototype.bgAlpha=255;v.stroke.prototype.end=function(G){var K=this.ctx.canvas.width,F=this.ctx.canvas.height;var C=this.ctx.getImageData(0,0,K,F);var H=this.ctx.createImageData(K,F);var D=this.color;D[3]*=255;z(C.data,H.data,G,K,F,this.color);this.tmp_canvas=this.canvas.getTempCanvas();var J=this.tmp_canvas.getContext("2d");J.putImageData(H,0,0);if(v.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);var I=J.getImageData(0,0,K,F);for(var E=0,B=I.data.length;E<B;E+=4){if(I.data[E+3]/255>0.2){I.data[E]=D[0];I.data[E+1]=D[1];I.data[E+2]=D[2];I.data[E+3]=Math.min(D[3],I.data[E+3]*3)}}J.putImageData(I,0,0)}};v.stroke.prototype.draw=function(){if(this.tmp_canvas){this.ctx.drawImage(this.tmp_canvas,0,0)}};function z(E,D,S,K,R,L){var F=[[S.x,S.y]];var M=x(E,S.x,S.y,K);var Q=v.tolerance;var G,B;var P,O,N,J,H,C;var I=A.util.opposite(M);I[3]/=2;while(F.length){N=F.pop();J=N[0];C=H=N[1];while(C>=0&&w(x(E,J,C,K),M)){C--}C++;G=B=false;while(C<R&&w(x(E,J,C,K),M)){u(E,J,C,K,I);u(D,J,C,K,L);if(!G&&J>0&&w(x(E,J-1,C,K),M)){F.push([J-1,C]);G=true}else{if(G&&J>0&&w(x(E,J-1,C,K),M)){G=false}}if(!B&&J<K-1&&w(x(E,J+1,C,K),M)){F.push([J+1,C]);B=true}else{if(B&&J<K-1&&w(x(E,J+1,C,K),M)){B=false}}C++}}}function x(D,B,F,C){var E=(F*C+B)*4;return[D[E],D[E+1],D[E+2],D[E+3]]}function u(E,B,G,C,D){var F=(G*C+B)*4;E[F]=D[0];E[F+1]=D[1];E[F+2]=D[2];E[F+3]=D[3]}function y(C,B){return t(C[0]-B[0])+t(C[1]-B[1])+t(C[2]-B[2])+t(C[3]-B[3])}function w(C,B){return y(C,B)<5}})(TeledrawCanvas);(function(w){var u="hand, grab, -moz-grab, -webkit-grab, move",t="grabbing, -moz-grabbing, -webkit-grabbing, move";var v=w.Tool.createTool("grab",u);v.prototype.move=function(A,z,y){var x=this;if(A){clearTimeout(this._clearDeltasId);cancelAnimationFrame(this._momentumId);this.dx=y.xd-z.xd;this.dy=y.yd-z.yd;this.canvas.pan(this.dx,this.dy);this._clearDeltasId=setTimeout(function(){x.dx=x.dy=0},100)}};v.prototype.down=function(x){cancelAnimationFrame(this._momentumId);this.canvas.cursor(t)};v.prototype.up=function(x){cancelAnimationFrame(this._momentumId);this.momentum(this.dx,this.dy);this.dx=this.dy=0;this.canvas.cursor(u)};v.prototype.dblclick=function(x){cancelAnimationFrame(this._momentumId);this.dx=this.dy=0;this.canvas.zoom(this.canvas.state.currentZoom*2,x.xd,x.yd)};v.prototype.momentum=function(z,x){var y=this;if(Math.abs(z)>=1||Math.abs(x)>=1){z/=1.1;x/=1.1;this.canvas.pan(z,x);this._momentumId=requestAnimationFrame(function(){y.momentum(z,x)})}}})(TeledrawCanvas);(function(u){var t=u.Tool.createTool("line","crosshair");t.stroke.prototype.lineWidth=1;t.stroke.prototype.lineCap="round";t.stroke.prototype.bgColor=[255,255,255];t.stroke.prototype.bgAlpha=0;t.stroke.prototype.start=function(v){this.first=v};t.stroke.prototype.move=function(w,v){this.second=v};t.stroke.prototype.end=function(v){this.second=v};t.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var B=_.extend({},this.first),z=_.extend({},this.second),w,v,C,A=Math.PI;if(this.tool.shiftKey){v=z.x-B.x;C=z.y-B.y;w=Math.atan2(C,v);if((w>=-A*7/8&&w<-A*5/8)||(w>=-A*3/8&&w<-A/8)){z.y=B.y-Math.abs(v)}else{if((w>=-A*5/8&&w<-A*3/8)||(w>=A*3/8&&w<A*5/8)){z.x=B.x}else{if((w>=A/8&&w<A*3/8)||(w>=A*5/8&&w<A*7/8)){z.y=B.y+Math.abs(v)}else{z.y=B.y}}}}this.points=[B,z];u.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(w){var t=w.Tool.createTool("pencil","crosshair");t.stroke.prototype.lineWidth=1;t.stroke.prototype.lineCap="round";t.stroke.prototype.smoothing=true;t.stroke.prototype.draw=function(){var x=this.canvas.state,E=this.ctx,D=this.points,F=x.shadowOffset,A=x.shadowBlur,B=x.lineWidth,z=w.util.cssColor(x.color);E.globalAlpha=x.globalAlpha;E.fillStyle=E.strokeStyle=z;E.miterLimit=100000;if(A>0){E.shadowColor=z;E.shadowOffsetX=E.shadowOffsetY=F;E.shadowBlur=A;E.translate(-F,-F)}if(D.length===1){switch(this.lineCap){case"round":E.beginPath();if(D[0].p){B*=D[0].p}E.arc(D[0].x,D[0].y,B/2,0,2*Math.PI,true);E.closePath();E.fill();break;case"square":E.fillRect(D[0].x-B/2,D[0].y-B/2,B,B)}}else{if(D.length>1){E.lineJoin="round";E.lineCap=this.lineCap;E.lineWidth=B;if(D[0].p){var C=v(D,B);var y=C.left.length;C.right.reverse();E.beginPath();u(E,C.left,this.smoothing);E.lineTo(C.right[0].x,C.right[0].y);u(E,C.right,this.smoothing);E.lineTo(C.left[0].x,C.left[0].y);E.closePath();E.fill()}else{E.beginPath();u(E,D,this.smoothing);E.stroke()}}}};function v(G,D){var H={left:[],right:[]},C=G.length,x=G[0],E=new a(x.x,x.y),y,F,B;for(var A=1,z=C;A<z;++A){y=G[A];F=new a(y.x,y.y);B=a.subtract(F,E);B.rotateZ(Math.PI/2).unit().scale(x.p*D).add(E);H.left.push({x:B.x,y:B.y});B=a.subtract(F,E);B.rotateZ(-Math.PI/2).unit().scale(x.p*D).add(E);H.right.push({x:B.x,y:B.y});x=y;E=F}return H}function u(F,E,A){F.moveTo(E[0].x,E[0].y);var y=E[0],C=null,G=y,B=E.length;for(var z=1,x=B;z<x;++z){G=E[z];if(C&&(C.x==G.x||C.y==G.y)){G.x+=0.1;G.y+=0.1}if(A){var D={x:(y.x+G.x)/2,y:(y.y+G.y)/2};F.quadraticCurveTo(y.x,y.y,D.x,D.y)}else{F.lineTo(G.x,G.y)}C=y;y=E[z]}if(A){F.quadraticCurveTo(y.x,y.y,G.x,G.y)}}})(TeledrawCanvas);function a(t,v,u){this.x=t||0;this.y=v||0;this.z=u||0}a.prototype.add=function(t){this.x+=t.x;this.y+=t.y;this.z+=t.z;return this};a.prototype.scale=function(t){this.x*=t;this.y*=t;this.z*=t;return this};a.prototype.direction=function(){return Math.atan2(this.y,this.x)};a.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};a.prototype.addToMagnitude=function(v){v=v||0;var t=this.magnitude();var u=Math.sqrt((v+t)/t);this.x*=u;this.y*=u;this.z*=u;return this};a.prototype.unit=function(){return this.scale(1/this.magnitude())};a.prototype.rotateZ=function(u){var w=this.x;var v=this.y;this.x=w*Math.cos(u)-v*Math.sin(u);this.y=w*Math.sin(u)+v*Math.cos(u);return this};a.add=function(u,t){return new a(u.x+t.x,u.y+t.y,u.z+t.z)};a.subtract=function(u,t){return new a(u.x-t.x,u.y-t.y,u.z-t.z)};a.dot=function(u,t){return u.x*t.x+u.y*t.y+u.z*t.z};a.scale=function(t,u){return new a(t.x*u,t.y*u,t.z*u)};a.cross=function(u,t){return new a(u.y*t.z-t.y*u.z,u.z*t.x-t.z*u.x,u.x*t.y-t.x*u.y)};a.average=function(){var v,t=new a(),u=arguments;if(arguments[0].constructor.toString().indexOf("Array")!=-1){u=arguments[0]}v=u.length;for(i=0;i<v;i++){t.add(a.create(u[i]))}return t.scale(1/v)};a.create=function(t){return new a(t.x,t.y,t.z)};(function(v){var u=v.Tool.createTool("rectangle","crosshair");u.stroke.prototype.bgColor=[255,255,255];u.stroke.prototype.bgAlpha=0;u.stroke.prototype.lineWidth=1;u.stroke.prototype.start=function(w){this.first=w};u.stroke.prototype.move=function(x,w){this.second=w};u.stroke.prototype.end=function(w){this.second=w};u.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var B=this.first,y=_.extend({},this.second),E=this.ctx,x=this.canvas.state,F=x.shadowOffset,A=x.shadowBlur,C=x.lineWidth,z=v.util.cssColor(x.color);E.lineJoin=E.lineCap="round";E.globalAlpha=x.globalAlpha;E.fillStyle=E.strokeStyle=z;E.miterLimit=100000;if(this.tool.shiftKey){var D=Math.abs(y.x-B.x);y.y=B.y+(y.y>B.y?D:-D)}if(this.tool.fill){t(E,B,y);E.fill()}else{if(A>0){E.shadowColor=z;E.shadowOffsetX=E.shadowOffsetY=F;E.shadowBlur=A;E.translate(-F,-F)}E.lineWidth=C;t(E,B,y);E.stroke()}};function t(w,y,x){w.beginPath();w.moveTo(y.x,y.y);w.lineTo(x.x,y.y);w.lineTo(x.x,x.y);w.lineTo(y.x,x.y);w.lineTo(y.x,y.y)}})(TeledrawCanvas)})();