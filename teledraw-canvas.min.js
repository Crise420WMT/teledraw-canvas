/*!

	Teledraw TeledrawCanvas
	Version 0.7.2 (http://semver.org/)
	Copyright 2012 Cameron Lakenen
	
	Permission is hereby granted, free of charge, to any person obtaining
	a copy of this software and associated documentation files (the
	"Software"), to deal in the Software without restriction, including
	without limitation the rights to use, copy, modify, merge, publish,
	distribute, sublicense, and/or sell copies of the Software, and to
	permit persons to whom the Software is furnished to do so, subject to
	the following conditions:
	
	The above copyright notice and this permission notice shall be
	included in all copies or substantial portions of the Software.
	
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
	OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
	WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

**/
(function(){var c=true,k=false,f=null,j,o=Math,q=o.abs,h=o.floor,p=o.round,e=o.min,n=o.max,i=o.pow,g;TeledrawCanvas=function(r,s){return new TeledrawCanvas.api(r,s)};stackBlurCanvasRGBA=(function(){var r=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var u=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var t=function(E,ah){if(isNaN(ah)||ah<1){return}ah|=0;var Y=0,W=0,v=E.width,z=E.height;var ar=E.getContext("2d");var am;try{try{am=ar.getImageData(Y,W,v,z)}catch(aq){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");am=ar.getImageData(Y,W,v,z)}catch(aq){alert("Cannot access local image");throw new Error("unable to access local image data: "+aq);return}}}catch(aq){alert("Cannot access image");throw new Error("unable to access image data: "+aq)}var D=am.data;var af,ae,ao,al,M,P,I,B,C,V,ak,L,X,T,w,ab,ag,N,K,H,O,Q,R,aa;var ap=ah+ah+1;var ac=v<<2;var J=v-1;var aj=z-1;var G=ah+1;var ai=G*(G+1)/2;var Z=new s();var U=Z;for(ao=1;ao<ap;ao++){U=U.next=new s();if(ao==G){var F=U}}U.next=Z;var an=null;var ad=null;I=P=0;var S=r[ah];var A=u[ah];for(ae=0;ae<z;ae++){ab=ag=N=K=B=C=V=ak=0;L=G*(H=D[P]);X=G*(O=D[P+1]);T=G*(Q=D[P+2]);w=G*(R=D[P+3]);B+=ai*H;C+=ai*O;V+=ai*Q;ak+=ai*R;U=Z;for(ao=0;ao<G;ao++){U.r=H;U.g=O;U.b=Q;U.a=R;U=U.next}for(ao=1;ao<G;ao++){al=P+((J<ao?J:ao)<<2);B+=(U.r=(H=D[al]))*(aa=G-ao);C+=(U.g=(O=D[al+1]))*aa;V+=(U.b=(Q=D[al+2]))*aa;ak+=(U.a=(R=D[al+3]))*aa;ab+=H;ag+=O;N+=Q;K+=R;U=U.next}an=Z;ad=F;for(af=0;af<v;af++){D[P+3]=R=(ak*S)>>A;if(R!=0){R=255/R;D[P]=((B*S)>>A)*R;D[P+1]=((C*S)>>A)*R;D[P+2]=((V*S)>>A)*R}else{D[P]=D[P+1]=D[P+2]=0}B-=L;C-=X;V-=T;ak-=w;L-=an.r;X-=an.g;T-=an.b;w-=an.a;al=(I+((al=af+ah+1)<J?al:J))<<2;ab+=(an.r=D[al]);ag+=(an.g=D[al+1]);N+=(an.b=D[al+2]);K+=(an.a=D[al+3]);B+=ab;C+=ag;V+=N;ak+=K;an=an.next;L+=(H=ad.r);X+=(O=ad.g);T+=(Q=ad.b);w+=(R=ad.a);ab-=H;ag-=O;N-=Q;K-=R;ad=ad.next;P+=4}I+=v}for(af=0;af<v;af++){ag=N=K=ab=C=V=ak=B=0;P=af<<2;L=G*(H=D[P]);X=G*(O=D[P+1]);T=G*(Q=D[P+2]);w=G*(R=D[P+3]);B+=ai*H;C+=ai*O;V+=ai*Q;ak+=ai*R;U=Z;for(ao=0;ao<G;ao++){U.r=H;U.g=O;U.b=Q;U.a=R;U=U.next}M=v;for(ao=1;ao<=ah;ao++){P=(M+af)<<2;B+=(U.r=(H=D[P]))*(aa=G-ao);C+=(U.g=(O=D[P+1]))*aa;V+=(U.b=(Q=D[P+2]))*aa;ak+=(U.a=(R=D[P+3]))*aa;ab+=H;ag+=O;N+=Q;K+=R;U=U.next;if(ao<aj){M+=v}}P=af;an=Z;ad=F;for(ae=0;ae<z;ae++){al=P<<2;D[al+3]=R=(ak*S)>>A;if(R>0){R=255/R;D[al]=((B*S)>>A)*R;D[al+1]=((C*S)>>A)*R;D[al+2]=((V*S)>>A)*R}else{D[al]=D[al+1]=D[al+2]=0}B-=L;C-=X;V-=T;ak-=w;L-=an.r;X-=an.g;T-=an.b;w-=an.a;al=(af+(((al=ae+G)<aj?al:aj)*v))<<2;B+=(ab+=(an.r=D[al]));C+=(ag+=(an.g=D[al+1]));V+=(N+=(an.b=D[al+2]));ak+=(K+=(an.a=D[al+3]));an=an.next;L+=(H=ad.r);X+=(O=ad.g);T+=(Q=ad.b);w+=(R=ad.a);ab-=H;ag-=O;N-=Q;K-=R;ad=ad.next;P+=v}}ar.putImageData(am,Y,W)};function s(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}return t})();Events=(function(){var t=Array.prototype.slice;var s=/\s+/;var r={on:function(x,B,w){var v,z,y,u,A;if(!B){return this}x=x.split(s);v=this._callbacks||(this._callbacks={});while(z=x.shift()){A=v[z];y=A?A.tail:{};y.next=u={};y.context=w;y.callback=B;v[z]={tail:u,next:A?A.next:y}}return this},off:function(B,z,v){var u,C,w,y,x,A;if(!(C=this._callbacks)){return}if(!(B||z||v)){delete this._callbacks;return this}B=B?B.split(s):_.keys(C);while(u=B.shift()){w=C[u];delete C[u];if(!w||!(z||v)){continue}y=w.tail;while((w=w.next)!==y){x=w.callback;A=w.context;if((z&&x!==z)||(v&&A!==v)){this.on(u,x,A)}}}return this},trigger:function(x){var B,A,w,v,u,z,y;if(!(w=this._callbacks)){return this}z=w.all;x=x.split(s);y=t.call(arguments,1);while(B=x.shift()){if(A=w[B]){v=A.tail;while((A=A.next)!==v){A.callback.apply(A.context||this,y)}}if(A=z){v=A.tail;u=[B].concat(y);while((A=A.next)!==v){A.callback.apply(A.context||this,u)}}}return this}};r.bind=r.on;r.unbind=r.off;return r})();function d(t,v,u){if(v==="mouseenter"||v==="mouseleave"){var r=v==="mouseenter",w=r?"fromElement":"toElement";v=r?"mouseover":"mouseout";d(t,v,function(z){z=z||window.event;var y=z.target||z.srcElement,x=z.relatedTarget||z[w];if((t===y||b(t,y))&&!b(t,x)){return u.apply(this,arguments)}});return}if(t.addEventListener){t.addEventListener(v,u,false)}else{if(!u.$$guid){u.$$guid=d.guid++}if(!t.events){t.events={}}var s=t.events[v];if(!s){s=t.events[v]={};if(t["on"+v]){s[0]=t["on"+v]}}s[u.$$guid]=u;t["on"+v]=l}}d.guid=1;function m(r,t,s){if(r.removeEventListener){r.removeEventListener(t,s,false)}else{if(r.events&&r.events[t]){delete r.events[t][s.$$guid]}}}function l(u){var t=true;u=u||a(((this.ownerDocument||this.document||this).parentWindow||window).event);var r=this.events[u.type];for(var s in r){this.$$handleEvent=r[s];if(this.$$handleEvent(u)===false){t=false}}return t}function a(r){r.preventDefault=a.preventDefault;r.stopPropagation=a.stopPropagation;return r}a.preventDefault=function(){this.returnValue=false};a.stopPropagation=function(){this.cancelBubble=true};function b(r,s){return r.contains?r.contains(s):!!(r.compareDocumentPosition(s)&16)}(function(){var L=this;var A=L._;var T={};var S=Array.prototype,w=Object.prototype,G=Function.prototype;var D=S.slice,P=S.unshift,t=w.toString,y=w.hasOwnProperty;var ab=S.forEach,F=S.map,U=S.reduce,s=S.reduceRight,r=S.filter,Q=S.every,E=S.some,C=S.indexOf,B=S.lastIndexOf,I=Array.isArray,v=Object.keys,V=G.bind;var ac=function(ad){return new J(ad)};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=ac}exports._=ac}else{L._=ac}ac.VERSION="1.3.3";var Y=ac.each=ac.forEach=function(ai,ah,ag){if(ai==null){return}if(ab&&ai.forEach===ab){ai.forEach(ah,ag)}else{if(ai.length===+ai.length){for(var af=0,ad=ai.length;af<ad;af++){if(af in ai&&ah.call(ag,ai[af],af,ai)===T){return}}}else{for(var ae in ai){if(ac.has(ai,ae)){if(ah.call(ag,ai[ae],ae,ai)===T){return}}}}}};ac.map=ac.collect=function(ag,af,ae){var ad=[];if(ag==null){return ad}if(F&&ag.map===F){return ag.map(af,ae)}Y(ag,function(aj,ah,ai){ad[ad.length]=af.call(ae,aj,ah,ai)});if(ag.length===+ag.length){ad.length=ag.length}return ad};ac.reduce=ac.foldl=ac.inject=function(ah,ag,ad,af){var ae=arguments.length>2;if(ah==null){ah=[]}if(U&&ah.reduce===U){if(af){ag=ac.bind(ag,af)}return ae?ah.reduce(ag,ad):ah.reduce(ag)}Y(ah,function(ak,ai,aj){if(!ae){ad=ak;ae=true}else{ad=ag.call(af,ad,ak,ai,aj)}});if(!ae){throw new TypeError("Reduce of empty array with no initial value")}return ad};ac.reduceRight=ac.foldr=function(ah,ag,ad,af){var ae=arguments.length>2;if(ah==null){ah=[]}if(s&&ah.reduceRight===s){if(af){ag=ac.bind(ag,af)}return ae?ah.reduceRight(ag,ad):ah.reduceRight(ag)}var ai=ac.toArray(ah).reverse();if(af&&!ae){ag=ac.bind(ag,af)}return ae?ac.reduce(ai,ag,ad,af):ac.reduce(ai,ag)};ac.find=ac.detect=function(ag,af,ae){var ad;O(ag,function(aj,ah,ai){if(af.call(ae,aj,ah,ai)){ad=aj;return true}});return ad};ac.filter=ac.select=function(ag,af,ae){var ad=[];if(ag==null){return ad}if(r&&ag.filter===r){return ag.filter(af,ae)}Y(ag,function(aj,ah,ai){if(af.call(ae,aj,ah,ai)){ad[ad.length]=aj}});return ad};ac.reject=function(ag,af,ae){var ad=[];if(ag==null){return ad}Y(ag,function(aj,ah,ai){if(!af.call(ae,aj,ah,ai)){ad[ad.length]=aj}});return ad};ac.every=ac.all=function(ag,af,ae){var ad=true;if(ag==null){return ad}if(Q&&ag.every===Q){return ag.every(af,ae)}Y(ag,function(aj,ah,ai){if(!(ad=ad&&af.call(ae,aj,ah,ai))){return T}});return !!ad};var O=ac.some=ac.any=function(ag,af,ae){af||(af=ac.identity);var ad=false;if(ag==null){return ad}if(E&&ag.some===E){return ag.some(af,ae)}Y(ag,function(aj,ah,ai){if(ad||(ad=af.call(ae,aj,ah,ai))){return T}});return !!ad};ac.include=ac.contains=function(af,ae){var ad=false;if(af==null){return ad}if(C&&af.indexOf===C){return af.indexOf(ae)!=-1}ad=O(af,function(ag){return ag===ae});return ad};ac.invoke=function(ae,af){var ad=D.call(arguments,2);return ac.map(ae,function(ag){return(ac.isFunction(af)?af||ag:ag[af]).apply(ag,ad)})};ac.pluck=function(ae,ad){return ac.map(ae,function(af){return af[ad]})};ac.max=function(ag,af,ae){if(!af&&ac.isArray(ag)&&ag[0]===+ag[0]){return Math.max.apply(Math,ag)}if(!af&&ac.isEmpty(ag)){return -Infinity}var ad={computed:-Infinity};Y(ag,function(ak,ah,aj){var ai=af?af.call(ae,ak,ah,aj):ak;ai>=ad.computed&&(ad={value:ak,computed:ai})});return ad.value};ac.min=function(ag,af,ae){if(!af&&ac.isArray(ag)&&ag[0]===+ag[0]){return Math.min.apply(Math,ag)}if(!af&&ac.isEmpty(ag)){return Infinity}var ad={computed:Infinity};Y(ag,function(ak,ah,aj){var ai=af?af.call(ae,ak,ah,aj):ak;ai<ad.computed&&(ad={value:ak,computed:ai})});return ad.value};ac.shuffle=function(af){var ad=[],ae;Y(af,function(ai,ag,ah){ae=Math.floor(Math.random()*(ag+1));ad[ag]=ad[ae];ad[ae]=ai});return ad};ac.sortBy=function(af,ag,ad){var ae=ac.isFunction(ag)?ag:function(ah){return ah[ag]};return ac.pluck(ac.map(af,function(aj,ah,ai){return{value:aj,criteria:ae.call(ad,aj,ah,ai)}}).sort(function(ak,aj){var ai=ak.criteria,ah=aj.criteria;if(ai===void 0){return 1}if(ah===void 0){return -1}return ai<ah?-1:ai>ah?1:0}),"value")};ac.groupBy=function(af,ag){var ad={};var ae=ac.isFunction(ag)?ag:function(ah){return ah[ag]};Y(af,function(aj,ah){var ai=ae(aj,ah);(ad[ai]||(ad[ai]=[])).push(aj)});return ad};ac.sortedIndex=function(ai,ah,af){af||(af=ac.identity);var ad=0,ag=ai.length;while(ad<ag){var ae=(ad+ag)>>1;af(ai[ae])<af(ah)?ad=ae+1:ag=ae}return ad};ac.toArray=function(ad){if(!ad){return[]}if(ac.isArray(ad)){return D.call(ad)}if(ac.isArguments(ad)){return D.call(ad)}if(ad.toArray&&ac.isFunction(ad.toArray)){return ad.toArray()}return ac.values(ad)};ac.size=function(ad){return ac.isArray(ad)?ad.length:ac.keys(ad).length};ac.first=ac.head=ac.take=function(af,ae,ad){return(ae!=null)&&!ad?D.call(af,0,ae):af[0]};ac.initial=function(af,ae,ad){return D.call(af,0,af.length-((ae==null)||ad?1:ae))};ac.last=function(af,ae,ad){if((ae!=null)&&!ad){return D.call(af,Math.max(af.length-ae,0))}else{return af[af.length-1]}};ac.rest=ac.tail=function(af,ad,ae){return D.call(af,(ad==null)||ae?1:ad)};ac.compact=function(ad){return ac.filter(ad,function(ae){return !!ae})};ac.flatten=function(ae,ad){return ac.reduce(ae,function(af,ag){if(ac.isArray(ag)){return af.concat(ad?ag:ac.flatten(ag))}af[af.length]=ag;return af},[])};ac.without=function(ad){return ac.difference(ad,D.call(arguments,1))};ac.uniq=ac.unique=function(ah,ag,af){var ad=af?ac.map(ah,af):ah;var ae=[];if(ah.length<3){ag=true}ac.reduce(ad,function(ai,ak,aj){if(ag?ac.last(ai)!==ak||!ai.length:!ac.include(ai,ak)){ai.push(ak);ae.push(ah[aj])}return ai},[]);return ae};ac.union=function(){return ac.uniq(ac.flatten(arguments,true))};ac.intersection=ac.intersect=function(ae){var ad=D.call(arguments,1);return ac.filter(ac.uniq(ae),function(af){return ac.every(ad,function(ag){return ac.indexOf(ag,af)>=0})})};ac.difference=function(ae){var ad=ac.flatten(D.call(arguments,1),true);return ac.filter(ae,function(af){return !ac.include(ad,af)})};ac.zip=function(){var ad=D.call(arguments);var ag=ac.max(ac.pluck(ad,"length"));var af=new Array(ag);for(var ae=0;ae<ag;ae++){af[ae]=ac.pluck(ad,""+ae)}return af};ac.indexOf=function(ah,af,ag){if(ah==null){return -1}var ae,ad;if(ag){ae=ac.sortedIndex(ah,af);return ah[ae]===af?ae:-1}if(C&&ah.indexOf===C){return ah.indexOf(af)}for(ae=0,ad=ah.length;ae<ad;ae++){if(ae in ah&&ah[ae]===af){return ae}}return -1};ac.lastIndexOf=function(af,ae){if(af==null){return -1}if(B&&af.lastIndexOf===B){return af.lastIndexOf(ae)}var ad=af.length;while(ad--){if(ad in af&&af[ad]===ae){return ad}}return -1};ac.range=function(ai,ag,ah){if(arguments.length<=1){ag=ai||0;ai=0}ah=arguments[2]||1;var ae=Math.max(Math.ceil((ag-ai)/ah),0);var ad=0;var af=new Array(ae);while(ad<ae){af[ad++]=ai;ai+=ah}return af};var W=function(){};ac.bind=function u(ag,ae){var af,ad;if(ag.bind===V&&V){return V.apply(ag,D.call(arguments,1))}if(!ac.isFunction(ag)){throw new TypeError}ad=D.call(arguments,2);return af=function(){if(!(this instanceof af)){return ag.apply(ae,ad.concat(D.call(arguments)))}W.prototype=ag.prototype;var ai=new W;var ah=ag.apply(ai,ad.concat(D.call(arguments)));if(Object(ah)===ah){return ah}return ai}};ac.bindAll=function(ae){var ad=D.call(arguments,1);if(ad.length==0){ad=ac.functions(ae)}Y(ad,function(af){ae[af]=ac.bind(ae[af],ae)});return ae};ac.memoize=function(af,ae){var ad={};ae||(ae=ac.identity);return function(){var ag=ae.apply(this,arguments);return ac.has(ad,ag)?ad[ag]:(ad[ag]=af.apply(this,arguments))}};ac.delay=function(ae,af){var ad=D.call(arguments,2);return setTimeout(function(){return ae.apply(null,ad)},af)};ac.defer=function(ad){return ac.delay.apply(ac,[ad,1].concat(D.call(arguments,1)))};ac.throttle=function(af,ag){var ae,ai,aj,ak,ah,al;var ad=ac.debounce(function(){ah=ak=false},ag);return function(){ae=this;ai=arguments;var am=function(){aj=null;if(ah){af.apply(ae,ai)}ad()};if(!aj){aj=setTimeout(am,ag)}if(ak){ah=true}else{al=af.apply(ae,ai)}ad();ak=true;return al}};ac.debounce=function(ae,ag,ad){var af;return function(){var aj=this,ai=arguments;var ah=function(){af=null;if(!ad){ae.apply(aj,ai)}};if(ad&&!af){ae.apply(aj,ai)}clearTimeout(af);af=setTimeout(ah,ag)}};ac.once=function(af){var ad=false,ae;return function(){if(ad){return ae}ad=true;return ae=af.apply(this,arguments)}};ac.wrap=function(ad,ae){return function(){var af=[ad].concat(D.call(arguments,0));return ae.apply(this,af)}};ac.compose=function(){var ad=arguments;return function(){var ae=arguments;for(var af=ad.length-1;af>=0;af--){ae=[ad[af].apply(this,ae)]}return ae[0]}};ac.after=function(ae,ad){if(ae<=0){return ad()}return function(){if(--ae<1){return ad.apply(this,arguments)}}};ac.keys=v||function(af){if(af!==Object(af)){throw new TypeError("Invalid object")}var ae=[];for(var ad in af){if(ac.has(af,ad)){ae[ae.length]=ad}}return ae};ac.values=function(ad){return ac.map(ad,ac.identity)};ac.functions=ac.methods=function(af){var ae=[];for(var ad in af){if(ac.isFunction(af[ad])){ae.push(ad)}}return ae.sort()};ac.extend=function(ad){Y(D.call(arguments,1),function(ae){for(var af in ae){ad[af]=ae[af]}});return ad};ac.pick=function(ae){var ad={};Y(ac.flatten(D.call(arguments,1)),function(af){if(af in ae){ad[af]=ae[af]}});return ad};ac.defaults=function(ad){Y(D.call(arguments,1),function(ae){for(var af in ae){if(ad[af]==null){ad[af]=ae[af]}}});return ad};ac.clone=function(ad){if(!ac.isObject(ad)){return ad}return ac.isArray(ad)?ad.slice():ac.extend({},ad)};ac.tap=function(ae,ad){ad(ae);return ae};function Z(ag,af,ae){if(ag===af){return ag!==0||1/ag==1/af}if(ag==null||af==null){return ag===af}if(ag._chain){ag=ag._wrapped}if(af._chain){af=af._wrapped}if(ag.isEqual&&ac.isFunction(ag.isEqual)){return ag.isEqual(af)}if(af.isEqual&&ac.isFunction(af.isEqual)){return af.isEqual(ag)}var aj=t.call(ag);if(aj!=t.call(af)){return false}switch(aj){case"[object String]":return ag==String(af);case"[object Number]":return ag!=+ag?af!=+af:(ag==0?1/ag==1/af:ag==+af);case"[object Date]":case"[object Boolean]":return +ag==+af;case"[object RegExp]":return ag.source==af.source&&ag.global==af.global&&ag.multiline==af.multiline&&ag.ignoreCase==af.ignoreCase}if(typeof ag!="object"||typeof af!="object"){return false}var ak=ae.length;while(ak--){if(ae[ak]==ag){return true}}ae.push(ag);var ai=0,ad=true;if(aj=="[object Array]"){ai=ag.length;ad=ai==af.length;if(ad){while(ai--){if(!(ad=ai in ag==ai in af&&Z(ag[ai],af[ai],ae))){break}}}}else{if("constructor" in ag!="constructor" in af||ag.constructor!=af.constructor){return false}for(var ah in ag){if(ac.has(ag,ah)){ai++;if(!(ad=ac.has(af,ah)&&Z(ag[ah],af[ah],ae))){break}}}if(ad){for(ah in af){if(ac.has(af,ah)&&!(ai--)){break}}ad=!ai}}ae.pop();return ad}ac.isEqual=function(ae,ad){return Z(ae,ad,[])};ac.isEmpty=function(ae){if(ae==null){return true}if(ac.isArray(ae)||ac.isString(ae)){return ae.length===0}for(var ad in ae){if(ac.has(ae,ad)){return false}}return true};ac.isElement=function(ad){return !!(ad&&ad.nodeType==1)};ac.isArray=I||function(ad){return t.call(ad)=="[object Array]"};ac.isObject=function(ad){return ad===Object(ad)};ac.isArguments=function(ad){return t.call(ad)=="[object Arguments]"};if(!ac.isArguments(arguments)){ac.isArguments=function(ad){return !!(ad&&ac.has(ad,"callee"))}}ac.isFunction=function(ad){return t.call(ad)=="[object Function]"};ac.isString=function(ad){return t.call(ad)=="[object String]"};ac.isNumber=function(ad){return t.call(ad)=="[object Number]"};ac.isFinite=function(ad){return ac.isNumber(ad)&&isFinite(ad)};ac.isNaN=function(ad){return ad!==ad};ac.isBoolean=function(ad){return ad===true||ad===false||t.call(ad)=="[object Boolean]"};ac.isDate=function(ad){return t.call(ad)=="[object Date]"};ac.isRegExp=function(ad){return t.call(ad)=="[object RegExp]"};ac.isNull=function(ad){return ad===null};ac.isUndefined=function(ad){return ad===void 0};ac.has=function(ae,ad){return y.call(ae,ad)};ac.noConflict=function(){L._=A;return this};ac.identity=function(ad){return ad};ac.times=function(ag,af,ae){for(var ad=0;ad<ag;ad++){af.call(ae,ad)}};ac.escape=function(ad){return(""+ad).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};ac.result=function(ad,af){if(ad==null){return null}var ae=ad[af];return ac.isFunction(ae)?ae.call(ad):ae};ac.mixin=function(ad){Y(ac.functions(ad),function(ae){M(ae,ac[ae]=ad[ae])})};var N=0;ac.uniqueId=function(ad){var ae=N++;return ad?ad+ae:ae};ac.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var K=/.^/;var x={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var X in x){x[x[X]]=X}var z=/\\|'|\r|\n|\t|\u2028|\u2029/g;var R=/\\(\\|'|r|n|t|u2028|u2029)/g;var aa=function(ad){return ad.replace(R,function(ae,af){return x[af]})};ac.template=function(ai,ah,af){af=ac.defaults(af||{},ac.templateSettings);var ag="__p+='"+ai.replace(z,function(aj){return"\\"+x[aj]}).replace(af.escape||K,function(aj,ak){return"'+\n_.escape("+aa(ak)+")+\n'"}).replace(af.interpolate||K,function(aj,ak){return"'+\n("+aa(ak)+")+\n'"}).replace(af.evaluate||K,function(aj,ak){return"';\n"+aa(ak)+"\n;__p+='"})+"';\n";if(!af.variable){ag="with(obj||{}){\n"+ag+"}\n"}ag="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+ag+"return __p;\n";var ae=new Function(af.variable||"obj","_",ag);if(ah){return ae(ah,ac)}var ad=function(aj){return ae.call(this,aj,ac)};ad.source="function("+(af.variable||"obj")+"){\n"+ag+"}";return ad};ac.chain=function(ad){return ac(ad).chain()};var J=function(ad){this._wrapped=ad};ac.prototype=J.prototype;var H=function(ae,ad){return ad?ac(ae).chain():ae};var M=function(ad,ae){J.prototype[ad]=function(){var af=D.call(arguments);P.call(af,this._wrapped);return H(ae.apply(ac,af),this._chain)}};ac.mixin(ac);Y(["pop","push","reverse","shift","sort","splice","unshift"],function(ad){var ae=S[ad];J.prototype[ad]=function(){var af=this._wrapped;ae.apply(af,arguments);var ag=af.length;if((ad=="shift"||ad=="splice")&&ag===0){delete af[0]}return H(af,this._chain)}});Y(["concat","join","slice"],function(ad){var ae=S[ad];J.prototype[ad]=function(){return H(ae.apply(this._wrapped,arguments),this._chain)}});J.prototype.chain=function(){this._chain=true;return this};J.prototype.value=function(){return this._wrapped}}).call(this);(function(u){var t=function(){return t};t.cssColor=function(v){if(v.length==3){return"rgb("+h(v[0])+","+h(v[1])+","+h(v[2])+")"}return"rgba("+h(v[0])+","+h(v[1])+","+h(v[2])+","+v[3]+")"};t.clamp=g=function(x,w,v){return(x<w?w:x>v?v:x)};t.opposite=function(w){if(!_.isArray(w)){w=t.parseColorString(w)}var v=t.rgb2hsl(w);v[0]=(v[0]+180)%360;v[1]=100-v[1];v[2]=100-v[2];var x=t.hsl2rgb(v);if(w.length===4){x.push(w[3])}return x};t.rgba2rgb=function(y){if(y.length===3||y[3]===255){return y}var A=y[0],z=y[1],v=y[2],w=y[3],x=[];x[0]=(w*A)+(255-w*255);x[1]=(w*z)+(255-w*255);x[2]=(w*v)+(255-w*255);return x};t.rgb2hex=function(v){v=t.rgba2rgb(v);return"#"+s(v[0])+s(v[1])+s(v[2])};t.hex2rgb=function(v){return t.parseColorString(v)};t.rgb2hsl=function(B){var v=B[0]/255,y=B[1]/255,C=B[2]/255,D=n(v,y,C),z=e(v,y,C),A,x,E,w=(D+z)/2;if(D==z){x=E=0}else{A=D-z;E=w>0.5?A/(2-D-z):A/(D+z);switch(n){case v:x=(y-C)/A+(y<C?6:0);break;case y:x=(C-v)/A+2;break;case C:x=(v-y)/A+4;break}x/=6}return[x,E*100,w*100]};t.hex2hsl=function(v){return t.rgb2hsl(t.hex2rgb(v))};t.hsl2rgb=function(B){var D,C,z;var v,y,A;var x=B[0],E=B[1]/100,w=B[2]/100;if(E==0){v=y=A=(w*255)}else{if(w<=0.5){C=w*(E+1)}else{C=w+E-w*E}D=w*2-C;z=x/360;v=r(D,C,z+1/3);y=r(D,C,z);A=r(D,C,z-1/3)}return[v,y,A]};function s(v){v=parseInt(v,10)||0;v=g(v,0,255).toString(16);if(v.length===1){v="0"+v}return v}function r(z,y,x){var w;if(x<0){x+=1}else{if(x>1){x-=1}}if(6*x<1){w=z+(y-z)*x*6}else{if(2*x<1){w=y}else{if(3*x<2){w=z+(y-z)*(2/3-x)*6}else{w=z}}}return 255*w}t.parseColorString=function(A){function E(J){var H=document.createElement("a");H.style.color=J;document.body.appendChild(H);var I=getComputedStyle(H).color;document.body.removeChild(H);return I}var B=false,v,y,C,D;A=E(A);var z=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(H){return[parseInt(H[1]),parseInt(H[2]),parseInt(H[3]),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(H){return[parseInt(H[1]),parseInt(H[2]),parseInt(H[3]),parseFloat(H[4])]}}];for(var x=0;x<z.length;x++){var G=z[x].re;var w=z[x].process;var F=G.exec(A);if(F){channels=w(F);v=channels[0];y=channels[1];C=channels[2];D=channels[3];B=true}}v=(v<0||isNaN(v))?0:((v>255)?255:v);y=(y<0||isNaN(y))?0:((y>255)?255:y);C=(C<0||isNaN(C))?0:((C>255)?255:C);D=(D<0||isNaN(D))?0:((D>1)?1:D);return B?[v,y,C,D]:[0,0,0,1]};u.util=t})(TeledrawCanvas);(function(){var s=0;var t=["ms","moz","webkit","o"];for(var r=0;r<t.length&&!window.requestAnimationFrame;++r){window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(y,v){var u=new Date().getTime();var w=Math.max(0,16-(u-s));var x=window.setTimeout(function(){y(u+w)},w);s=u+w;return x}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(u){clearTimeout(u)}}}());(function(x){x.canvases=[];var v=0;var w={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1000,strokeSoftness:0};var s={last:null,currentTool:"pencil",previousTool:"pencil",tool:null,mouseDown:k,mouseOver:k,width:null,height:null,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5000,maxHistory:10,minStrokeSize:500,maxStrokeSize:10000,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8};var r=typeof _Canvas!=="undefined"?_Canvas:function(y,z){var A=document.createElement("canvas");if(y){A.width=y}if(z){A.height=z}return A};var t=function(C,N){var M=this,E=M.element=C.getContext?C:document.getElementById(C);state=M.state=_.extend({},s,N);if(typeof(new r()).getContext!="function"){throw new Error("Your browser does not support HTML canvas!");return false}E.width=state.width=state.displayWidth||state.width||E.width;E.height=state.height=state.displayHeight||state.height||E.height;state.fullWidth=state.fullWidth||state.width;state.fullHeight=state.fullHeight||state.height;if(state.width/state.height!==state.fullWidth/state.fullHeight){state.fullHeight=state.fullWidth*state.height/state.width}M._displayCanvas=E;M._canvas=new r(state.fullWidth,state.fullHeight);M.history=new x.History(M);M.defaults();M.zoom(0);M.history.checkpoint();x.canvases[v++]=M;var H,D=f;d(E,"gesturestart",J);d(E,"gesturechange",A);d(E,"gestureend",B);d(E,"dblclick",z);d(E,"mouseenter",I);d(E,"mousedown",F);d(E,"touchstart",F);d(E,"mouseleave",L);d(window,"mousemove",K);d(window,"touchmove",K);function I(O){var P=y(O);state.tool.enter(state.mouseDown,P);state.last=P;state.mouseOver=c}function L(O){var P=y(O);state.tool.leave(state.mouseDown,P);state.mouseOver=k}function z(O){var P=y(O);state.tool.dblclick(P)}function K(P){if(P.type=="touchmove"&&P.touches.length>1){return c}if(D=="touchmove"&&P.type=="mousemove"){return}if(P.target==E||state.mouseDown){var O=y(P);state.tool.move(state.mouseDown,state.last,O);state.last=O;M.trigger("mousemove",O,P);D=P.type;P.preventDefault();return k}}function F(P){var O=state.last=y(P);if(P.type=="touchstart"&&P.touches.length>1){return c}d(window,P.type==="mousedown"?"mouseup":"touchend",G);state.mouseDown=c;state.tool.down(O);M.trigger("mousedown",O,P);document.onselectstart=function(){return k};P.preventDefault();return k}function G(O){m(window,O.type==="mouseup"?"mouseup":"touchend",G);if(O.type=="touchend"&&O.touches.length>1){return c}state.mouseDown=k;state.tool.up(state.last);M.trigger("mouseup",state.last,O);document.onselectstart=function(){return c};O.preventDefault();return k}function J(O){if(state.tool.name=="grab"){H=state.currentZoom}}function A(O){if(state.tool.name=="grab"){var P=state.last;M.zoom(H*O.scale,P.xd,P.yd)}O.preventDefault();return k}function B(O){}function y(S){var R=E.offsetLeft,Q=E.offsetTop,P=S.pageX||S.touches&&S.touches[0].pageX,O=S.pageY||S.touches&&S.touches[0].pageY;return{x:h((P-R)/state.currentZoom)+state.currentOffset.x||0,y:h((O-Q)/state.currentZoom)+state.currentOffset.y||0,xd:h(P-R)||0,yd:h(O-Q)||0}}};var u=t.prototype;u.setRGBAArrayColor=function(z){var A=this.state;if(z.length===4){A.globalAlpha=z.pop()}for(var y=z.length;y<3;++y){z.push(0)}A.color=z;this.updateTool()};u.updateTool=function(){var y=1+h(i(this.state.strokeSize/1000,2));var z=h(i(this.state.strokeSoftness,1.3)/300*y);this.state.lineWidth=y;this.state.shadowBlur=z};u.updateDisplayCanvas=function(B){var F=this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d")),E=this.state.currentOffset,C=this.state.currentZoom,z=F.canvas.width,D=F.canvas.height,y=z/C,A=D/C;F.clearRect(0,0,z,D);if(B!==true){this.trigger("display.update:before")}F.drawImage(this._canvas,E.x,E.y,y,A,0,0,z,D);if(B!==true){this.trigger("display.update:after")}};u.canvas=function(){return this._canvas};u.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))};u.cursor=function(z){if(!z){z="default"}var y=z.split(/,\s*/);do{z=y.shift();this.element.style.cursor=z}while(z.length&&this.element.style.cursor!=z);return this};u.clear=function(A){var z=this,y=z.ctx();y.clearRect(0,0,y.canvas.width,y.canvas.height);if(A!==c){z.history.checkpoint()}z.updateDisplayCanvas();return z};u.defaults=function(){var y=this;y.setTool("pencil");y.setAlpha(w.alpha);y.setColor(w.color);y.setStrokeSize(w.strokeSize);y.setStrokeSoftness(w.strokeSoftness);return y};u.toDataURL=function(z,D,B,C){if(B&&C){B=parseInt(B);C=parseInt(C);z=z!==j?z:0;D=D!==j?D:0;var A=this.getTempCanvas(B,C);A.getContext("2d").drawImage(this.canvas(),z,D,B,C,0,0,B,C);return A.toDataURL()}return this.canvas().toDataURL()};u.getTempCanvas=function(y,z){return new r(y||this._canvas.width,z||this._canvas.height)};u.fromDataURL=u.fromImageURL=function(B,y){var A=this,z=new Image();z.onload=function(){A.clear(c);A.ctx().drawImage(z,0,0);A.updateDisplayCanvas();if(typeof y=="function"){y.call(A)}};z.src=B;return A};u.getImageData=function(){var y=this.ctx();return y.getImageData(0,0,y.canvas.width,y.canvas.height)};u.putImageData=function(y){this.ctx().putImageData(y,0,0);this.updateDisplayCanvas();return this};u.getColor=function(){return this.state.color.slice()};u.setColor=function(y){if(!_.isArray(y)){y=x.util.parseColorString(y)}this.setRGBAArrayColor(y);return this};u.setAlpha=function(y){this.state.globalAlpha=g(y,0,1);return this};u.getAlpha=function(){return this.state.globalAlpha};u.setStrokeSize=function(y){this.state.strokeSize=g(y,this.state.minStrokeSize,this.state.maxStrokeSize);this.updateTool();return this};u.setStrokeSoftness=function(y){this.state.strokeSoftness=g(y,this.state.minStrokeSoftness,this.state.maxStrokeSoftness);this.updateTool();return this};u.setTool=function(y){this.state.previousTool=this.state.currentTool;this.state.currentTool=y;if(!x.tools[y]){throw new Error('Tool "'+y+'" not defined.')}this.state.tool=new x.tools[y](this);this.updateTool();return this};u.previousTool=function(){return this.setTool(this.state.previousTool)};u.undo=function(){this.history.undo();return this};u.redo=function(){this.history.redo();return this};u.resize=function(z,B){var A=this,y=Math.round(A._canvas.width/A._canvas.height*100)/100,C=Math.round(z/B*100)/100;if(y!==C){throw new Error("Not the same aspect ratio!")}A._displayCanvas.width=A.state.width=z;A._displayCanvas.height=A.state.height=B;A.updateDisplayCanvas();return A.zoom(A.state.currentZoom)};u.zoom=function(D,F,E){if(arguments.length===0){return this.state.currentZoom}var H=this,C=0,B=0,G=H.state.currentZoom,I=H._displayCanvas.width,A=H._displayCanvas.height;F=g(F||I/2,0,I);E=g(E||A/2,0,A);D=g(D||0,I/H._canvas.width,H.state.maxZoom);if(D!==G){if(D>G){C=-(I/G-I/D)/2-(F-I/2)/G;B=-(A/G-A/D)/2-(E-A/2)/G}else{if(D<G){C=(I/D-I/G)/2;B=(A/D-A/G)/2}}C*=D;B*=D}H.state.currentZoom=D;H.trigger("zoom",D,G);H.pan(C,B);H.updateDisplayCanvas();return H};u.pan=function(C,B,D){if(arguments.length===0){return this.state.currentOffset}var H=this,G=H.state.currentZoom,A=H.state.currentOffset.x,z=H.state.currentOffset.y,F=H._canvas.width-H._displayCanvas.width/G,E=H._canvas.height-H._displayCanvas.height/G;C=D===c?C/G:A-(C||0)/G;B=D===c?B/G:z-(B||0)/G;H.state.currentOffset={x:h(g(C,0,F)),y:h(g(B,0,E))};H.trigger("pan",C,B);H.updateDisplayCanvas();return H};_.extend(u,Events);x.api=t})(TeledrawCanvas);(function(s){var r=function(t){this.canvas=t;this.rev=0;this.clear()};r.prototype.clear=function(){this.past=[];this.current=null;this.future=[]};r.prototype.checkpoint=function(){if(this.past.length>this.canvas.state.maxHistory){this.past.shift()}if(this.current){this.past.push(this.current)}this.current=new s.Snapshot(this.canvas);this.future=[];this.rev++};r.prototype.undo=function(){if(this._move(this.past,this.future)){this.rev--}};r.prototype.redo=function(){if(this._move(this.future,this.past)){this.rev++}};r.prototype._move=function(u,t){if(!u.length){return k}if(!this.current){return k}t.push(this.current);this.current=u.pop();this.current.restore();return c};s.History=r})(TeledrawCanvas);(function(s){var r=function(t){this.canvas=t;this._snapshotBufferCanvas()};r.prototype.restore=function(v){var t,u;if(v){t=v.tl;u=v.br}else{t={x:0,y:0};u={x:this.canvas.canvas().width,y:this.canvas.canvas().height}}this._restoreBufferCanvas(t,u);this.canvas.updateDisplayCanvas(t,u)};r.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()};r.prototype._snapshotBufferCanvas=function(){this.buffer=this.canvas.getTempCanvas();this.buffer.getContext("2d").drawImage(this.canvas.canvas(),0,0)};r.prototype._restoreBufferCanvas=function(v,x){var u=this.canvas.ctx();var t=x.x-v.x,y=x.y-v.y;if(t===0||y===0){return}u.clearRect(v.x,v.y,t,y);u.drawImage(this.buffer,v.x,v.y,t,y,v.x,v.y,t,y)};r.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()};r.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)};s.Snapshot=r})(TeledrawCanvas);(function(s){var r=function(t){this.canvas=t};r.prototype.start=function(t){};r.prototype.move=function(u,t){};r.prototype.end=function(){};r.prototype.draw=function(){};r.prototype.save=function(){this.snapshot=new s.Snapshot(this.canvas)};r.prototype.restore=function(){this.snapshot.restore(this)};s.Stroke=r})(TeledrawCanvas);(function(s){var r=function(){};r.prototype.down=function(t){};r.prototype.up=function(t){};r.prototype.move=function(t,v,u){};r.prototype.dblclick=function(t){};r.prototype.enter=function(t,u){};r.prototype.leave=function(t,u){};r.prototype.keydown=function(u,t){};r.prototype.keyup=function(u,t){};r.prototype.preview=function(){};r.prototype.alt_down=function(){};r.prototype.alt_up=function(){};r.createTool=function(u,x,v){var w=function(y){this.canvas=y;this.ctx=y.ctx();this.color=y.getColor();this.color.push(y.getAlpha());this.points=[];this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height};this.br={x:0,y:0};this.tool={}};w.prototype=new s.Stroke();var t=function(y){this.canvas=y;y.cursor(x);this.name=u;this.cursor=x||"default";this.currentStroke=null;if(typeof v=="function"){v.call(this)}};t.prototype=new r();t.prototype.down=function(y){this.currentStroke=new w(this.canvas);this.currentStroke.tool=this;this.currentStroke.save();this.currentStroke.points.push(y);this.currentStroke.start(y);this._updateBoundaries(y);this.draw()};t.prototype.move=function(y,A,z){if(y&&this.currentStroke){this.currentStroke.points.push(z);this.currentStroke.move(A,z);this._updateBoundaries(z);this.draw()}};t.prototype.up=function(y){if(this.currentStroke){this.currentStroke.end(y);this.draw();this.currentStroke=null;this.canvas.history.checkpoint()}this.canvas.trigger("tool.up")};t.prototype.draw=function(){this.currentStroke.ctx.save();this.currentStroke.restore();this.currentStroke.draw();this.canvas.updateDisplayCanvas(this.currentStroke.tl,this.currentStroke.br);this.currentStroke.ctx.restore()};t.prototype._updateBoundaries=function(B){var A=this.currentStroke,y=A.ctx.canvas,z=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;if(B.x-z<A.tl.x){A.tl.x=g(h(B.x-z),0,y.width)}if(B.x+z>A.br.x){A.br.x=g(h(B.x+z),0,y.width)}if(B.y-z<A.tl.y){A.tl.y=g(h(B.y-z),0,y.height)}if(B.y+z>A.br.y){A.br.y=g(h(B.y+z),0,y.height)}};t.stroke=w;w.tool=t;s.tools[u]=t;return t};s.Tool=r;s.tools={}})(TeledrawCanvas);(function(u){var r=u.Tool.createTool("ellipse","crosshair"),s=r.stroke.prototype;s.bgColor=[255,255,255];s.bgAlpha=0;s.lineWidth=1;s.start=function(v){this.first=v};s.move=function(w,v){this.second=v};s.end=function(v){this.second=v};s.draw=function(){if(!this.first||!this.second){return}var G=this,E=G.first.x,D=G.first.y,F=G.second.x-E,B=G.second.y-D,H=G.ctx,v=G.canvas.state,I=v.shadowOffset,A=v.shadowBlur,C=v.lineWidth,z=u.util.cssColor(v.color);H.lineJoin=H.lineCap="round";H.globalAlpha=v.globalAlpha;H.fillStyle=H.strokeStyle=z;H.miterLimit=100000;if(G.tool.shiftKey){B=G.second.y>D?q(F):-q(F)}if(G.tool.fill){t(H,E,D,F,B);H.fill()}else{if(A>0){H.shadowColor=z;H.shadowOffsetX=H.shadowOffsetY=I;H.shadowBlur=A;H.translate(-I,-I)}H.lineWidth=C;t(H,E,D,F,B);H.stroke()}};function t(A,v,D,z,B){var C=0.5522848;ox=(z/2)*C,oy=(B/2)*C,xe=v+z,ye=D+B,xm=v+z/2,ym=D+B/2;A.beginPath();A.moveTo(v,ym);A.bezierCurveTo(v,ym-oy,xm-ox,D,xm,D);A.bezierCurveTo(xm+ox,D,xe,ym-oy,xe,ym);A.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);A.bezierCurveTo(xm-ox,ye,v,ym+oy,v,ym);A.closePath()}})(TeledrawCanvas);(function(s){var r=s.Tool.createTool("eraser","crosshair");r.stroke.prototype.lineWidth=1;r.stroke.prototype.lineCap="round";r.stroke.prototype.draw=function(){this.color=[255,255,255,255];this.ctx.globalCompositeOperation="destination-out";s.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(t){var r=function(){this.previewContainer=document.createElement("div");_.extend(this.previewContainer.style,{position:"absolute",width:"10px",height:"10px",border:"1px solid black",display:"none"});document.body.appendChild(this.previewContainer);if(this.canvas.state.mouseOver){this.previewContainer.style.display="block"}};var s=t.Tool.createTool("eyedropper","crosshair",r);s.prototype.pick=function(y){var v=this.previewContainer,z,x=this.canvas.element.offsetLeft,w=this.canvas.element.offsetTop,u=this.canvas._displayCtx.getImageData(y.xd,y.yd,1,1).data;this.color=t.util.rgba2rgb(Array.prototype.slice.call(u));var z=t.util.rgb2hsl(this.color)[2];_.extend(v.style,{left:(x+y.xd+15)+"px",top:(w+y.yd+5)+"px",background:t.util.cssColor(this.color),"border-color":z>=50?"#000":"#888"});if(this.canvas.state.mouseOver){v.style.display="none";v.offsetHeight;v.style.display="block"}else{v.style.display="none"}};s.prototype.enter=function(){this.previewContainer.style.display="block"};s.prototype.leave=function(){this.previewContainer.style.display="none"};s.prototype.move=function(w,v,u){this.pick(u)};s.prototype.down=function(u){this.pick(u)};s.prototype.up=function(u){this.pick(u);this.canvas.setColor(this.color);this.previewContainer.parentNode.removeChild(this.previewContainer);this.canvas.previousTool()}})(TeledrawCanvas);(function(y){var t=y.Tool.createTool("fill","crosshair");var r=Math.abs;t.blur=true;t.stroke.prototype.bgColor=[255,255,255];t.stroke.prototype.bgAlpha=255;t.stroke.prototype.end=function(E){var I=this.ctx.canvas.width,D=this.ctx.canvas.height;var A=this.ctx.getImageData(0,0,I,D);var F=this.ctx.createImageData(I,D);var B=this.color;B[3]*=255;x(A.data,F.data,E,I,D,this.color);this.tmp_canvas=this.canvas.getTempCanvas();var H=this.tmp_canvas.getContext("2d");H.putImageData(F,0,0);if(t.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);var G=H.getImageData(0,0,I,D);for(var C=0,z=G.data.length;C<z;C+=4){if(G.data[C+3]/255>0.2){G.data[C]=B[0];G.data[C+1]=B[1];G.data[C+2]=B[2];G.data[C+3]=Math.min(B[3],G.data[C+3]*3)}}H.putImageData(G,0,0)}};t.stroke.prototype.draw=function(){if(this.tmp_canvas){this.ctx.drawImage(this.tmp_canvas,0,0)}};function x(C,B,Q,I,P,J){var D=[[Q.x,Q.y]];var K=v(C,Q.x,Q.y,I);var O=t.tolerance;var E,z;var N,M,L,H,F,A;var G=y.util.opposite(K);G[3]/=2;while(D.length){L=D.pop();H=L[0];A=F=L[1];while(A>=0&&u(v(C,H,A,I),K)){A--}A++;E=z=false;while(A<P&&u(v(C,H,A,I),K)){s(C,H,A,I,G);s(B,H,A,I,J);if(!E&&H>0&&u(v(C,H-1,A,I),K)){D.push([H-1,A]);E=true}else{if(E&&H>0&&u(v(C,H-1,A,I),K)){E=false}}if(!z&&H<I-1&&u(v(C,H+1,A,I),K)){D.push([H+1,A]);z=true}else{if(z&&H<I-1&&u(v(C,H+1,A,I),K)){z=false}}A++}}}function v(B,z,D,A){var C=(D*A+z)*4;return[B[C],B[C+1],B[C+2],B[C+3]]}function s(C,z,E,A,B){var D=(E*A+z)*4;C[D]=B[0];C[D+1]=B[1];C[D+2]=B[2];C[D+3]=B[3]}function w(A,z){return r(A[0]-z[0])+r(A[1]-z[1])+r(A[2]-z[2])+r(A[3]-z[3])}function u(A,z){return w(A,z)<5}})(TeledrawCanvas);(function(u){var s="hand, grab, -moz-grab, -webkit-grab, move",r="grabbing, -moz-grabbing, -webkit-grabbing, move";var t=u.Tool.createTool("grab",s);t.prototype.move=function(y,x,w){var v=this;if(y){clearTimeout(this._clearDeltasId);cancelAnimationFrame(this._momentumId);this.dx=w.xd-x.xd;this.dy=w.yd-x.yd;this.canvas.pan(this.dx,this.dy);this._clearDeltasId=setTimeout(function(){v.dx=v.dy=0},100)}};t.prototype.down=function(v){cancelAnimationFrame(this._momentumId);this.canvas.cursor(r)};t.prototype.up=function(v){cancelAnimationFrame(this._momentumId);this.momentum(this.dx,this.dy);this.dx=this.dy=0;this.canvas.cursor(s)};t.prototype.dblclick=function(v){cancelAnimationFrame(this._momentumId);this.dx=this.dy=0;this.canvas.zoom(this.canvas.state.currentZoom*2,v.xd,v.yd)};t.prototype.momentum=function(x,v){var w=this;if(Math.abs(x)>=1||Math.abs(v)>=1){x/=1.1;v/=1.1;this.canvas.pan(x,v);this._momentumId=requestAnimationFrame(function(){w.momentum(x,v)})}}})(TeledrawCanvas);(function(s){var r=s.Tool.createTool("line","crosshair");r.stroke.prototype.lineWidth=1;r.stroke.prototype.lineCap="round";r.stroke.prototype.bgColor=[255,255,255];r.stroke.prototype.bgAlpha=0;r.stroke.prototype.start=function(t){this.first=t};r.stroke.prototype.move=function(u,t){this.second=t};r.stroke.prototype.end=function(t){this.second=t};r.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var z=_.extend({},this.first),v=_.extend({},this.second),u,t,A,w=Math.PI;if(this.tool.shiftKey){t=v.x-z.x;A=v.y-z.y;u=Math.atan2(A,t);if((u>=-w*7/8&&u<-w*5/8)||(u>=-w*3/8&&u<-w/8)){v.y=z.y-Math.abs(t)}else{if((u>=-w*5/8&&u<-w*3/8)||(u>=w*3/8&&u<w*5/8)){v.x=z.x}else{if((u>=w/8&&u<w*3/8)||(u>=w*5/8&&u<w*7/8)){v.y=z.y+Math.abs(t)}else{v.y=z.y}}}}this.points=[z,v];s.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(s){var r=s.Tool.createTool("pencil","crosshair");r.stroke.prototype.lineWidth=1;r.stroke.prototype.lineCap="round";r.stroke.prototype.smoothing=true;r.stroke.prototype.draw=function(){var t=this.canvas.state,C=this.ctx,B=this.points,u,z,E,D=t.shadowOffset,w=t.shadowBlur,y=t.lineWidth,v=s.util.cssColor(t.color);C.globalAlpha=t.globalAlpha;C.fillStyle=C.strokeStyle=v;C.miterLimit=100000;if(w>0){C.shadowColor=v;C.shadowOffsetX=C.shadowOffsetY=D;C.shadowBlur=w;C.translate(-D,-D)}if(B.length===1){switch(this.lineCap){case"round":C.beginPath();C.arc(B[0].x,B[0].y,y/2,0,2*Math.PI,true);C.closePath();C.fill();break;case"square":C.fillRect(B[0].x-y/2,B[0].y-y/2,y,y)}}else{if(B.length>1){C.lineJoin="round";C.lineCap=this.lineCap;C.lineWidth=y;C.beginPath();C.moveTo(B[0].x,B[0].y);u=B[0];z=null;for(var x=1;x<B.length;++x){E=B[x];if(z&&(z.x==E.x||z.y==E.y)){E.x+=0.1;E.y+=0.1}if(this.smoothing){var A={x:(u.x+E.x)/2,y:(u.y+E.y)/2};C.quadraticCurveTo(u.x,u.y,A.x,A.y)}else{C.lineTo(E.x,E.y)}z=u;u=B[x]}if(this.smoothing){C.quadraticCurveTo(u.x,u.y,E.x,E.y)}C.stroke()}}}})(TeledrawCanvas);(function(t){var s=t.Tool.createTool("rectangle","crosshair");s.stroke.prototype.bgColor=[255,255,255];s.stroke.prototype.bgAlpha=0;s.stroke.prototype.lineWidth=1;s.stroke.prototype.start=function(u){this.first=u};s.stroke.prototype.move=function(v,u){this.second=u};s.stroke.prototype.end=function(u){this.second=u};s.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var z=this.first,v=_.extend({},this.second),C=this.ctx,u=this.canvas.state,D=u.shadowOffset,y=u.shadowBlur,A=u.lineWidth,x=t.util.cssColor(u.color);C.lineJoin=C.lineCap="round";C.globalAlpha=u.globalAlpha;C.fillStyle=C.strokeStyle=x;C.miterLimit=100000;if(this.tool.shiftKey){var B=Math.abs(v.x-z.x);v.y=z.y+(v.y>z.y?B:-B)}if(this.tool.fill){r(C,z,v);C.fill()}else{if(y>0){C.shadowColor=x;C.shadowOffsetX=C.shadowOffsetY=D;C.shadowBlur=y;C.translate(-D,-D)}C.lineWidth=A;r(C,z,v);C.stroke()}};function r(u,w,v){u.beginPath();u.moveTo(w.x,w.y);u.lineTo(v.x,w.y);u.lineTo(v.x,v.y);u.lineTo(w.x,v.y);u.lineTo(w.x,w.y)}})(TeledrawCanvas)})();