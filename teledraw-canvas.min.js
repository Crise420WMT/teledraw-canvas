/*!

	Teledraw TeledrawCanvas
	Version 0.6.3 (http://semver.org/)
	Copyright 2012 Cameron Lakenen
	
	Permission is hereby granted, free of charge, to any person obtaining
	a copy of this software and associated documentation files (the
	"Software"), to deal in the Software without restriction, including
	without limitation the rights to use, copy, modify, merge, publish,
	distribute, sublicense, and/or sell copies of the Software, and to
	permit persons to whom the Software is furnished to do so, subject to
	the following conditions:
	
	The above copyright notice and this permission notice shall be
	included in all copies or substantial portions of the Software.
	
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
	OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
	WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

**/
(function(){var a=true,h=false,c=null,g,j=Math,l=j.abs,e=j.floor,k=j.round,b=j.min,i=j.max,f=j.pow,d;TeledrawCanvas=function(m,n){return new TeledrawCanvas.api(m,n)};stackBlurCanvasRGBA=(function(){var m=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var p=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var o=function(z,ac){if(isNaN(ac)||ac<1){return}ac|=0;var T=0,R=0,q=z.width,s=z.height;var am=z.getContext("2d");var ah;try{try{ah=am.getImageData(T,R,q,s)}catch(al){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");ah=am.getImageData(T,R,q,s)}catch(al){alert("Cannot access local image");throw new Error("unable to access local image data: "+al);return}}}catch(al){alert("Cannot access image");throw new Error("unable to access image data: "+al)}var w=ah.data;var aa,Z,aj,ag,H,K,D,u,v,Q,af,G,S,O,r,W,ab,I,F,C,J,L,M,V;var ak=ac+ac+1;var X=q<<2;var E=q-1;var ae=s-1;var B=ac+1;var ad=B*(B+1)/2;var U=new n();var P=U;for(aj=1;aj<ak;aj++){P=P.next=new n();if(aj==B){var A=P}}P.next=U;var ai=null;var Y=null;D=K=0;var N=m[ac];var t=p[ac];for(Z=0;Z<s;Z++){W=ab=I=F=u=v=Q=af=0;G=B*(C=w[K]);S=B*(J=w[K+1]);O=B*(L=w[K+2]);r=B*(M=w[K+3]);u+=ad*C;v+=ad*J;Q+=ad*L;af+=ad*M;P=U;for(aj=0;aj<B;aj++){P.r=C;P.g=J;P.b=L;P.a=M;P=P.next}for(aj=1;aj<B;aj++){ag=K+((E<aj?E:aj)<<2);u+=(P.r=(C=w[ag]))*(V=B-aj);v+=(P.g=(J=w[ag+1]))*V;Q+=(P.b=(L=w[ag+2]))*V;af+=(P.a=(M=w[ag+3]))*V;W+=C;ab+=J;I+=L;F+=M;P=P.next}ai=U;Y=A;for(aa=0;aa<q;aa++){w[K+3]=M=(af*N)>>t;if(M!=0){M=255/M;w[K]=((u*N)>>t)*M;w[K+1]=((v*N)>>t)*M;w[K+2]=((Q*N)>>t)*M}else{w[K]=w[K+1]=w[K+2]=0}u-=G;v-=S;Q-=O;af-=r;G-=ai.r;S-=ai.g;O-=ai.b;r-=ai.a;ag=(D+((ag=aa+ac+1)<E?ag:E))<<2;W+=(ai.r=w[ag]);ab+=(ai.g=w[ag+1]);I+=(ai.b=w[ag+2]);F+=(ai.a=w[ag+3]);u+=W;v+=ab;Q+=I;af+=F;ai=ai.next;G+=(C=Y.r);S+=(J=Y.g);O+=(L=Y.b);r+=(M=Y.a);W-=C;ab-=J;I-=L;F-=M;Y=Y.next;K+=4}D+=q}for(aa=0;aa<q;aa++){ab=I=F=W=v=Q=af=u=0;K=aa<<2;G=B*(C=w[K]);S=B*(J=w[K+1]);O=B*(L=w[K+2]);r=B*(M=w[K+3]);u+=ad*C;v+=ad*J;Q+=ad*L;af+=ad*M;P=U;for(aj=0;aj<B;aj++){P.r=C;P.g=J;P.b=L;P.a=M;P=P.next}H=q;for(aj=1;aj<=ac;aj++){K=(H+aa)<<2;u+=(P.r=(C=w[K]))*(V=B-aj);v+=(P.g=(J=w[K+1]))*V;Q+=(P.b=(L=w[K+2]))*V;af+=(P.a=(M=w[K+3]))*V;W+=C;ab+=J;I+=L;F+=M;P=P.next;if(aj<ae){H+=q}}K=aa;ai=U;Y=A;for(Z=0;Z<s;Z++){ag=K<<2;w[ag+3]=M=(af*N)>>t;if(M>0){M=255/M;w[ag]=((u*N)>>t)*M;w[ag+1]=((v*N)>>t)*M;w[ag+2]=((Q*N)>>t)*M}else{w[ag]=w[ag+1]=w[ag+2]=0}u-=G;v-=S;Q-=O;af-=r;G-=ai.r;S-=ai.g;O-=ai.b;r-=ai.a;ag=(aa+(((ag=Z+B)<ae?ag:ae)*q))<<2;u+=(W+=(ai.r=w[ag]));v+=(ab+=(ai.g=w[ag+1]));Q+=(I+=(ai.b=w[ag+2]));af+=(F+=(ai.a=w[ag+3]));ai=ai.next;G+=(C=Y.r);S+=(J=Y.g);O+=(L=Y.b);r+=(M=Y.a);W-=C;ab-=J;I-=L;F-=M;Y=Y.next;K+=q}}am.putImageData(ah,T,R)};function n(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}return o})();Events=(function(){var o=Array.prototype.slice;var n=/\s+/;var m={on:function(s,w,r){var q,u,t,p,v;if(!w){return this}s=s.split(n);q=this._callbacks||(this._callbacks={});while(u=s.shift()){v=q[u];t=v?v.tail:{};t.next=p={};t.context=r;t.callback=w;q[u]={tail:p,next:v?v.next:t}}return this},off:function(w,u,q){var p,x,r,t,s,v;if(!(x=this._callbacks)){return}if(!(w||u||q)){delete this._callbacks;return this}w=w?w.split(n):_.keys(x);while(p=w.shift()){r=x[p];delete x[p];if(!r||!(u||q)){continue}t=r.tail;while((r=r.next)!==t){s=r.callback;v=r.context;if((u&&s!==u)||(q&&v!==q)){this.on(p,s,v)}}}return this},trigger:function(s){var w,v,r,q,p,u,t;if(!(r=this._callbacks)){return this}u=r.all;s=s.split(n);t=o.call(arguments,1);while(w=s.shift()){if(v=r[w]){q=v.tail;while((v=v.next)!==q){v.callback.apply(v.context||this,t)}}if(v=u){q=v.tail;p=[w].concat(t);while((v=v.next)!==q){v.callback.apply(v.context||this,p)}}}return this}};m.bind=m.on;m.unbind=m.off;return m})();(function(p){var o=function(){return o};o.cssColor=function(q){if(q.length==3){return"rgb("+e(q[0])+","+e(q[1])+","+e(q[2])+")"}return"rgba("+e(q[0])+","+e(q[1])+","+e(q[2])+","+q[3]+")"};o.clamp=d=function(s,r,q){return(s<r?r:s>q?q:s)};o.opposite=function(r){if(!$.isArray(r)){r=o.parseColorString(r)}var q=o.rgb2hsl(r);q[0]=(q[0]+180)%360;q[1]=100-q[1];q[2]=100-q[2];var s=o.hsl2rgb(q);if(r.length===4){s.push(r[3])}return s};o.rgba2rgb=function(u){if(u.length===3||u[3]===255){return u}var w=u[0],v=u[1],q=u[2],s=u[3],t=[];t[0]=(s*w)+(255-s*255);t[1]=(s*v)+(255-s*255);t[2]=(s*q)+(255-s*255);return t};o.rgb2hex=function(q){q=o.rgba2rgb(q);return"#"+n(q[0])+n(q[1])+n(q[2])};o.hex2rgb=function(q){return o.parseColorString(q)};o.rgb2hsl=function(y){var q=y[0]/255,v=y[1]/255,z=y[2]/255,A=i(q,v,z),w=b(q,v,z),x,u,B,t=(A+w)/2;if(A==w){u=B=0}else{x=A-w;B=t>0.5?x/(2-A-w):x/(A+w);switch(i){case q:u=(v-z)/x+(v<z?6:0);break;case v:u=(z-q)/x+2;break;case z:u=(q-v)/x+4;break}u/=6}return[u,B*100,t*100]};o.hex2hsl=function(q){return o.rgb2hsl(o.hex2rgb(q))};o.hsl2rgb=function(y){var A,z,w;var q,v,x;var u=y[0],B=y[1]/100,t=y[2]/100;if(B==0){q=v=x=(t*255)}else{if(t<=0.5){z=t*(B+1)}else{z=t+B-t*B}A=t*2-z;w=u/360;q=m(A,z,w+1/3);v=m(A,z,w);x=m(A,z,w-1/3)}return[q,v,x]};function n(q){q=parseInt(q,10)||0;q=d(q,0,255).toString(16);if(q.length===1){q="0"+q}return q}function m(t,s,r){var q;if(r<0){r+=1}else{if(r>1){r-=1}}if(6*r<1){q=t+(s-t)*r*6}else{if(2*r<1){q=s}else{if(3*r<2){q=t+(s-t)*(2/3-r)*6}else{q=t}}}return 255*q}o.parseColorString=function(w){function A(E){var r=document.createElement("a");r.style.color=E;document.body.appendChild(r);var D=getComputedStyle(r).color;document.body.removeChild(r);return D}var x=false,q,u,y,z;w=A(w);var v=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(r){return[parseInt(r[1]),parseInt(r[2]),parseInt(r[3]),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(r){return[parseInt(r[1]),parseInt(r[2]),parseInt(r[3]),parseFloat(r[4])]}}];for(var t=0;t<v.length;t++){var C=v[t].re;var s=v[t].process;var B=C.exec(w);if(B){channels=s(B);q=channels[0];u=channels[1];y=channels[2];z=channels[3];x=true}}q=(q<0||isNaN(q))?0:((q>255)?255:q);u=(u<0||isNaN(u))?0:((u>255)?255:u);y=(y<0||isNaN(y))?0:((y>255)?255:y);z=(z<0||isNaN(z))?0:((z>1)?1:z);return x?[q,u,y,z]:[0,0,0,1]};p.util=o})(TeledrawCanvas);(function(s){s.canvases=[];var q=0;var r={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1000,strokeSoftness:0};var n={last:null,currentTool:"pencil",previousTool:"pencil",tool:null,mouseDown:h,mouseOver:h,width:null,height:null,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5000,maxHistory:10,minStrokeSize:500,maxStrokeSize:10000,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8};var m=m||function(t,u){var v=document.createElement("canvas");v.width=t;v.height=u;return v};var o=function(v,D){var C=this,x=C.element=$(v),t=C.state=$.extend({},n,D);if(typeof x.get(0).getContext!="function"){alert("Your browser does not support HTML canvas!");return}t.width=t.displayWidth||t.width||parseInt(x.attr("width"));t.height=t.displayHeight||t.height||parseInt(x.attr("height"));t.fullWidth=t.fullWidth||t.width;t.fullHeight=t.fullHeight||t.height;if(t.width/t.height!==t.fullWidth/t.fullHeight){t.fullHeight=t.fullWidth*t.height/t.width}x.attr({width:t.width,height:t.height});C._displayCanvas=$(x).get(0);C._canvas=new m(t.fullWidth,t.fullHeight);C.history=new s.History(this);C.defaults();C.zoom(0);C.history.checkpoint();s.canvases[q++]=C;var A;x.css({width:t.width,height:t.height}).bind("gesturestart",function(E){if(t.tool.name=="grab"){A=t.currentZoom}}).bind("gesturechange",function(E){if(t.tool.name=="grab"){var F=t.last;C.zoom(A*E.originalEvent.scale,F.xd,F.yd)}E.preventDefault()}).bind("gestureend",function(E){}).bind("dblclick",function(E){var F=u(E);t.tool.dblclick(F)}).bind("mouseenter",function(E){var F=u(E);t.tool.enter(t.mouseDown,F);t.last=F;t.mouseOver=a}).bind("mousedown touchstart",y).bind("mouseleave",function(E){var F=u(E);t.tool.leave(t.mouseDown,F);t.mouseOver=h});$(window).bind("mousemove touchmove",B);var w=null;function B(F){if(F.type=="touchmove"&&F.originalEvent.touches.length>1){return a}if(w=="touchmove"&&F.type=="mousemove"){return}target=$(F.target).parents().andSelf();if(target.is(x)||t.mouseDown){var E=u(F);t.tool.move(t.mouseDown,t.last,E);t.last=E;C.trigger("mousemove",E,F);w=F.type;F.preventDefault()}}function y(F){var E=t.last=u(F);if(F.type=="touchstart"&&F.originalEvent.touches.length>1){return a}$(window).one("mouseup touchend",z);t.mouseDown=a;t.tool.down(E);C.trigger("mousedown",E,F);document.onselectstart=function(){return h};F.preventDefault()}function z(E){if(E.type=="touchend"&&E.originalEvent.touches.length>1){return a}t.mouseDown=h;t.tool.up(t.last);C.trigger("mouseup",t.last,E);document.onselectstart=function(){return a};E.preventDefault()}function u(G){var H=x.offset(),F=G.pageX||G.originalEvent.touches&&G.originalEvent.touches[0].pageX,E=G.pageY||G.originalEvent.touches&&G.originalEvent.touches[0].pageY;return{x:e((F-H.left)/t.currentZoom)+t.currentOffset.x||0,y:e((E-H.top)/t.currentZoom)+t.currentOffset.y||0,xd:e(F-H.left)||0,yd:e(E-H.top)||0}}};var p=o.prototype;p.setRGBAArrayColor=function(u){var v=this.state;if(u.length===4){v.globalAlpha=u.pop()}for(var t=u.length;t<3;++t){u.push(0)}v.color=u;this.updateTool()};p.updateTool=function(){var t=1+e(f(this.state.strokeSize/1000,2));var u=e(f(this.state.strokeSoftness,1.3)/300*t);this.state.lineWidth=t;this.state.shadowBlur=u};p.updateDisplayCanvas=function(){var z=this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d")),y=this.state.currentOffset,w=this.state.currentZoom,u=z.canvas.width,x=z.canvas.height,t=u/w,v=x/w;z.clearRect(0,0,u,x);this.trigger("display.update:before");z.drawImage(this._canvas,y.x,y.y,t,v,0,0,u,x);this.trigger("display.update:after")};p.canvas=function(){return this._canvas};p.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))};p.cursor=function(u){if(!u){u="default"}var t=u.split(/,\s*/);do{u=t.shift();this.element.css("cursor",u)}while(u.length&&this.element.css("cursor")!=u);return this};p.clear=function(v){var u=this,t=u.ctx();t.clearRect(0,0,t.canvas.width,t.canvas.height);if(v!==a){u.history.checkpoint()}u.updateDisplayCanvas();return u};p.defaults=function(){var t=this;t.setTool("pencil");t.setAlpha(r.alpha);t.setColor(r.color);t.setStrokeSize(r.strokeSize);t.setStrokeSoftness(r.strokeSoftness);return t};p.toDataURL=function(t,A,v,z){if(v&&z){v=parseInt(v);z=parseInt(z);t=t!==g?t:0;A=A!==g?A:0;var u=$("<canvas>").attr({width:v,height:z}).get(0);u.getContext("2d").drawImage(this.canvas(),t,A,v,z,0,0,v,z);return u.toDataURL()}return this.canvas().toDataURL()};p.getTempCanvas=function(t,v){var u=$("<canvas>").get(0);u.width=t||this._canvas.width;u.height=v||this._canvas.height;return u};p.fromDataURL=function(w,t){var v=this,u=new Image();u.onload=function(){v.clear(a);v.ctx().drawImage(u,0,0);v.updateDisplayCanvas();if(typeof t=="function"){t.call(v)}};u.src=w;return v};p.getImageData=function(){var t=this.ctx();return t.getImageData(0,0,t.canvas.width,t.canvas.height)};p.putImageData=function(t){this.ctx().putImageData(t,0,0);this.updateDisplayCanvas();return this};p.getColor=function(){return this.state.color.slice()};p.setColor=function(t){if(!$.isArray(t)){t=s.util.parseColorString(t)}this.setRGBAArrayColor(t);return this};p.setAlpha=function(t){this.state.globalAlpha=d(t,0,1);return this};p.getAlpha=function(){return this.state.globalAlpha};p.setStrokeSize=function(t){this.state.strokeSize=d(t,this.state.minStrokeSize,this.state.maxStrokeSize);this.updateTool();return this};p.setStrokeSoftness=function(t){this.state.strokeSoftness=d(t,this.state.minStrokeSoftness,this.state.maxStrokeSoftness);this.updateTool();return this};p.setTool=function(t){this.state.previousTool=this.state.currentTool;this.state.currentTool=t;if(!s.tools[t]){throw new Error('Tool "'+t+'" not defined.')}this.state.tool=new s.tools[t](this);this.updateTool();return this};p.previousTool=function(){return this.setTool(this.state.previousTool)};p.undo=function(){this.history.undo();return this};p.redo=function(){this.history.redo();return this};p.resize=function(t,v){var u=this;if(t/v!==u._canvas.width/u._canvas.height){throw new Error("Not the same aspect ratio!")}u._displayCanvas.width=t;u._displayCanvas.height=v;u.updateDisplayCanvas();return u};p.zoom=function(w,B,A){var D=this,v=0,u=0,C=D.state.currentZoom,E=D._displayCanvas.width,t=D._displayCanvas.height;B=d(B||E/2,0,E);A=d(A||t/2,0,t);w=d(w||0,E/D._canvas.width,D.state.maxZoom);if(w!==C){if(w>C){v=-(E/C-E/w)/2-(B-E/2)/C;u=-(t/C-t/w)/2-(A-t/2)/C}else{if(w<C){v=(E/w-E/C)/2;u=(t/w-t/C)/2}}v*=w;u*=w}D.state.currentZoom=w;D.trigger("zoom",w,C);D.pan(v,u);D.updateDisplayCanvas();return D};p.pan=function(w,v,z){var D=this,C=D.state.currentZoom,u=D.state.currentOffset.x,t=D.state.currentOffset.y,B=D._canvas.width-D._displayCanvas.width/C,A=D._canvas.height-D._displayCanvas.height/C;w=z===a?w/C:u-(w||0)/C;v=z===a?v/C:t-(v||0)/C;D.state.currentOffset={x:e(d(w,0,B)),y:e(d(v,0,A))};D.trigger("pan",w,v);D.updateDisplayCanvas();return D};$.extend(p,Events);s.api=o})(TeledrawCanvas);(function(n){var m=function(o){this.canvas=o;this.rev=0;this.clear()};m.prototype.clear=function(){this.past=[];this.current=null;this.future=[]};m.prototype.checkpoint=function(){if(this.past.length>this.canvas.state.maxHistory){this.past.shift()}if(this.current){this.past.push(this.current)}this.current=new n.Snapshot(this.canvas);this.future=[];this.rev++};m.prototype.undo=function(){if(this._move(this.past,this.future)){this.rev--}};m.prototype.redo=function(){if(this._move(this.future,this.past)){this.rev++}};m.prototype._move=function(p,o){if(!p.length){return h}if(!this.current){return h}o.push(this.current);this.current=p.pop();this.current.restore();return a};n.History=m})(TeledrawCanvas);(function(n){var m=function(o){this.canvas=o;this._snapshotBufferCanvas()};m.prototype.restore=function(q){var o,p;if(q){o=q.tl;p=q.br}else{o={x:0,y:0};p={x:this.canvas.canvas().width,y:this.canvas.canvas().height}}this._restoreBufferCanvas(o,p);this.canvas.updateDisplayCanvas(o,p)};m.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()};m.prototype._snapshotBufferCanvas=function(){this.buffer=this.canvas.getTempCanvas();this.buffer.getContext("2d").drawImage(this.canvas.canvas(),0,0)};m.prototype._restoreBufferCanvas=function(q,r){var p=this.canvas.ctx();var o=r.x-q.x,s=r.y-q.y;if(o===0||s===0){return}p.clearRect(q.x,q.y,o,s);p.drawImage(this.buffer,q.x,q.y,o,s,q.x,q.y,o,s)};m.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()};m.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)};n.Snapshot=m})(TeledrawCanvas);(function(n){var m=function(o){this.canvas=o};m.prototype.start=function(o){};m.prototype.move=function(p,o){};m.prototype.end=function(){};m.prototype.draw=function(){};m.prototype.save=function(){this.snapshot=new n.Snapshot(this.canvas)};m.prototype.restore=function(){this.snapshot.restore(this)};n.Stroke=m})(TeledrawCanvas);(function(n){var m=function(){};m.prototype.down=function(o){};m.prototype.up=function(o){};m.prototype.move=function(o,q,p){};m.prototype.dblclick=function(o){};m.prototype.enter=function(o,p){};m.prototype.leave=function(o,p){};m.prototype.keydown=function(p,o){};m.prototype.keyup=function(p,o){};m.prototype.preview=function(){};m.prototype.alt_down=function(){};m.prototype.alt_up=function(){};m.createTool=function(p,s,q){var r=function(t){this.canvas=t;this.ctx=t.ctx();this.color=t.getColor();this.color.push(t.getAlpha());this.points=[];this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height};this.br={x:0,y:0};this.tool={}};r.prototype=new n.Stroke();var o=function(t){this.canvas=t;t.cursor(s);this.name=p;this.cursor=s||"default";this.currentStroke=null;if(typeof q=="function"){q.call(this)}};o.prototype=new m();o.prototype.down=function(t){this.currentStroke=new r(this.canvas);this.currentStroke.tool=this;this.currentStroke.save();this.currentStroke.points.push(t);this.currentStroke.start(t);this._updateBoundaries(t);this.draw()};o.prototype.move=function(t,v,u){if(t&&this.currentStroke){this.currentStroke.points.push(u);this.currentStroke.move(v,u);this._updateBoundaries(u);this.draw()}};o.prototype.up=function(t){if(this.currentStroke){this.currentStroke.end(t);this.draw();this.currentStroke=null;this.canvas.history.checkpoint()}this.canvas.trigger("tool.up")};o.prototype.draw=function(){this.currentStroke.ctx.save();this.currentStroke.restore();this.currentStroke.draw();this.canvas.updateDisplayCanvas(this.currentStroke.tl,this.currentStroke.br);this.currentStroke.ctx.restore()};o.prototype._updateBoundaries=function(w){var v=this.currentStroke,t=v.ctx.canvas,u=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;if(w.x-u<v.tl.x){v.tl.x=d(e(w.x-u),0,t.width)}if(w.x+u>v.br.x){v.br.x=d(e(w.x+u),0,t.width)}if(w.y-u<v.tl.y){v.tl.y=d(e(w.y-u),0,t.height)}if(w.y+u>v.br.y){v.br.y=d(e(w.y+u),0,t.height)}};o.stroke=r;r.tool=o;n.tools[p]=o;return o};n.Tool=m;n.tools={}})(TeledrawCanvas);(function(p){var m=p.Tool.createTool("ellipse","crosshair"),n=m.stroke.prototype;n.bgColor=[255,255,255];n.bgAlpha=0;n.lineWidth=1;n.start=function(q){this.first=q};n.move=function(r,q){this.second=q};n.end=function(q){this.second=q};n.draw=function(){if(!this.first||!this.second){return}var B=this,z=B.first.x,v=B.first.y,A=B.second.x-z,t=B.second.y-v,C=B.ctx,q=B.canvas.state,D=q.shadowOffset,s=q.shadowBlur,u=q.lineWidth,r=p.util.cssColor(q.color);C.lineJoin=C.lineCap="round";C.globalAlpha=q.globalAlpha;C.fillStyle=C.strokeStyle=r;C.miterLimit=100000;if(B.tool.shiftKey){t=B.second.y>v?l(A):-l(A)}if(B.tool.fill){o(C,z,v,A,t);C.fill()}else{if(s>0){C.shadowColor=r;C.shadowOffsetX=C.shadowOffsetY=D;C.shadowBlur=s;C.translate(-D,-D)}C.lineWidth=u;o(C,z,v,A,t);C.stroke()}};function o(s,q,v,r,t){var u=0.5522848;ox=(r/2)*u,oy=(t/2)*u,xe=q+r,ye=v+t,xm=q+r/2,ym=v+t/2;s.beginPath();s.moveTo(q,ym);s.bezierCurveTo(q,ym-oy,xm-ox,v,xm,v);s.bezierCurveTo(xm+ox,v,xe,ym-oy,xe,ym);s.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);s.bezierCurveTo(xm-ox,ye,q,ym+oy,q,ym);s.closePath()}})(TeledrawCanvas);(function(n){var m=n.Tool.createTool("eraser","crosshair");m.stroke.prototype.lineWidth=1;m.stroke.prototype.lineCap="round";m.stroke.prototype.draw=function(){this.color=[255,255,255,255];this.ctx.globalCompositeOperation="destination-out";n.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(o){var m=function(){this.previewContainer=$("<div>").css({position:"absolute",width:10,height:10,border:"1px solid black"});$("body").append(this.previewContainer.hide());if(this.canvas.state.mouseOver){this.previewContainer.show()}};var n=o.Tool.createTool("eyedropper","crosshair",m);n.prototype.pick=function(r){var q=this.previewContainer,t,s=this.canvas.element.offset(),p=this.canvas.ctx().getImageData(r.x,r.y,1,1).data;this.color=o.util.rgba2rgb(Array.prototype.slice.call(p));this.previewContainer.offset({left:s.left+r.xd+15,top:s.top+r.yd+5});var t=o.util.rgb2hsl(this.color)[2];q.css({background:o.util.cssColor(this.color),"border-color":t>=50?"#000":"#888"});if(this.canvas.state.mouseOver){q[0].style.display="none";q[0].offsetHeight;q[0].style.display="block"}else{q.hide()}};n.prototype.enter=function(){this.previewContainer.show()};n.prototype.leave=function(){this.previewContainer.hide()};n.prototype.move=function(r,q,p){this.pick(p)};n.prototype.down=function(p){this.pick(p)};n.prototype.up=function(p){this.pick(p);this.canvas.setColor(this.color);this.previewContainer.remove();this.canvas.previousTool()}})(TeledrawCanvas);(function(t){var o=t.Tool.createTool("fill","crosshair");var m=Math.abs;o.blur=true;o.stroke.prototype.bgColor=[255,255,255];o.stroke.prototype.bgAlpha=255;o.stroke.prototype.end=function(A){var E=this.ctx.canvas.width,z=this.ctx.canvas.height;var v=this.ctx.getImageData(0,0,E,z);var B=this.ctx.createImageData(E,z);var x=this.color;x[3]*=255;s(v.data,B.data,A,E,z,this.color);this.tmp_canvas=$("<canvas>").attr({width:E,height:z}).get(0);var D=this.tmp_canvas.getContext("2d");D.putImageData(B,0,0);if(o.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);var C=D.getImageData(0,0,E,z);for(var y=0,u=C.data.length;y<u;y+=4){if(C.data[y+3]/255>0.2){C.data[y]=x[0];C.data[y+1]=x[1];C.data[y+2]=x[2];C.data[y+3]=Math.min(x[3],C.data[y+3]*3)}}D.putImageData(C,0,0)}};o.stroke.prototype.draw=function(){if(this.tmp_canvas){this.ctx.drawImage(this.tmp_canvas,0,0)}};function s(A,z,O,G,N,H){var B=[[O.x,O.y]];var I=q(A,O.x,O.y,G);var M=o.tolerance;var C,u;var L,K,J,F,D,v;var E=t.util.opposite(I);E[3]/=2;while(B.length){J=B.pop();F=J[0];v=D=J[1];while(v>=0&&p(q(A,F,v,G),I)){v--}v++;C=u=false;while(v<N&&p(q(A,F,v,G),I)){n(A,F,v,G,E);n(z,F,v,G,H);if(!C&&F>0&&p(q(A,F-1,v,G),I)){B.push([F-1,v]);C=true}else{if(C&&F>0&&p(q(A,F-1,v,G),I)){C=false}}if(!u&&F<G-1&&p(q(A,F+1,v,G),I)){B.push([F+1,v]);u=true}else{if(u&&F<G-1&&p(q(A,F+1,v,G),I)){u=false}}v++}}}function q(z,u,B,v){var A=(B*v+u)*4;return[z[A],z[A+1],z[A+2],z[A+3]]}function n(A,u,C,v,z){var B=(C*v+u)*4;A[B]=z[0];A[B+1]=z[1];A[B+2]=z[2];A[B+3]=z[3]}function r(v,u){return m(v[0]-u[0])+m(v[1]-u[1])+m(v[2]-u[2])+m(v[3]-u[3])}function p(v,u){return r(v,u)<5}})(TeledrawCanvas);(function(p){var n="hand, grab, -moz-grab, -webkit-grab, move",m="grabbing, -moz-grabbing, -webkit-grabbing, move";var o=p.Tool.createTool("grab",n);o.prototype.move=function(t,s,r){var q=this;if(t){clearTimeout(this._clearDeltasId);cancelAnimationFrame(this._momentumId);this.dx=r.xd-s.xd;this.dy=r.yd-s.yd;this.canvas.pan(this.dx,this.dy);this._clearDeltasId=setTimeout(function(){q.dx=q.dy=0},100)}};o.prototype.down=function(q){cancelAnimationFrame(this._momentumId);this.canvas.cursor(m)};o.prototype.up=function(q){cancelAnimationFrame(this._momentumId);this.momentum(this.dx,this.dy);this.dx=this.dy=0;this.canvas.cursor(n)};o.prototype.dblclick=function(q){cancelAnimationFrame(this._momentumId);this.dx=this.dy=0;this.canvas.zoom(this.canvas.state.currentZoom*2,q.xd,q.yd)};o.prototype.momentum=function(s,q){var r=this;if(Math.abs(s)>=1||Math.abs(q)>=1){s/=1.1;q/=1.1;this.canvas.pan(s,q);this._momentumId=requestAnimationFrame(function(){r.momentum(s,q)})}}})(TeledrawCanvas);(function(){var n=0;var o=["ms","moz","webkit","o"];for(var m=0;m<o.length&&!window.requestAnimationFrame;++m){window.requestAnimationFrame=window[o[m]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[o[m]+"CancelAnimationFrame"]||window[o[m]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(t,q){var p=new Date().getTime();var r=Math.max(0,16-(p-n));var s=window.setTimeout(function(){t(p+r)},r);n=p+r;return s}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(p){clearTimeout(p)}}}());(function(n){var m=n.Tool.createTool("line","crosshair");m.stroke.prototype.lineWidth=1;m.stroke.prototype.lineCap="round";m.stroke.prototype.bgColor=[255,255,255];m.stroke.prototype.bgAlpha=0;m.stroke.prototype.start=function(o){this.first=o};m.stroke.prototype.move=function(p,o){this.second=o};m.stroke.prototype.end=function(o){this.second=o};m.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var s=$.extend({},this.first),q=$.extend({},this.second),p,o,t,r=Math.PI;if(this.tool.shiftKey){o=q.x-s.x;t=q.y-s.y;p=Math.atan2(t,o);if((p>=-r*7/8&&p<-r*5/8)||(p>=-r*3/8&&p<-r/8)){q.y=s.y-Math.abs(o)}else{if((p>=-r*5/8&&p<-r*3/8)||(p>=r*3/8&&p<r*5/8)){q.x=s.x}else{if((p>=r/8&&p<r*3/8)||(p>=r*5/8&&p<r*7/8)){q.y=s.y+Math.abs(o)}else{q.y=s.y}}}}this.points=[s,q];n.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(n){var m=n.Tool.createTool("pencil","crosshair");m.stroke.prototype.lineWidth=1;m.stroke.prototype.lineCap="round";m.stroke.prototype.smoothing=true;m.stroke.prototype.draw=function(){var o=this.canvas.state,x=this.ctx,w=this.points,p,u,z,y=o.shadowOffset,r=o.shadowBlur,t=o.lineWidth,q=n.util.cssColor(o.color);x.globalAlpha=o.globalAlpha;x.fillStyle=x.strokeStyle=q;x.miterLimit=100000;if(r>0){x.shadowColor=q;x.shadowOffsetX=x.shadowOffsetY=y;x.shadowBlur=r;x.translate(-y,-y)}if(w.length===1){switch(this.lineCap){case"round":x.beginPath();x.arc(w[0].x,w[0].y,t/2,0,2*Math.PI,true);x.closePath();x.fill();break;case"square":x.fillRect(w[0].x-t/2,w[0].y-t/2,t,t)}}else{if(w.length>1){x.lineJoin="round";x.lineCap=this.lineCap;x.lineWidth=t;x.beginPath();x.moveTo(w[0].x,w[0].y);p=w[0];u=null;for(var s=1;s<w.length;++s){z=w[s];if(u&&(u.x==z.x||u.y==z.y)){z.x+=0.1;z.y+=0.1}if(this.smoothing){var v={x:(p.x+z.x)/2,y:(p.y+z.y)/2};x.quadraticCurveTo(p.x,p.y,v.x,v.y)}else{x.lineTo(z.x,z.y)}u=p;p=w[s]}if(this.smoothing){x.quadraticCurveTo(p.x,p.y,z.x,z.y)}x.stroke()}}}})(TeledrawCanvas);(function(o){var n=o.Tool.createTool("rectangle","crosshair");n.stroke.prototype.bgColor=[255,255,255];n.stroke.prototype.bgAlpha=0;n.stroke.prototype.lineWidth=1;n.stroke.prototype.start=function(p){this.first=p};n.stroke.prototype.move=function(q,p){this.second=p};n.stroke.prototype.end=function(p){this.second=p};n.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var t=this.first,q=$.extend({},this.second),x=this.ctx,p=this.canvas.state,y=p.shadowOffset,s=p.shadowBlur,u=p.lineWidth,r=o.util.cssColor(p.color);x.lineJoin=x.lineCap="round";x.globalAlpha=p.globalAlpha;x.fillStyle=x.strokeStyle=r;x.miterLimit=100000;if(this.tool.shiftKey){var v=Math.abs(q.x-t.x);q.y=t.y+(q.y>t.y?v:-v)}if(this.tool.fill){m(x,t,q);x.fill()}else{if(s>0){x.shadowColor=r;x.shadowOffsetX=x.shadowOffsetY=y;x.shadowBlur=s;x.translate(-y,-y)}x.lineWidth=u;m(x,t,q);x.stroke()}};function m(p,r,q){p.beginPath();p.moveTo(r.x,r.y);p.lineTo(q.x,r.y);p.lineTo(q.x,q.y);p.lineTo(r.x,q.y);p.lineTo(r.x,r.y)}})(TeledrawCanvas)})();