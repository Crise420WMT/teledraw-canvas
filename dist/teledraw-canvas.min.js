/*! Teledraw Canvas - v0.14.0 | (c) 2016 Cameron Lakenen */
!function(){function a(b,d,f){if("mouseenter"===d||"mouseleave"===d){var g="mouseenter"===d,h=g?"fromElement":"toElement";return d=g?"mouseover":"mouseout",void a(b,d,function(a){a=a||window.event;var c=a.target||a.srcElement,d=a.relatedTarget||a[h];if((b===c||e(b,c))&&!e(b,d))return f.apply(this,arguments)})}if(b.addEventListener)b.addEventListener(d,f,!1);else{f.$$guid||(f.$$guid=a.guid++),b.events||(b.events={});var i=b.events[d];i||(i=b.events[d]={},b["on"+d]&&(i[0]=b["on"+d])),i[f.$$guid]=f,b["on"+d]=c}}function b(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.events&&a.events[b]&&delete a.events[b][c.$$guid]}function c(a){var b=!0;a=a||d(((this.ownerDocument||this.document||this).parentWindow||window).event);var c=this.events[a.type];for(var e in c)this.$$handleEvent=c[e],this.$$handleEvent(a)===!1&&(b=!1);return b}function d(a){return a.preventDefault=d.preventDefault,a.stopPropagation=d.stopPropagation,a}function e(a,b){return a.contains?a.contains(b):!!(16&a.compareDocumentPosition(b))}function f(a,b,c){return a instanceof f?f.create(a):(this.x=a||0,this.y=b||0,void(this.z=c||0))}var g,h=Math,j=h.abs,k=(h.sqrt,h.floor),l=(h.round,h.min),m=h.max,n=h.pow;window.TeledrawCanvas=function(a,b){return new TeledrawCanvas.api(a,b)},stackBlurCanvasRGBA=function(){function a(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var b=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],d=function(d,e){if(!(isNaN(e)||e<1)){e|=0;var f,g=0,h=0,i=d.width,j=d.height,k=d.getContext("2d");try{try{f=k.getImageData(g,h,i,j)}catch(a){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),f=k.getImageData(g,h,i,j)}catch(a){throw alert("Cannot access local image"),new Error("unable to access local image data: "+a)}}}catch(a){throw alert("Cannot access image"),new Error("unable to access image data: "+a)}var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=f.data,K=e+e+1,L=i-1,M=j-1,N=e+1,O=N*(N+1)/2,P=new a,Q=P;for(n=1;n<K;n++)if(Q=Q.next=new a,n==N)var R=Q;Q.next=P;var S=null,T=null;r=q=0;var U=b[e],V=c[e];for(m=0;m<j;m++){for(A=B=C=D=s=t=u=v=0,w=N*(E=J[q]),x=N*(F=J[q+1]),y=N*(G=J[q+2]),z=N*(H=J[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P,n=0;n<N;n++)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;for(n=1;n<N;n++)o=q+((L<n?L:n)<<2),s+=(Q.r=E=J[o])*(I=N-n),t+=(Q.g=F=J[o+1])*I,u+=(Q.b=G=J[o+2])*I,v+=(Q.a=H=J[o+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next;for(S=P,T=R,l=0;l<i;l++)J[q+3]=H=v*U>>V,0!=H?(H=255/H,J[q]=(s*U>>V)*H,J[q+1]=(t*U>>V)*H,J[q+2]=(u*U>>V)*H):J[q]=J[q+1]=J[q+2]=0,s-=w,t-=x,u-=y,v-=z,w-=S.r,x-=S.g,y-=S.b,z-=S.a,o=r+((o=l+e+1)<L?o:L)<<2,A+=S.r=J[o],B+=S.g=J[o+1],C+=S.b=J[o+2],D+=S.a=J[o+3],s+=A,t+=B,u+=C,v+=D,S=S.next,w+=E=T.r,x+=F=T.g,y+=G=T.b,z+=H=T.a,A-=E,B-=F,C-=G,D-=H,T=T.next,q+=4;r+=i}for(l=0;l<i;l++){for(B=C=D=A=t=u=v=s=0,q=l<<2,w=N*(E=J[q]),x=N*(F=J[q+1]),y=N*(G=J[q+2]),z=N*(H=J[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P,n=0;n<N;n++)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;for(p=i,n=1;n<=e;n++)q=p+l<<2,s+=(Q.r=E=J[q])*(I=N-n),t+=(Q.g=F=J[q+1])*I,u+=(Q.b=G=J[q+2])*I,v+=(Q.a=H=J[q+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next,n<M&&(p+=i);for(q=l,S=P,T=R,m=0;m<j;m++)o=q<<2,J[o+3]=H=v*U>>V,H>0?(H=255/H,J[o]=(s*U>>V)*H,J[o+1]=(t*U>>V)*H,J[o+2]=(u*U>>V)*H):J[o]=J[o+1]=J[o+2]=0,s-=w,t-=x,u-=y,v-=z,w-=S.r,x-=S.g,y-=S.b,z-=S.a,o=l+((o=m+N)<M?o:M)*i<<2,s+=A+=S.r=J[o],t+=B+=S.g=J[o+1],u+=C+=S.b=J[o+2],v+=D+=S.a=J[o+3],S=S.next,w+=E=T.r,x+=F=T.g,y+=G=T.b,z+=H=T.a,A-=E,B-=F,C-=G,D-=H,T=T.next,q+=i}k.putImageData(f,g,h)}};return d}(),Events=function(){var a=Array.prototype.slice,b=/\s+/,c={on:function(a,c,d){var e,f,g,h,i;if(!c)return this;for(a=a.split(b),e=this._callbacks||(this._callbacks={});f=a.shift();)i=e[f],g=i?i.tail:{},g.next=h={},g.context=d,g.callback=c,e[f]={tail:h,next:i?i.next:g};return this},off:function(a,c,d){var e,f,g,h,i,j;if(f=this._callbacks){if(!(a||c||d))return delete this._callbacks,this;for(a=a?a.split(b):_.keys(f);e=a.shift();)if(g=f[e],delete f[e],g&&(c||d))for(h=g.tail;(g=g.next)!==h;)i=g.callback,j=g.context,(c&&i!==c||d&&j!==d)&&this.on(e,i,j);return this}},trigger:function(c){var d,e,f,g,h,i,j;if(!(f=this._callbacks))return this;for(i=f.all,c=c.split(b),j=a.call(arguments,1);d=c.shift();){if(e=f[d])for(g=e.tail;(e=e.next)!==g;)e.callback.apply(e.context||this,j);if(e=i)for(g=e.tail,h=[d].concat(j);(e=e.next)!==g;)e.callback.apply(e.context||this,h)}return this}};return c.bind=c.on,c.unbind=c.off,c}(),a.guid=1,d.preventDefault=function(){this.returnValue=!1},d.stopPropagation=function(){this.cancelBubble=!0},function(){function a(b,c,d){if(b===c)return 0!==b||1/b==1/c;if(null==b||null==c)return b===c;if(b._chain&&(b=b._wrapped),c._chain&&(c=c._wrapped),b.isEqual&&x.isFunction(b.isEqual))return b.isEqual(c);if(c.isEqual&&x.isFunction(c.isEqual))return c.isEqual(b);var e=j.call(b);if(e!=j.call(c))return!1;switch(e){case"[object String]":return b==String(c);case"[object Number]":return b!=+b?c!=+c:0==b?1/b==1/c:b==+c;case"[object Date]":case"[object Boolean]":return+b==+c;case"[object RegExp]":return b.source==c.source&&b.global==c.global&&b.multiline==c.multiline&&b.ignoreCase==c.ignoreCase}if("object"!=typeof b||"object"!=typeof c)return!1;for(var f=d.length;f--;)if(d[f]==b)return!0;d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=b.length,h=g==c.length)for(;g--&&(h=g in b==g in c&&a(b[g],c[g],d)););}else{if("constructor"in b!="constructor"in c||b.constructor!=c.constructor)return!1;for(var i in b)if(x.has(b,i)&&(g++,!(h=x.has(c,i)&&a(b[i],c[i],d))))break;if(h){for(i in c)if(x.has(c,i)&&!g--)break;h=!g}}return d.pop(),h}var b=this,c=b._,d={},e=Array.prototype,f=Object.prototype,g=Function.prototype,h=e.slice,i=e.unshift,j=f.toString,k=f.hasOwnProperty,l=e.forEach,m=e.map,n=e.reduce,o=e.reduceRight,p=e.filter,q=e.every,r=e.some,s=e.indexOf,t=e.lastIndexOf,u=Array.isArray,v=Object.keys,w=g.bind,x=function(a){return new I(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):b._=x,x.VERSION="1.3.3";var y=x.each=x.forEach=function(a,b,c){if(null!=a)if(l&&a.forEach===l)a.forEach(b,c);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(c,a[e],e,a)===d)return}else for(var g in a)if(x.has(a,g)&&b.call(c,a[g],g,a)===d)return};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),a.length===+a.length&&(d.length=a.length),d)},x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError("Reduce of empty array with no initial value");return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=x.toArray(a).reverse();return d&&!e&&(b=x.bind(b,d)),e?x.reduce(f,b,c,d):x.reduce(f,b)},x.find=x.detect=function(a,b,c){var d;return z(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},x.reject=function(a,b,c){var d=[];return null==a?d:(y(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},x.every=x.all=function(a,b,c){var e=!0;return null==a?e:q&&a.every===q?a.every(b,c):(y(a,function(a,f,g){if(!(e=e&&b.call(c,a,f,g)))return d}),!!e)};var z=x.some=x.any=function(a,b,c){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,c):(y(a,function(a,f,g){if(e||(e=b.call(c,a,f,g)))return d}),!!e)};x.include=x.contains=function(a,b){var c=!1;return null==a?c:s&&a.indexOf===s?a.indexOf(b)!=-1:c=z(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2);return x.map(a,function(a){return(x.isFunction(b)?b||a:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,function(a){return a[b]})},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!b&&x.isEmpty(a))return-(1/0);var d={computed:-(1/0)};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!b&&x.isEmpty(a))return 1/0;var d={computed:1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},x.shuffle=function(a){var b,c=[];return y(a,function(a,d,e){b=Math.floor(Math.random()*(d+1)),c[d]=c[b],c[b]=a}),c},x.sortBy=function(a,b,c){var d=x.isFunction(b)?b:function(a){return a[b]};return x.pluck(x.map(a,function(a,b,e){return{value:a,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return void 0===c?1:void 0===d?-1:c<d?-1:c>d?1:0}),"value")},x.groupBy=function(a,b){var c={},d=x.isFunction(b)?b:function(a){return a[b]};return y(a,function(a,b){var e=d(a,b);(c[e]||(c[e]=[])).push(a)}),c},x.sortedIndex=function(a,b,c){c||(c=x.identity);for(var d=0,e=a.length;d<e;){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},x.toArray=function(a){return a?x.isArray(a)?h.call(a):x.isArguments(a)?h.call(a):a.toArray&&x.isFunction(a.toArray)?a.toArray():x.values(a):[]},x.size=function(a){return x.isArray(a)?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==b||c?a[0]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,function(a){return!!a})},x.flatten=function(a,b){return x.reduce(a,function(a,c){return x.isArray(c)?a.concat(b?c:x.flatten(c)):(a[a.length]=c,a)},[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.uniq=x.unique=function(a,b,c){var d=c?x.map(a,c):a,e=[];return a.length<3&&(b=!0),x.reduce(d,function(c,d,f){return(b?x.last(c)===d&&c.length:x.include(c,d))||(c.push(d),e.push(a[f])),c},[]),e},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=x.intersect=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.indexOf(b,a)>=0})})},x.difference=function(a){var b=x.flatten(h.call(arguments,1),!0);return x.filter(a,function(a){return!x.include(b,a)})},x.zip=function(){for(var a=h.call(arguments),b=x.max(x.pluck(a,"length")),c=new Array(b),d=0;d<b;d++)c[d]=x.pluck(a,""+d);return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d,e;if(c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;if(s&&a.indexOf===s)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1},x.lastIndexOf=function(a,b){if(null==a)return-1;if(t&&a.lastIndexOf===t)return a.lastIndexOf(b);for(var c=a.length;c--;)if(c in a&&a[c]===b)return c;return-1},x.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);e<d;)f[e++]=a,a+=c;return f};var A=function(){};x.bind=function(a,b){var c,d;if(a.bind===w&&w)return w.apply(a,h.call(arguments,1));if(!x.isFunction(a))throw new TypeError;return d=h.call(arguments,2),c=function(){if(!(this instanceof c))return a.apply(b,d.concat(h.call(arguments)));A.prototype=a.prototype;var e=new A,f=a.apply(e,d.concat(h.call(arguments)));return Object(f)===f?f:e}},x.bindAll=function(a){var b=h.call(arguments,1);return 0==b.length&&(b=x.functions(a)),y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b){var c,d,e,f,g,h,i=x.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var j=function(){e=null,g&&a.apply(c,d),i()};return e||(e=setTimeout(j,b)),f?g=!0:h=a.apply(c,d),i(),f=!0,h}},x.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)};c&&!d&&a.apply(e,f),clearTimeout(d),d=setTimeout(g,b)}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments))}},x.wrap=function(a,b){return function(){var c=[a].concat(h.call(arguments,0));return b.apply(this,c)}},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return a<=0?b():function(){if(--a<1)return b.apply(this,arguments)}},x.keys=v||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)x.has(a,c)&&(b[b.length]=c);return b},x.values=function(a){return x.map(a,x.identity)},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={};return y(x.flatten(h.call(arguments,1)),function(c){c in a&&(b[c]=a[c])}),b},x.defaults=function(a){return y(h.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a},x.isEqual=function(b,c){return a(b,c,[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!=a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},x.isArguments=function(a){return"[object Arguments]"==j.call(a)},x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),x.isFunction=function(a){return"[object Function]"==j.call(a)},x.isString=function(a){return"[object String]"==j.call(a)},x.isNumber=function(a){return"[object Number]"==j.call(a)},x.isFinite=function(a){return x.isNumber(a)&&isFinite(a)},x.isNaN=function(a){return a!==a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isDate=function(a){return"[object Date]"==j.call(a)},x.isRegExp=function(a){return"[object RegExp]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return b._=c,this},x.identity=function(a){return a},x.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},x.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},x.result=function(a,b){if(null==a)return null;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){K(b,x[b]=a[b])})};var B=0;x.uniqueId=function(a){var b=B++;return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/.^/,D={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var E in D)D[D[E]]=E;var F=/\\|'|\r|\n|\t|\u2028|\u2029/g,G=/\\(\\|'|r|n|t|u2028|u2029)/g,H=function(a){return a.replace(G,function(a,b){return D[b]})};x.template=function(a,b,c){c=x.defaults(c||{},x.templateSettings);var d="__p+='"+a.replace(F,function(a){return"\\"+D[a]}).replace(c.escape||C,function(a,b){return"'+\n_.escape("+H(b)+")+\n'"}).replace(c.interpolate||C,function(a,b){return"'+\n("+H(b)+")+\n'"}).replace(c.evaluate||C,function(a,b){return"';\n"+H(b)+"\n;__p+='"})+"';\n";c.variable||(d="with(obj||{}){\n"+d+"}\n"),d="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+d+"return __p;\n";var e=new Function(c.variable||"obj","_",d);if(b)return e(b,x);var f=function(a){return e.call(this,a,x)};return f.source="function("+(c.variable||"obj")+"){\n"+d+"}",f},x.chain=function(a){return x(a).chain()};var I=function(a){this._wrapped=a};x.prototype=I.prototype;var J=function(a,b){return b?x(a).chain():a},K=function(a,b){I.prototype[a]=function(){var a=h.call(arguments);return i.call(a,this._wrapped),J(b.apply(x,a),this._chain)}};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=e[a];I.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;return"shift"!=a&&"splice"!=a||0!==d||delete c[0],J(c,this._chain)}}),y(["concat","join","slice"],function(a){var b=e[a];I.prototype[a]=function(){return J(b.apply(this._wrapped,arguments),this._chain)}}),I.prototype.chain=function(){return this._chain=!0,this},I.prototype.value=function(){return this._wrapped}}.call(this),f.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},f.prototype.scale=function(a){return this.x*=a,this.y*=a,this.z*=a,this},f.prototype.direction=function(){return Math.atan2(this.y,this.x)},f.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},f.prototype.addToMagnitude=function(a){a=a||0;var b=this.magnitude(),c=Math.sqrt((a+b)/b);return this.x*=c,this.y*=c,this.z*=c,this},f.prototype.unit=function(){return this.scale(1/this.magnitude())},f.prototype.rotateZ=function(a){var b=this.x,c=this.y;return this.x=b*Math.cos(a)-c*Math.sin(a),this.y=b*Math.sin(a)+c*Math.cos(a),this},f.add=function(a,b){return new f(a.x+b.x,a.y+b.y,a.z+b.z)},f.subtract=function(a,b){return new f(a.x-b.x,a.y-b.y,a.z-b.z)},f.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},f.scale=function(a,b){return new f(a.x*b,a.y*b,a.z*b)},f.cross=function(a,b){return new f(a.y*b.z-b.y*a.z,a.z*b.x-b.z*a.x,a.x*b.y-b.x*a.y)},f.average=function(){var a,b=new f,c=arguments;for(arguments[0].constructor.toString().indexOf("Array")!=-1&&(c=arguments[0]),a=c.length,i=0;i<a;i++)b.add(f.create(c[i]));return b.scale(1/a)},f.create=function(a){return new f(a.x,a.y,a.z)},function(a){function b(a){return a=parseInt(a,10)||0,a=g(a,0,255).toString(16),1===a.length&&(a="0"+a),a}function c(a,b,c){var d;return c<0?c+=1:c>1&&(c-=1),d=6*c<1?a+(b-a)*c*6:2*c<1?b:3*c<2?a+(b-a)*(2/3-c)*6:a,255*d}var d=function(){return d};d.clear=function(a){a=a.canvas?a:a.getContext("2d"),a.clearRect(0,0,a.canvas.width,a.canvas.height)},d.cssColor=function(a){return 3===a.length?"rgb("+k(a[0])+","+k(a[1])+","+k(a[2])+")":"rgba("+k(a[0])+","+k(a[1])+","+k(a[2])+","+a[3]+")"},d.clamp=g=function(a,b,c){return a<b?b:a>c?c:a},d.opposite=function(a){_.isArray(a)||(a=d.parseColorString(a));var b=d.rgb2hsl(a);b[0]=(b[0]+180)%360,b[1]=100-b[1],b[2]=100-b[2];var c=d.hsl2rgb(b);return 4===a.length&&c.push(a[3]),c},d.rgba2rgb=function(a){if(3===a.length||255===a[3])return a;var b=a[0],c=a[1],d=a[2],e=a[3],f=[];return f[0]=e*b+(255-255*e),f[1]=e*c+(255-255*e),f[2]=e*d+(255-255*e),f},d.rgb2hex=function(a){return a=d.rgba2rgb(a),"#"+b(a[0])+b(a[1])+b(a[2])},d.hex2rgb=function(a){return d.parseColorString(a)},d.rgb2hsl=function(a){var b,c,d,e=a[0]/255,f=a[1]/255,g=a[2]/255,h=m(e,f,g),i=l(e,f,g),j=(h+i)/2;if(h===i)c=d=0;else{switch(b=h-i,d=j>.5?b/(2-h-i):b/(h+i),m){case e:c=(f-g)/b+(f<g?6:0);break;case f:c=(g-e)/b+2;break;case g:c=(e-f)/b+4}c/=6}return[c,100*d,100*j]},d.hex2hsl=function(a){return d.rgb2hsl(d.hex2rgb(a))},d.hsl2rgb=function(a){var b,d,e,f,g,h,i=a[0],j=a[1]/100,k=a[2]/100;return 0===j?f=g=h=255*k:(d=k<=.5?k*(j+1):k+j-k*j,b=2*k-d,e=i/360,f=c(b,d,e+1/3),g=c(b,d,e),h=c(b,d,e-1/3)),[f,g,h]},d.parseColorString=function(a){function b(a){var b=document.createElement("a");b.style.color=a,document.body.appendChild(b);var c=getComputedStyle(b).color;return document.body.removeChild(b),c}var c,d,e,f,g,h=!1;a=b(a);for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3]),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3]),parseFloat(a[4])]}}],j=0;j<i.length;j++){var k=i[j].re,l=i[j].process,m=k.exec(a);m&&(c=l(m),d=c[0],e=c[1],f=c[2],g=c[3],h=!0)}return d=d<0||isNaN(d)?0:d>255?255:d,e=e<0||isNaN(e)?0:e>255?255:e,f=f<0||isNaN(f)?0:f>255?255:f,g=g<0||isNaN(g)?0:g>1?1:g,h?[d,e,f,g]:[0,0,0,1]},a.util=d}(TeledrawCanvas),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),function(c){function d(){if(!i){var a;navigator.mimeTypes["application/x-wacomtabletplugin"]?(a=document.createElement("embed"),a.name=a.id="wacom-plugin",a.type="application/x-wacomtabletplugin"):(a=document.createElement("object"),a.classid="CLSID:092dfa86-5807-5a94-bf3b-5a53ba9e5308",a.codebase="fbWacomTabletPlugin.cab"),a.style.width=a.style.height="1px",a.style.top=a.style.left="-10000px",a.style.position="absolute",document.body.appendChild(a),i=a}}function e(){if(i&&i.penAPI){var a=i.penAPI.pressure;return a}}function f(){if(i&&i.penAPI)return 3===parseInt(i.penAPI.pointerType)}function h(a){for(var b=0,c=0;a&&!isNaN(a.offsetLeft)&&!isNaN(a.offsetTop);)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{top:c,left:b}}c.canvases=[];var i,j=0,l={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1e3,strokeSoftness:0},m={last:null,currentTool:null,previousTool:null,tool:null,mouseDown:!1,mouseOver:!1,width:null,height:null,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5e3,enableZoom:!0,enableKeyboardShortcuts:!0,enableWacomSupport:!0,maxHistory:10,minStrokeSize:500,maxStrokeSize:1e4,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8},o=c.Canvas="undefined"!=typeof _Canvas?_Canvas:function(a,b){var c=document.createElement("canvas");return a&&(c.width=a),b&&(c.height=b),c},p=function(a,b){var e=this,f=e.element=a.getContext?a:document.getElementById(a);if(state=e.state=_.extend({},m,b),"function"!=typeof(new o).getContext)throw new Error("Error: Your browser does not support HTML canvas!");state.enableWacomSupport&&d(),f.width=state.width=state.displayWidth||state.width||f.width,f.height=state.height=state.displayHeight||state.height||f.height,state.fullWidth=state.fullWidth||state.width,state.fullHeight=state.fullHeight||state.height,state.width/state.height!==state.fullWidth/state.fullHeight&&(state.fullHeight=state.fullWidth*state.height/state.width),e._displayCanvas=f,state.enableZoom?e._canvas=new o(state.fullWidth,state.fullHeight):e._canvas=f,e.history=new c.History(e),e.defaults(),e.zoom(0),e.history.checkpoint(),c.canvases[j++]=e,e.bindEvents()},q=p.prototype;q.bindEvents=function(){function c(a){var b=r(a);v.tool.enter(v.mouseDown,b),v.last=b,v.mouseOver=!0}function d(a){var b=r(a);v.tool.leave(v.mouseDown,b),v.mouseOver=!1}function g(a){var b=r(a);v.tool.dblclick(b)}function i(a){v.tool.keyup(v.mouseDown,a.keyCode)}function j(a){if(v.tool.keydown(v.mouseDown,a.keyCode),v.enableKeyboardShortcuts){var b=document.activeElement.nodeName.toLowerCase();if("input"!==b&&"textarea"!==b)switch(a.keyCode){case 69:t.setTool("eraser");break;case 70:t.setTool("fill");break;case 71:t.setTool("grab");break;case 73:t.setTool("eyedropper");break;case 76:t.setTool("line");break;case 79:t.setTool((a.shiftKey?"filled-":"")+"ellipse");break;case 80:t.setTool("pencil");break;case 82:t.setTool((a.shiftKey?"filled-":"")+"rectangle");break;case 90:if(v.mouseDown)return!1;if(a.metaKey||a.ctrlKey)return a.shiftKey?t.redo():t.undo(),!1;break;case 189:a.shiftKey&&t.setStrokeSize(v.strokeSize-500);break;case 187:a.shiftKey&&t.setStrokeSize(v.strokeSize+500);break;case 188:a.shiftKey&&t.setAlpha(v.globalAlpha-.1);break;case 190:a.shiftKey&&t.setAlpha(v.globalAlpha+.1);break;case 219:a.shiftKey&&t.setStrokeSoftness(v.strokeSoftness-10);break;case 221:a.shiftKey&&t.setStrokeSoftness(v.strokeSoftness+10)}}}function l(a){if(Date.now()-x<25)return!1;if(x=Date.now(),"touchmove"==a.type&&a.touches.length>1)return!0;if(("touchmove"!=w||"mousemove"!=a.type)&&(a.target==u||v.mouseDown)){var b=r(a);return v.tool.move(v.mouseDown,v.last,b),v.last=b,t.trigger("mousemove",b,a),w=a.type,a.preventDefault(),!1}}function m(b){var c=v.last=r(b);return"touchstart"==b.type&&b.touches.length>1||(a(window,"mousedown"===b.type?"mouseup":"touchend",n),v.mouseDown=!0,v.enableWacomSupport&&f()&&"eraser"!==v.currentTool&&(t.setTool("eraser"),v.wacomWasEraser=!0),v.tool.down(c),t.trigger("mousedown",c,b),document.onselectstart=function(){return!1},b.preventDefault(),!1)}function n(a){return b(window,"mouseup"===a.type?"mouseup":"touchend",n),"touchend"==a.type&&a.touches.length>1||(v.mouseDown=!1,v.tool.up(v.last),t.trigger("mouseup",v.last,a),v.wacomWasEraser===!0&&(t.previousTool(),v.wacomWasEraser=!1),document.onselectstart=function(){return!0},a.preventDefault(),!1)}function o(a){"grab"==v.tool.name&&(s=v.currentZoom)}function p(a){if("grab"==v.tool.name){var b=v.last;t.zoom(s*a.scale,b.xd,b.yd)}return a.preventDefault(),!1}function q(a){}function r(a){var b=h(u),c=a.pageX||a.touches&&a.touches[0].pageX,d=a.pageY||a.touches&&a.touches[0].pageY,f=null;return v.enableWacomSupport&&Date.now()-y>25&&(y=Date.now(),f=e()),{x:k((c-b.left)/v.currentZoom)+v.currentOffset.x||0,y:k((d-b.top)/v.currentZoom)+v.currentOffset.y||0,xd:k(c-b.left)||0,yd:k(d-b.top)||0,p:f}}var s,t=this,u=t.element,v=t.state,w=null,x=0,y=0;a(u,"gesturestart",o),a(u,"gesturechange",p),a(u,"gestureend",q),a(u,"dblclick",g),a(u,"mouseenter",c),a(u,"mousedown",m),a(u,"touchstart",m),a(u,"mouseleave",d),a(window,"mousemove",l),a(window,"touchmove",l),a(window,"keydown",j),a(window,"keyup",i),t.unbindEvents=function(){b(u,"gesturestart",o),b(u,"gesturechange",p),b(u,"gestureend",q),b(u,"dblclick",g),b(u,"mouseenter",c),b(u,"mousedown",m),b(u,"touchstart",m),b(u,"mouseleave",d),b(window,"mousemove",l),b(window,"touchmove",l),b(window,"keydown",j),b(window,"keyup",i)}},q.setRGBAArrayColor=function(a){var b=this.state;4===a.length&&this.setAlpha(a.pop());for(var c=a.length;c<3;++c)a.push(0);var d=b.color;return b.color=a,this.trigger("tool.color",b.color,d),this},q.updateTool=function(){var a=1+k(n(this.state.strokeSize/1e3,2)),b=k(n(this.state.strokeSoftness,1.3)/300*a);this.state.lineWidth=a,this.state.shadowBlur=b},q.updateDisplayCanvas=function(a){if(this.state.enableZoom===!1)return this;var b=this.displayCtx(),d=this.state.currentOffset,e=this.state.currentZoom,f=b.canvas.width,g=b.canvas.height,h=k(f/e),i=k(g/e);c.util.clear(b),a!==!0&&this.trigger("display.update:before"),b.drawImage(this._canvas,d.x,d.y,h,i,0,0,f,g),a!==!0&&this.trigger("display.update:after")},q.canvas=function(){return this._canvas},q.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))},q.displayCanvas=function(){return this._displayCanvas},q.displayCtx=function(){return this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d"))},q.destroy=function(){this.unbindEvents()},q.cursor=function(a){a||(a="default");var b=a.split(/,\s*/);do a=b.shift(),this.element.style.cursor=a;while(a.length&&this.element.style.cursor!=a);return this},q.clear=function(a){var b=this;return c.util.clear(b.ctx()),a!==!0&&b.history.checkpoint(),b.updateDisplayCanvas(),b.trigger("clear"),b},q.defaults=function(){var a=this;return a.setTool(l.tool),a.setAlpha(l.alpha),a.setColor(l.color),a.setStrokeSize(l.strokeSize),a.setStrokeSoftness(l.strokeSoftness),a},q.toDataURL=function(a,b,c,d,e,f){if(arguments.length>=4){a=a||0,b=b||0,e=e||c,f=f||d;var g=this.getTempCanvas(e,f);return g.getContext("2d").drawImage(this.canvas(),a,b,c,d,0,0,e,f),g.toDataURL()}return this.canvas().toDataURL()},q.getTempCanvas=function(a,b){return new o(a||this._canvas.width,b||this._canvas.height)},q.fromDataURL=q.fromImageURL=function(a,b){var c=this,d=new Image;return d.onload=function(){c.clear(!0),c.ctx().drawImage(d,0,0),c.updateDisplayCanvas(),"function"==typeof b&&b.call(c)},d.src=a,c},q.isBlank=function(){for(var a=this.getImageData().data,b=a.length,c=0,d=b;c<d;++c)if(0!==a[c])return!1;return!0},q.fromImage=q.fromVideo=q.fromCanvas=function(a){return this.clear(!0),this.ctx().drawImage(a,0,0),this.updateDisplayCanvas(),this},q.getImageData=function(){var a=this.ctx();return a.getImageData(0,0,a.canvas.width,a.canvas.height)},q.putImageData=function(a){return this.ctx().putImageData(a,0,0),this.updateDisplayCanvas(),this},q.getColor=function(){return this.state.color.slice()},q.setColor=function(a){return _.isArray(a)||(a=c.util.parseColorString(a)),this.setRGBAArrayColor(a),this},q.setAlpha=function(a){var b=this.state.globalAlpha;return this.state.globalAlpha=g(a,0,1),this.trigger("tool.alpha",this.state.globalAlpha,b),this},q.getAlpha=function(){return this.state.globalAlpha},q.setStrokeSize=function(a){var b=this.state.strokeSize;return this.state.strokeSize=g(a,this.state.minStrokeSize,this.state.maxStrokeSize),this.updateTool(),this.trigger("tool.size",this.state.strokeSize,b),this},q.setStrokeSoftness=function(a){var b=this.state.strokeSoftness;return this.state.strokeSoftness=g(a,this.state.minStrokeSoftness,this.state.maxStrokeSoftness),this.updateTool(),this.trigger("tool.softness",this.state.strokeSoftness,b),this},q.setTool=function(a){if(this.state.currentTool===a)return this;if(this.state.previousTool=this.state.currentTool,this.state.currentTool=a,!c.tools[a])throw new Error('Tool "'+a+'" not defined.');return this.state.tool=new c.tools[a](this),this.trigger("tool.change",this.state.currentTool,this.state.previousTool),this},q.previousTool=function(){return this.setTool(this.state.previousTool)},q.undo=function(){return this.history.undo(),this.trigger("history undo",this.history.past.length,this.history.future.length),this},q.redo=function(){return this.history.redo(),this.trigger("history redo",this.history.past.length,this.history.future.length),this},q.resize=function(a,b){if(this.state.enableZoom===!1)return this;
var c=this,d=Math.round(c._canvas.width/c._canvas.height*100)/100,e=Math.round(a/b*100)/100;if(d!==e)throw new Error("Not the same aspect ratio!");return c._displayCanvas.width=c.state.width=a,c._displayCanvas.height=c.state.height=b,this.trigger("resize",a,b),c.zoom(c.state.currentZoom)},q.zoom=function(a,b,c){if(0===arguments.length)return this.state.currentZoom;if(this.state.enableZoom===!1)return this;var d=this,e=0,f=0,h=d.state.currentZoom,i=d._displayCanvas.width,j=d._displayCanvas.height;return b=g(b||i/2,0,i),c=g(c||j/2,0,j),a=g(a||0,i/d._canvas.width,d.state.maxZoom),a!==h&&(a>h?(e=-(i/h-i/a)/2-(b-i/2)/h,f=-(j/h-j/a)/2-(c-j/2)/h):a<h&&(e=(i/a-i/h)/2,f=(j/a-j/h)/2),e*=a,f*=a),d.state.currentZoom=a,d.trigger("zoom",a,h),d.pan(e,f),d.updateDisplayCanvas(),d},q.pan=function(a,b,c){if(0===arguments.length)return this.state.currentOffset;if(this.state.enableZoom===!1)return this;var d=this,e=d.state.currentZoom,f=d.state.currentOffset.x,h=d.state.currentOffset.y,i=d._canvas.width-k(d._displayCanvas.width/e),j=d._canvas.height-k(d._displayCanvas.height/e);return a=c===!0?a/e:f-(a||0)/e,b=c===!0?b/e:h-(b||0)/e,a=k(g(a,0,i)),b=k(g(b,0,j)),d.state.currentOffset={x:a,y:b},d.trigger("pan",d.state.currentOffset,{x:f,y:h}),d.updateDisplayCanvas(),d},_.extend(q,Events),c.api=p}(TeledrawCanvas),function(a){var b=function(a){this.canvas=a,this.rev=0,this.clear()};b.prototype.clear=function(){this.past=[],this.current=null,this.future=[]},b.prototype.checkpoint=function(){this.past.length>this.canvas.state.maxHistory&&this.past.shift().destroy(),this.current&&this.past.push(this.current),this.current=new a.Snapshot(this.canvas),this.future=[],this.rev++},b.prototype.undo=function(){this._move(this.past,this.future)&&this.rev--},b.prototype.redo=function(){this._move(this.future,this.past)&&this.rev++},b.prototype._move=function(a,b){return!!a.length&&(!!this.current&&(b.push(this.current),this.current=a.pop(),this.current.restore(),!0))},a.History=b}(TeledrawCanvas),function(a){var b=function(a){this.canvas=a,this.canvas._snapshotBuffers||(this.canvas._snapshotBuffers=[]),this._snapshotBufferCanvas()};b.prototype.restore=function(a){var b,c;a?(b=a.tl,c=a.br):(b={x:0,y:0},c={x:this.canvas.canvas().width,y:this.canvas.canvas().height}),this._restoreBufferCanvas(b,c),this.canvas.updateDisplayCanvas(!1,b,c)},b.prototype.destroy=function(){this._putBufferCtx()},b.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()},b.prototype._snapshotBufferCanvas=function(){this._getBufferCtx(),this.buffer.drawImage(this.canvas.canvas(),0,0)},b.prototype._restoreBufferCanvas=function(a,b){var c=this.canvas.ctx(),d=b.x-a.x,e=b.y-a.y;0!==d&&0!==e&&(c.clearRect(a.x,a.y,d,e),c.drawImage(this.buffer.canvas,a.x,a.y,d,e,a.x,a.y,d,e))},b.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()},b.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)},b.prototype._putBufferCtx=function(){this.buffer&&this.canvas._snapshotBuffers.push(this.buffer),this.buffer=null},b.prototype._getBufferCtx=function(){var a;this.buffer||(this.canvas._snapshotBuffers.length?(a=this.canvas._snapshotBuffers.pop(),a.clearRect(0,0,a.canvas.width,a.canvas.height)):a=this.canvas.getTempCanvas().getContext("2d")),this.buffer=a},a.Snapshot=b}(TeledrawCanvas),function(a){var b=function(a){this.canvas=a};b.prototype.start=function(a){},b.prototype.move=function(a,b){},b.prototype.end=function(){},b.prototype.draw=function(){},b.prototype.save=function(){this.snapshot=new a.Snapshot(this.canvas)},b.prototype.restore=function(){this.snapshot.restore(this)},b.prototype.destroy=function(){this.snapshot.destroy()},a.Stroke=b}(TeledrawCanvas),function(a){var b=function(){};b.prototype.down=function(a){},b.prototype.up=function(a){},b.prototype.move=function(a,b,c){},b.prototype.dblclick=function(a){},b.prototype.enter=function(a,b){},b.prototype.leave=function(a,b){},b.prototype.keydown=function(a,b){16===b&&(this.shiftKey=!0,a&&(this.updateBoundaries(),this.draw()))},b.prototype.keyup=function(a,b){16===b&&(this.shiftKey=!1,a&&(this.updateBoundaries(),this.draw()))},b.prototype.preview=function(b,c){return new a.Canvas(b||100,c||100)},b.createTool=function(c,d,e){var f=function(a,b){this.canvas=a,this.ctx=b||a.ctx(),this.color=a.getColor(),this.color.push(a.getAlpha()),this.points=[],this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height},this.br={x:0,y:0},this.tool={}};f.prototype=new a.Stroke;var h=function(a){this.canvas=a,a.cursor(d),this.name=c,this.cursor=d||"default",this.currentStroke=null,"function"==typeof e&&e.call(this)};return h.prototype=new b,h.prototype.down=function(a){this.currentStroke=new f(this.canvas),this.currentStroke.tool=this,this.currentStroke.save(),this.currentStroke.points.push(a),this.currentStroke.start(a),this.updateBoundaries(a),this.draw()},h.prototype.move=function(a,b,c){a&&this.currentStroke&&(this.currentStroke.points.push(c),this.currentStroke.move(b,c),this.updateBoundaries(c),this.draw())},h.prototype.up=function(a){this.currentStroke&&(this.currentStroke.end(a),this.draw(),this.currentStroke.destroy(),this.currentStroke=null,this.canvas.history.checkpoint()),this.canvas.trigger("tool.up")},h.prototype.draw=function(){this.currentStroke.ctx.save(),this.currentStroke.restore(),this.currentStroke.draw(),this.canvas.updateDisplayCanvas(!1,this.currentStroke.tl,this.currentStroke.br),this.currentStroke.ctx.restore()},h.prototype.updateBoundaries=function(a){var b=this.currentStroke,c=b.ctx.canvas,d=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;return this.shiftKey?(b.tl.x=b.tl.y=0,b.br.x=c.width,void(b.br.y=c.height)):void(a&&(a.x-d<b.tl.x&&(b.tl.x=g(k(a.x-d),0,c.width)),a.x+d>b.br.x&&(b.br.x=g(k(a.x+d),0,c.width)),a.y-d<b.tl.y&&(b.tl.y=g(k(a.y-d),0,c.height)),a.y+d>b.br.y&&(b.br.y=g(k(a.y+d),0,c.height))))},h.stroke=f,f.tool=h,a.tools[c]=h,h},a.Tool=b,a.tools={}}(TeledrawCanvas),function(a){function b(a,b,c){var d,e,g,h,i;return e=new f(a.x,a.y),d=new f(b.x,b.y),e=f.subtract(d,e).unit(),g=new f(e).rotateZ(Math.PI/2).scale(c).add(d),h=new f(e).rotateZ(-Math.PI/2).scale(c).add(d),i=new f(e).scale(c).add(d),{left:g,right:h,front:i}}var c=a.Tool.createTool("arrow","crosshair"),d=c.stroke.prototype,e=a.Tool.createTool("line-arrow","crosshair"),g=e.stroke.prototype,h=c.prototype.updateBoundaries;c.prototype.updateBoundaries=e.prototype.updateBoundaries=function(){var a=this;if(this.currentStroke.last&&this.currentStroke.current){var c=this.currentStroke.last,d=this.currentStroke.current,e=this.currentStroke.calculateEdgeLength(),f=b(c,d,e);_.values(f).forEach(function(b){h.call(a,b)})}},c.prototype.preview=e.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),d=b.getContext("2d");d.fillStyle="black",d.fillRect(0,0,b.width,b.height);var e=new c.stroke(this.canvas,d);return e.points=[{x:.25*b.width,y:.25*b.height},{x:.75*b.width,y:.75*b.height}],e.draw(),b},d.lineWidth=g.lineWidth=1,d.lineCap=g.lineCap="round",d.calculateEdgeLength=g.calculateEdgeLength=function(){return Math.max(10,2*this.canvas.state.lineWidth)},d.drawArrow=function(){var a,c=(this.canvas.state,this.ctx),d=this.calculateEdgeLength();this.last&&this.current&&(a=b(this.last,this.current,d),c.beginPath(),c.moveTo(this.current.x,this.current.y),c.lineTo(a.left.x,a.left.y),c.lineTo(a.front.x,a.front.y),c.lineTo(a.right.x,a.right.y),c.lineTo(this.current.x,this.current.y),c.closePath(),c.fill())},g.start=function(){a.tools.line.stroke.prototype.start.apply(this,arguments)},d.move=function(a,b){this.last=a,this.current=b},g.move=function(b,c){a.tools.line.stroke.prototype.move.apply(this,arguments),this.last=this.first,this.current=this.second},d.draw=function(){a.tools.pencil.stroke.prototype.draw.call(this),d.drawArrow.call(this)},g.draw=function(){a.tools.line.stroke.prototype.draw.call(this),d.drawArrow.call(this)},d.end=function(a){this.current=a},g.end=function(){a.tools.line.stroke.prototype.end.apply(this,arguments),d.end.apply(this,arguments)}}(TeledrawCanvas),function(a){function b(a,b,c,d,e){var f=.5522848,g=d/2*f,h=e/2*f,i=b+d,j=c+e,k=b+d/2,l=c+e/2;a.beginPath(),a.moveTo(b,l),a.bezierCurveTo(b,l-h,k-g,c,k,c),a.bezierCurveTo(k+g,c,i,l-h,i,l),a.bezierCurveTo(i,l+h,k+g,j,k,j),a.bezierCurveTo(k-g,j,b,l+h,b,l),a.closePath()}var c=a.Tool.createTool("ellipse","crosshair"),d=c.stroke.prototype;c.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),d=b.getContext("2d"),e=new c.stroke(this.canvas,d);return e.first={x:0,y:0},e.second={x:b.width,y:b.height},e.draw(),b},d.bgColor=[255,255,255],d.bgAlpha=0,d.lineWidth=1,d.start=function(a){this.first=a},d.move=function(a,b){this.second=b},d.end=function(a){this.second=a},d.draw=function(){if(this.first&&this.second){var c=this,d=c.first.x,e=c.first.y,f=c.second.x-d,g=c.second.y-e,h=c.ctx,i=c.canvas.state,k=i.shadowOffset,l=i.shadowBlur,m=i.lineWidth,n=a.util.cssColor(i.color);h.lineJoin=h.lineCap="round",h.globalAlpha=i.globalAlpha,h.fillStyle=h.strokeStyle=n,h.miterLimit=1e5,c.tool.shiftKey&&(g=c.second.y>e?j(f):-j(f)),c.tool.fill?(b(h,d,e,f,g),h.fill()):(l>0&&(h.shadowColor=n,h.shadowOffsetX=h.shadowOffsetY=k,h.shadowBlur=l,h.translate(-k,-k)),h.lineWidth=m,b(h,d,e,f,g),h.stroke())}};var e=a.Tool.createTool("filled-ellipse","crosshair");e.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),c=b.getContext("2d"),d=new e.stroke(this.canvas,c);d.tool=this;var f=b.width,g=b.height;return d.first={x:.1*f,y:.1*g},d.second={x:.9*f,y:.9*g},console.log(d),d.draw(),b},_.extend(e.stroke.prototype,c.stroke.prototype),e.prototype.fill=!0}(TeledrawCanvas),function(a){var b=a.Tool.createTool("eraser","crosshair");b.prototype.preview=function(){var c=a.Tool.prototype.preview.apply(this,arguments),d=c.getContext("2d");d.fillStyle="black",d.fillRect(0,0,c.width,c.height);var e=new b.stroke(this.canvas,d);return e.points=[{x:c.width/2,y:c.height/2}],e.draw(),c},b.stroke.prototype.lineWidth=1,b.stroke.prototype.lineCap="round",b.stroke.prototype.draw=function(){this.color=[255,255,255,255],this.ctx.globalCompositeOperation="destination-out",a.tools.pencil.stroke.prototype.draw.call(this)}}(TeledrawCanvas),function(a){var b=function(){this.previewContainer=document.createElement("div"),_.extend(this.previewContainer.style,{position:"absolute",width:"10px",height:"10px",border:"1px solid black",display:"none"}),document.body.appendChild(this.previewContainer),this.canvas.state.mouseOver&&(this.previewContainer.style.display="block")},c=a.Tool.createTool("eyedropper","crosshair",b);c.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),c=b.getContext("2d");return c.fillStyle=a.util.cssColor(this.color||[0,0,0,0]),c.fillRect(0,0,b.width,b.height),b},c.prototype.pick=function(b){var c,d,e=this.previewContainer,f=this.canvas.element.offsetLeft,g=this.canvas.element.offsetTop,h=this.canvas._displayCtx.getImageData(b.xd,b.yd,1,1).data;this.color=a.util.rgba2rgb(Array.prototype.slice.call(h)),d=a.util.rgb2hsl(this.color)[2],_.extend(e.style,{left:f+b.xd+15+"px",top:g+b.yd+5+"px",background:a.util.cssColor(this.color),"border-color":d>=50?"#000":"#888"}),this.canvas.state.mouseOver?(e.style.display="none",c=e.offsetHeight,e.style.display="block"):e.style.display="none"},c.prototype.enter=function(){this.previewContainer.style.display="block"},c.prototype.leave=function(){this.previewContainer.style.display="none"},c.prototype.move=function(a,b,c){this.pick(c)},c.prototype.down=function(a){this.pick(a)},c.prototype.up=function(a){this.pick(a),this.canvas.setColor(this.color),this.previewContainer.parentNode.removeChild(this.previewContainer),this.canvas.previousTool()}}(TeledrawCanvas),function(a){function b(b,e,h,i,j,k){var l,m,n,o,p,q,r=[[h.x,h.y]],s=c(b,h.x,h.y,i),t=(g.tolerance,a.util.opposite(s));for(t[3]/=2;r.length;){for(n=r.pop(),o=n[0],q=p=n[1];q>=0&&f(c(b,o,q,i),s);)q--;for(q++,l=m=!1;q<j&&f(c(b,o,q,i),s);)d(b,o,q,i,t),d(e,o,q,i,k),!l&&o>0&&f(c(b,o-1,q,i),s)?(r.push([o-1,q]),l=!0):l&&o>0&&f(c(b,o-1,q,i),s)&&(l=!1),!m&&o<i-1&&f(c(b,o+1,q,i),s)?(r.push([o+1,q]),m=!0):m&&o<i-1&&f(c(b,o+1,q,i),s)&&(m=!1),q++}}function c(a,b,c,d){var e=4*(c*d+b);return[a[e],a[e+1],a[e+2],a[e+3]]}function d(a,b,c,d,e){var f=4*(c*d+b);a[f]=e[0],a[f+1]=e[1],a[f+2]=e[2],a[f+3]=e[3]}function e(a,b){return j(a[0]-b[0])+j(a[1]-b[1])+j(a[2]-b[2])+j(a[3]-b[3])}function f(a,b){return e(a,b)<5}var g=a.Tool.createTool("fill","crosshair");g.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),c=b.getContext("2d");return c.fillStyle=a.util.cssColor(this.canvas.getColor()),c.fillRect(0,0,b.width,b.height),b},g.blur=!0,g.stroke.prototype.end=function(a){var c=this.ctx.canvas.width,d=this.ctx.canvas.height,e=this.ctx.getImageData(0,0,c,d),f=this.ctx.createImageData(c,d),h=this.color;h[3]*=255,b(e.data,f.data,a,c,d,this.color),this.tmp_canvas=this.canvas.getTempCanvas();var i=this.tmp_canvas.getContext("2d");if(i.putImageData(f,0,0),g.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);for(var j=i.getImageData(0,0,c,d),k=0,l=j.data.length;k<l;k+=4)j.data[k+3]/255>.2&&(j.data[k]=h[0],j.data[k+1]=h[1],j.data[k+2]=h[2],j.data[k+3]=Math.min(h[3],3*j.data[k+3]));i.putImageData(j,0,0)}},g.stroke.prototype.draw=function(){this.tmp_canvas&&this.ctx.drawImage(this.tmp_canvas,0,0)}}(TeledrawCanvas),function(a){var b="hand, grab, -moz-grab, -webkit-grab, move",c="grabbing, -moz-grabbing, -webkit-grabbing, move",d=a.Tool.createTool("grab",b);d.prototype.move=function(a,b,c){var d=this;a&&(clearTimeout(this._clearDeltasId),cancelAnimationFrame(this._momentumId),this.dx=c.xd-b.xd,this.dy=c.yd-b.yd,this.canvas.pan(this.dx,this.dy),this._clearDeltasId=setTimeout(function(){d.dx=d.dy=0},100))},d.prototype.down=function(a){cancelAnimationFrame(this._momentumId),this.canvas.cursor(c)},d.prototype.up=function(a){cancelAnimationFrame(this._momentumId),this.momentum(this.dx,this.dy),this.dx=this.dy=0,this.canvas.cursor(b)},d.prototype.dblclick=function(a){cancelAnimationFrame(this._momentumId),this.dx=this.dy=0;var b=2;this.shiftKey&&(b/=4),this.canvas.zoom(this.canvas.state.currentZoom*b,a.xd,a.yd)},d.prototype.momentum=function(a,b){var c=this;(Math.abs(a)>=1||Math.abs(b)>=1)&&(a/=1.1,b/=1.1,this.canvas.pan(a,b),this._momentumId=requestAnimationFrame(function(){c.momentum(a,b)}))}}(TeledrawCanvas),function(a){var b=a.Tool.createTool("line","crosshair");b.prototype.preview=function(){var c=a.Tool.prototype.preview.apply(this,arguments),d=c.getContext("2d"),e=new b.stroke(this.canvas,d);return e.first={x:0,y:0},e.second={x:c.width,y:c.height},e.draw(),c},b.stroke.prototype.lineCap="round",b.stroke.prototype.start=function(a){this.first=a},b.stroke.prototype.move=function(a,b){this.second=b},b.stroke.prototype.end=function(a){this.second=a},b.stroke.prototype.drawLine=function(){if(this.first&&this.second){var a,b,c,d=_.extend({},this.first),e=_.extend({},this.second),f=Math.PI;delete d.p,delete e.p,this.tool.shiftKey&&(b=e.x-d.x,c=e.y-d.y,a=Math.atan2(c,b),a>=7*-f/8&&a<5*-f/8||a>=3*-f/8&&a<-f/8?e.y=d.y-Math.abs(b):a>=5*-f/8&&a<3*-f/8||a>=3*f/8&&a<5*f/8?e.x=d.x:a>=f/8&&a<3*f/8||a>=5*f/8&&a<7*f/8?e.y=d.y+Math.abs(b):e.y=d.y),this.points=[d,e]}},b.stroke.prototype.draw=function(){b.stroke.prototype.drawLine.call(this),a.tools.pencil.stroke.prototype.draw.call(this)}}(TeledrawCanvas),function(a){function b(a,b){for(var c,d,e,g,h,i={left:[],right:[]},j=a.length,k=a[0],l=new f(k.x,k.y),m=1,n=j;m<n;++m)c=a[m],c.x===k.x&&c.y===k.y||(d=new f(c.x,c.y),e=f.subtract(d,l).unit().rotateZ(Math.PI/2),g=f.subtract(d,l).unit().rotateZ(-Math.PI/2),h=f(e).scale(k.p*b).add(l),i.left.push({x:h.x,y:h.y}),h=f(g).scale(k.p*b).add(l),i.right.unshift({x:h.x,y:h.y}),k=c,l=d);return h=f(e).scale(k.p*b).add(l),i.left.push({x:h.x,y:h.y}),h=f(g).scale(k.p*b).add(l),i.right.unshift({x:h.x,y:h.y}),result=i.left.concat(i.right),result.push(i.left[0]),result}function c(a,b,c){if(0!==b.length){a.moveTo(b[0].x,b[0].y);for(var d=b[0],e=null,f=d,g=b.length,h=1,i=g;h<i;++h){if(f=b[h],!e||e.x!=f.x&&e.y!=f.y||(f.x+=.1,f.y+=.1),c){var j={x:(d.x+f.x)/2,y:(d.y+f.y)/2};a.quadraticCurveTo(d.x,d.y,j.x,j.y)}else a.lineTo(f.x,f.y);e=d,d=b[h]}c&&a.quadraticCurveTo(d.x,d.y,f.x,f.y)}}var d=a.Tool.createTool("pencil","crosshair");d.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),c=b.getContext("2d"),e=new d.stroke(this.canvas,c);return e.points=[{x:b.width/2,y:b.height/2}],e.draw(),b},d.stroke.prototype.lineCap="round",d.stroke.prototype.smoothing=!0,d.stroke.prototype.draw=function(){var d=this.canvas.state,e=this.ctx,f=this.points,g=d.shadowOffset,h=d.shadowBlur,i=d.lineWidth,j=a.util.cssColor(d.color);if(e.globalAlpha=d.globalAlpha,e.fillStyle=e.strokeStyle=j,e.miterLimit=1e5,h>0&&(e.shadowColor=j,e.shadowOffsetX=e.shadowOffsetY=g,e.shadowBlur=h,e.translate(-g,-g)),1===f.length)switch(this.lineCap){case"round":e.beginPath(),f[0].p&&(i*=2*f[0].p),e.arc(f[0].x,f[0].y,i/2,0,2*Math.PI,!0),e.closePath(),e.fill();break;case"square":e.fillRect(f[0].x-i/2,f[0].y-i/2,i,i)}else f.length>1&&(e.lineJoin="round",e.lineCap=this.lineCap,e.lineWidth=i,f[0].p||f[1].p?(e.beginPath(),c(e,b(f,i),this.smoothing),e.closePath(),e.fill()):(e.beginPath(),c(e,f,this.smoothing),e.stroke()))}}(TeledrawCanvas),function(a){function b(a,b,c){a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,b.y),a.lineTo(c.x,c.y),a.lineTo(b.x,c.y),a.lineTo(b.x,b.y)}var c=a.Tool.createTool("rectangle","crosshair");c.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),d=b.getContext("2d"),e=new c.stroke(this.canvas,d);return e.first={x:0,y:0},e.second={x:b.width,y:b.height},e.draw(),b},c.stroke.prototype.bgColor=[255,255,255],c.stroke.prototype.bgAlpha=0,c.stroke.prototype.lineWidth=1,c.stroke.prototype.start=function(a){this.first=a},c.stroke.prototype.move=function(a,b){this.second=b},c.stroke.prototype.draw=function(){if(this.first&&this.second){var c=this.first,d=_.extend({},this.second),e=this.ctx,f=this.canvas.state,g=f.shadowOffset,h=f.shadowBlur,i=f.lineWidth,j=a.util.cssColor(f.color);if(e.lineJoin=e.lineCap="round",e.globalAlpha=f.globalAlpha,e.fillStyle=e.strokeStyle=j,e.miterLimit=1e5,this.tool.shiftKey){var k=Math.abs(d.x-c.x);d.y=c.y+(d.y>c.y?k:-k)}this.tool.fill?(b(e,c,d),e.fill()):(h>0&&(e.shadowColor=j,e.shadowOffsetX=e.shadowOffsetY=g,e.shadowBlur=h,e.translate(-g,-g)),e.lineWidth=i,b(e,c,d),e.stroke())}};var d=a.Tool.createTool("filled-rectangle","crosshair");d.prototype.preview=function(){var b=a.Tool.prototype.preview.apply(this,arguments),c=b.getContext("2d"),e=new d.stroke(this.canvas,c);e.tool=this;var f=b.width,g=b.height;return e.first={x:.1*f,y:.1*g},e.second={x:.9*f,y:.9*g},e.draw(),b},_.extend(d.stroke.prototype,c.stroke.prototype),d.prototype.fill=!0}(TeledrawCanvas),function(c){function d(b){var c=document.createElement("input");c.style.opacity=0,document.body.appendChild(c),c.focus(),b.input=c,b.inputHandler=function(){b.text=c.value,b.tool.draw()},b.keydownHandler=function(a){13===a.keyCode&&f(b)},a(c,"input",b.inputHandler),a(c,"keydown",b.keydownHandler)}function e(a){a.input&&(b(a.input,"input",a.inputHandler),b(a.input,"input",a.keydownHandler),a.input.parentNode.removeChild(a.input))}function f(a){var b=a.tool;e(a),a.finished=!0,b.draw(),a.destroy(),b.currentStroke=null,b.canvas.history.checkpoint()}var g=c.Tool.createTool("text","text"),h=g.stroke.prototype,i=.05,j=g.prototype.down;g.prototype.down=function(a){this.currentStroke&&f(this.currentStroke),j.call(this,a)},g.prototype.up=function(a){this.currentStroke&&(this.currentStroke.end(a),this.currentStroke.draw(),d(this.currentStroke)),this.canvas.trigger("tool.up")},g.prototype.preview=function(){var a=c.Tool.prototype.preview.apply(this,arguments),b=a.getContext("2d"),d=new g.stroke(this.canvas,b);return d.first={x:0,y:0},d.second={x:a.width,y:a.height},d.text="Aa",d.draw(),a},h.start=function(a){this.text="",this.first=a},h.move=function(a,b){this.second=b},h.end=function(a){this.second=a},h.draw=function(){if(this.first&&this.second){var a,b=this.first.x,d=this.first.y,e=this.second.x-b,f=this.second.y-d,g=this.ctx,h=this.canvas.state,j=c.util.cssColor(h.color);e<0&&(e=-e,b-=e),f<0&&(f=-f,d-=f),a=f*i,this.finished||(g.save(),g.lineWidth=1,g.strokeStyle="black",g.strokeRect(b,d,e,f),g.restore()),b+=a,e-=2*a,d+=a,f-=2*a,g.globalAlpha=h.globalAlpha,g.fillStyle=g.strokeStyle=j,g.textAlign="center",g.textBaseline="middle",g.font=f+"px "+(h.font?h.font:"Arial"),g.fillText(this.text,b+e/2,d+f/2,e)}}}(TeledrawCanvas)}();